<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êó∂Èó¥ÊçïÊâã TimeCatcher V9.4</title>
    
    <!-- Ê†∏ÂøÉËµÑÊ∫ê -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Silkscreen:wght@400;700&display=swap');
        
        :root {
            --p-red: #FF3B30;
            --p-blue: #6D83F2;
            --p-yellow: #FFD60A;
            --p-bg: #E0F2F1;
        }

        body {
            font-family: 'DotGothic16', 'Silkscreen', monospace;
            background-color: var(--p-bg);
            margin: 0;
            position: fixed;
            inset: 0;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .pixel-border { border: 4px solid black; }
        .pixel-shadow { box-shadow: 6px 6px 0px 0px rgba(0,0,0,1); }
        
        .pixel-btn-flat:active {
            transform: translate(2px, 2px);
            background-color: #f8fafc;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .banner-active { animation: pulse-bg 2.5s infinite; }
        @keyframes pulse-bg {
            0%, 100% { background-color: white; }
            50% { background-color: #fffde7; }
        }

        .icon-svg { fill: currentColor; width: 28px; height: 28px; }
        .icon-sm { width: 18px; height: 18px; }
        
        #root { height: 100%; width: 100%; }

        .mic-active {
            animation: mic-pulse 1s infinite;
            background-color: var(--p-red) !important;
            color: white !important;
        }
        @keyframes mic-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); opacity: 0.7; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PIXEL_ICONS = {
            stop: <svg className="icon-svg text-red-600" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>,
            gear: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm6 2l1.4 1.4-2.8 2.8-1.4-1.4L17 4zM7 4L5.6 5.4l2.8 2.8 1.4-1.4L7 4zm13 7v2h-4v-2h4zM8 11v2H4v-2h4zm9 8l-1.4 1.4-2.8-2.8 1.4-1.4 2.8 2.8zM7 19l1.4-1.4 2.8 2.8-1.4 1.4L7 19zm4 1h2v4h-2v-4zm1-11a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>,
            back: <svg className="icon-sm" viewBox="0 0 24 24"><path d="M10 4v2H8v2H6v2H4v4h2v2h2v2h2v2h2v-4h-2v-2h-2v-4h2V8h2V4h-2zM12 10h8v4h-8v-4z"/></svg>,
            plus: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z"/></svg>,
            folder: <svg className="icon-sm opacity-50 flex-shrink-0" viewBox="0 0 24 24"><path d="M2 4h8l2 2h10v14H2V4zm2 4v10h16V8H4z"/></svg>,
            trash: <svg className="icon-sm text-white" viewBox="0 0 24 24"><path d="M9 2h6v2H9V2zM5 4h14v2H5V4zm2 2h10v14H7V6zm2 2v10h2V8H9zm4 0v10h2V8h-2z"/></svg>,
            edit: <svg className="icon-sm text-black" viewBox="0 0 24 24"><path d="M14 2h2v2h-2V2zM12 4h2v2h-2V4zm-2 2h2v2h-2V6zm-2 2h2v2H8V8zm-2 2h2v2H6v-2zm-2 2h2v2H4v-2zm0 2h2v2H4v-2zm0 2h2v2H4v-2zm2 2h2v2H6v-2zm2 2h2v2H8v-2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2z"/></svg>,
            up: <svg className="icon-sm" viewBox="0 0 24 24"><path d="M11 6h2v2h-2V6zm-2 2h2v2H9V8zm6 0h2v2h-2V8zm-8 2h2v2H7v-2zm10 0h2v2h-2v-2zm-12 2h2v6h-2v-6zm14 0h2v6h-2v-6z"/></svg>,
            down: <svg className="icon-sm" viewBox="0 0 24 24"><path d="M8 6h8v2H8V6zm-1 2h2v6H7V8zm10 0h2v6h-2V8zm-8 6h2v2H9v-2zm6 0h2v2h-2v-2zm-4 2h2v2h-2v-2z"/></svg>,
            mic: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2H3v2a9 9 0 0 0 8 8.94V22h2v-3.06A9 9 0 0 0 21 12v-2h-2z"/></svg>
        };

        const COMMON_EMOJIS = ["‚öîÔ∏è", "üíª", "üìñ", "üìù", "üß†", "üî•", "üöÄ", "üí°", "üõ†Ô∏è", "üéØ", "üí™", "üßò", "üèÉ", "üö∂", "üö¥", "üèä", "üèÄ", "‚öΩ", "ü•ä", "üîã", "üßπ", "üç≥", "‚òï", "üöø", "üß∫", "üè†", "ü™¥", "üõå", "üåô", "üß¥", "üì±", "üéÆ", "üéß", "üé¨", "üé®", "üì∏", "üé∏", "üé§", "üçø", "üß©", "üçé", "ü•ó", "üçï", "üçî", "üç¶", "üç∫", "üç∑", "ü•Ç", "üçµ", "üç±", "üåç", "üåä", "üå≤", "üå∏", "‚òÄÔ∏è", "üöó", "‚úàÔ∏è", "üó∫Ô∏è", "üêï", "üêà"];

        const App = () => {
            const [activities, setActivities] = useState(() => JSON.parse(localStorage.getItem('tc_v9_4_acts') || '[]'));
            useEffect(() => {
                if (activities.length === 0) {
                    setActivities([
                        { id: '1', name: 'Ê∑±Â∫¶Â∑•‰Ωú', emoji: '‚öîÔ∏è', parentId: null },
                        { id: '2', name: 'ÂÜô‰ª£Á†Å', emoji: 'üíª', parentId: '1' },
                        { id: '3', name: 'ÂºÄ‰ºö', emoji: 'üë•', parentId: '1' },
                        { id: '4', name: 'ÊäÄËÉΩÂ≠¶‰π†', emoji: 'üìñ', parentId: null },
                        { id: '5', name: '‰ΩìÂäõÈîªÁÇº', emoji: 'üí™', parentId: null },
                        { id: '6', name: 'ÂøÉÁÅµÂÜ•ÊÉ≥', emoji: 'üßò', parentId: null }
                    ]);
                }
            }, []);

            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('tc_v9_4_logs') || '[]'));
            const [currentParentId, setCurrentParentId] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [msg, setMsg] = useState({ show: false, text: '', type: 'info' });

            const showMsg = (text, type = 'info') => {
                setMsg({ show: true, text, type });
                setTimeout(() => setMsg(prev => ({ ...prev, show: false })), 4000);
            };

            useEffect(() => {
                localStorage.setItem('tc_v9_4_acts', JSON.stringify(activities));
                localStorage.setItem('tc_v9_4_logs', JSON.stringify(logs));
            }, [activities, logs]);

            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);
            const currentEmoji = useMemo(() => activities.find(a => a.name === currentLog?.activityName)?.emoji || 'üßä', [currentLog, activities]);

            const triggerVibrate = (ms = 50) => {
                if (window.navigator?.vibrate) window.navigator.vibrate(ms);
            };

            const stopCurrent = () => {
                if (!currentLog) return;
                triggerVibrate();
                setLogs(prev => prev.map(l => l.endTime === null ? { ...l, endTime: Date.now() } : l));
            };

            const handleActivityClick = (act) => {
                if (isEditMode) return;
                const children = activities.filter(a => a.parentId === act.id);
                if (children.length > 0) { 
                    setCurrentParentId(act.id);
                    triggerVibrate(30);
                } 
                else {
                    const now = Date.now();
                    triggerVibrate(40);
                    setLogs(prev => [...prev.map(l => l.endTime === null ? { ...l, endTime: now } : l), { 
                        id: Math.random().toString(36).substr(2, 9), 
                        activityName: act.name, 
                        activityEmoji: act.emoji, 
                        parentId: act.parentId,
                        startTime: now, 
                        endTime: null 
                    }]);
                }
            };

            // --- Ê†∏ÂøÉÂçáÁ∫ßÔºöËØ≠Èü≥Êåá‰ª§Êô∫ËÉΩËØÜÂà´ÂºïÊìé ---
            const startVoiceCommand = async () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return showMsg("Ê≠§ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂäüËÉΩ", "error");

                showMsg("Ê≠£Âú®ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£é...", "info");
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (e) {
                    return showMsg("È∫¶ÂÖãÈ£éÊùÉÈôêË¢´Êãí", "error");
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;

                recognition.onstart = () => {
                    setIsListening(true);
                    triggerVibrate(20);
                    showMsg("Ê≠£Âú®ÂÄæÂê¨ÊÇ®ÁöÑÊÑèÂõæ...", "info");
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    
                    // 1. Êï¥ÁêÜÂÄôÈÄâÊ¥ªÂä®ÔºàÊåâÂ≠óÊï∞ÂÄíÂ∫èÊéíÔºåÈò≤Ê≠¢ÈîôÊäìÁü≠ËØçÔºâ
                    const candidates = [...activities].sort((a,b) => b.name.length - a.name.length);
                    
                    // 2. Âú®ÂÖ®Â∫ì‰∏≠ÂØªÊâæÂåπÈÖçÔºàÂê´‰∫åÁ∫ßÊ¥ªÂä®Ôºâ
                    const match = candidates.find(act => transcript.includes(act.name));

                    if (match) {
                        // ÂØªÊâæÁà∂Á∫ßÂêçÁß∞Áî®‰∫éÊèêÁ§∫
                        const parent = match.parentId ? activities.find(a => a.id === match.parentId) : null;
                        const fullName = parent ? `${parent.name}-${match.name}` : match.name;
                        
                        // ÊâßË°åËÆ∞ÂΩïÊìç‰Ωú
                        handleActivityClick(match);
                        showMsg(`Êô∫ËÉΩËØÜÂà´: [${fullName}]`, "info");
                        setIsListening(false);
                    } else {
                        showMsg(`Êú™ÂåπÈÖç: "${transcript}"`, "error");
                        setIsListening(false);
                    }
                };

                recognition.onerror = (e) => {
                    setIsListening(false);
                    showMsg(`ÂºÇÂ∏∏: ${e.error}`, "error");
                };

                recognition.onend = () => setIsListening(false);
                recognition.start();
            };

            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});

            return (
                <div className="flex flex-col h-full w-full p-6 text-[#2D3436] justify-between">
                    
                    {/* --- Á≥ªÁªüÊåá‰ª§ÁúãÊùø --- */}
                    {msg.show && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] w-[85%] pointer-events-none transition-all duration-300">
                            <div className="pixel-border p-4 shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] bg-[#FFD60A] text-black border-black text-center font-black uppercase text-xs">
                                <div className="mb-1 text-[10px] opacity-40 italic">Intent Recognition System</div>
                                {msg.text}
                            </div>
                        </div>
                    )}

                    {/* --- È°∂ÈÉ®Âõ∫ÂÆöÔºöBanner --- */}
                    <div className="flex-shrink-0">
                        <div className={`pixel-border pixel-shadow p-5 transition-all duration-500 relative ${currentLog ? 'banner-active bg-white' : 'bg-gray-100 opacity-90'}`}>
                            <div className="flex items-center justify-between gap-3 text-left">
                                <div className="flex items-center gap-4 flex-1 min-w-0">
                                    <span className="text-5xl leading-none flex-shrink-0 select-none">{currentEmoji}</span>
                                    <div className="flex items-baseline gap-2 overflow-hidden">
                                        <h1 className="text-3xl font-black truncate leading-none tracking-tighter uppercase">
                                            {currentLog ? currentLog.activityName : 'STANDBY'}
                                        </h1>
                                        {currentLog && (
                                            <div className="bg-blue-100 border-2 border-blue-500 px-2 py-0.5">
                                                <span className="text-lg font-bold text-blue-700 leading-none">
                                                    {formatTime(currentLog.startTime)}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={startVoiceCommand} className={`w-12 h-12 pixel-border pixel-btn-flat bg-white flex items-center justify-center transition-all ${isListening ? 'mic-active' : ''}`}>
                                        {PIXEL_ICONS.mic}
                                    </button>
                                    <button onClick={() => { setIsEditMode(!isEditMode); setCurrentParentId(null); }} className={`w-12 h-12 pixel-border pixel-btn-flat bg-white flex items-center justify-center ${isEditMode ? 'bg-[#FFD60A]' : ''}`}>
                                        {PIXEL_ICONS.gear}
                                    </button>
                                    <button onClick={stopCurrent} className={`w-12 h-12 pixel-border pixel-btn-flat flex items-center justify-center transition-all ${currentLog ? 'bg-white' : 'bg-gray-200 opacity-20'}`}>
                                        {PIXEL_ICONS.stop}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* --- ‰∏≠Èó¥ÔºöÊ¥ªÂä®ÂàóË°® (‰∏•Ê†ºÈîÅÂÆö h-20) --- */}
                    <div className="flex-1 flex flex-col justify-center min-h-0 py-4 overflow-hidden">
                        <div className="overflow-y-auto no-scrollbar max-h-full">
                            <div className={`transition-all duration-300 ${isEditMode ? 'pt-12' : 'pt-2'}`}>
                                {currentParentId && (
                                    <button onClick={() => setCurrentParentId(null)} className="mb-6 px-1 text-xs font-black flex items-center gap-2 underline underline-offset-4 decoration-4 uppercase">
                                        {PIXEL_ICONS.back} Back to menu
                                    </button>
                                )}
                                <div className="grid grid-cols-2 gap-x-6 gap-y-10 px-1 pb-6 text-left">
                                    {activities.filter(a => a.parentId === currentParentId).map((act, idx) => {
                                        const hasChildren = activities.some(child => child.parentId === act.id);
                                        return (
                                            <div key={act.id} className="relative">
                                                <button onClick={() => handleActivityClick(act)} className="w-full bg-white pixel-border p-3 pixel-btn-flat flex items-center gap-3 h-20 text-left relative overflow-hidden">
                                                    <span className="text-4xl leading-none flex-shrink-0 select-none">{act.emoji}</span>
                                                    <p className="font-black text-lg uppercase leading-none truncate flex-1">{act.name}</p>
                                                    {!isEditMode && hasChildren && PIXEL_ICONS.folder}
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* --- Â∫ïÈÉ®ÂØºËà™ --- */}
                    <div className="flex-shrink-0 grid grid-cols-2 gap-5 pb-2">
                        <button onClick={() => setShowSummary(true)} className="bg-black text-white pixel-border p-5 font-bold text-lg flex items-center justify-center gap-2 active:bg-gray-800 uppercase italic tracking-tighter shadow-sm">
                            SUMMARY
                        </button>
                        <button onClick={() => showMsg("Êï∞ÊçÆÂØºÂá∫ÂáÜÂ§áÂÆåÊØï", "info")} className="bg-white pixel-border p-5 font-bold text-lg active:bg-gray-100 uppercase italic tracking-tighter shadow-sm">
                            EXPORT
                        </button>
                    </div>

                    {/* --- ÊÄªÁªìÈ°µÈù¢ --- */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-[#E0F2F1] pixel-border p-6 w-full max-w-sm flex flex-col overflow-hidden max-h-[85vh]">
                                <div className="flex justify-between items-center mb-5 border-b-4 border-black flex-shrink-0 text-left">
                                    <div className="pb-1">
                                        <h2 className="text-3xl font-black italic uppercase tracking-tighter leading-none">Mission Clear</h2>
                                        <p className="text-[10px] font-bold opacity-40 mt-1">Date: {new Date().toLocaleDateString()}</p>
                                    </div>
                                    <button onClick={() => setShowSummary(false)} className="text-xl font-bold border-4 border-black px-4 py-1 bg-white mb-2 shadow-sm shadow-black">X</button>
                                </div>
                                <div className="flex-1 space-y-1 overflow-y-auto no-scrollbar pr-1 pb-4">
                                    {logs.filter(l => l.endTime).sort((a,b) => a.startTime - b.startTime).map((l, i) => {
                                        const activityObj = activities.find(a => a.name === l.activityName);
                                        const parentObj = activityObj?.parentId ? activities.find(a => a.id === activityObj.parentId) : null;
                                        const displayName = parentObj ? `${parentObj.name}-${l.activityName}` : l.activityName;
                                        return (
                                            <div key={i} className="bg-white border-b-2 border-black/10 p-2 flex justify-between items-center text-left">
                                                <div className="flex items-center gap-1.5 min-w-0">
                                                    <span className="text-lg flex-shrink-0">{l.activityEmoji || 'üìç'}</span>
                                                    <div className="flex items-baseline gap-1.5 truncate">
                                                        <span className="font-black text-[13px] uppercase truncate leading-none">{displayName}</span>
                                                        <span className="text-[9px] font-bold text-blue-600 opacity-60 flex-shrink-0">[{formatTime(l.startTime)}-{formatTime(l.endTime)}]</span>
                                                    </div>
                                                </div>
                                                <div className="font-black text-xs flex-shrink-0 ml-2">{Math.round((l.endTime-l.startTime)/60000)}M</div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="mt-2 pt-4 border-t-4 border-black flex justify-between items-end flex-shrink-0 text-left">
                                    <div>
                                        <p className="text-[10px] font-bold opacity-40 uppercase mb-1">Energy Gained</p>
                                        <p className="text-5xl font-black leading-none">
                                            {Math.round(logs.reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0
                                        </p>
                                    </div>
                                    <button onClick={() => showMsg("ÂêåÊ≠•ÊàêÂäü")} className="bg-[#6D83F2] text-white border-2 border-black px-4 py-2 font-black uppercase text-[10px] italic shadow-black shadow-sm">Sync Cal</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
