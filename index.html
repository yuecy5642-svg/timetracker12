<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êó∂Èó¥ÊçïÊâã TimeCatcher V10.14</title>
    
    <!-- Ê†∏ÂøÉËµÑÊ∫ê -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Silkscreen:wght@400;700&display=swap');
        
        :root {
            --p-red: #FF3B30;
            --p-blue: #6D83F2;
            --p-yellow: #FFD60A;
            --p-bg: #E0F2F1;
        }

        body {
            font-family: 'DotGothic16', 'Silkscreen', 'Courier New', Courier, monospace;
            background-color: var(--p-bg);
            margin: 0;
            position: fixed;
            inset: 0;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .pixel-border { border: 3px solid black; }
        .pixel-shadow { box-shadow: 5px 5px 0px 0px rgba(0,0,0,1); }
        
        .pixel-btn-flat:active {
            transform: translate(2px, 2px);
            background-color: #f8fafc;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .banner-active { animation: pulse-bg 2.5s infinite; }
        @keyframes pulse-bg {
            0%, 100% { background-color: white; }
            50% { background-color: #fffde7; }
        }

        .icon-svg { fill: currentColor; width: 20px; height: 20px; }
        
        #root { height: 100%; width: 100%; }

        .mic-active {
            animation: mic-pulse 0.8s infinite;
            background-color: var(--p-red) !important;
            color: white !important;
        }
        @keyframes mic-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.92); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Êà™Âõæ‰∏ìÁî® */
        .hide-in-capture { display: flex; }
        .is-capturing .hide-in-capture { display: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PIXEL_ICONS = {
            stop: <svg className="icon-svg text-red-600" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>,
            gear: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm6 2l1.4 1.4-2.8 2.8-1.4-1.4L17 4zM7 4L5.6 5.4l2.8 2.8 1.4-1.4L7 4zm13 7v2h-4v-2h4zM8 11v2H4v-2h4zm9 8l-1.4 1.4-2.8-2.8 1.4-1.4 2.8 2.8zM7 19l1.4-1.4 2.8 2.8-1.4 1.4L7 19zm4 1h2v4h-2v-4zm1-11a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>,
            back: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M10 4v2H8v2H6v2H4v4h2v2h2v2h2v2h2v-4h-2v-2h-2v-4h2V8h2V4h-2zM12 10h8v4h-8v-4z"/></svg>,
            plus: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z"/></svg>,
            folder: <svg className="w-3 h-3 opacity-40" viewBox="0 0 24 24"><path d="M2 4h8l2 2h10v14H2V4zm2 4v10h16V8H4z"/></svg>,
            trash: <svg className="w-4 h-4 text-white" viewBox="0 0 24 24"><path d="M9 2h6v2H9V2zM5 4h14v2H5V4zm2 2h10v14H7V6zm2 2v10h2V8H9zm4 0v10h2V8h-2z"/></svg>,
            edit: <svg className="w-4 h-4 text-black" viewBox="0 0 24 24"><path d="M14 2h2v2h-2V2zM12 4h2v2h-2V4zm-2 2h2v2h-2V6zm-2 2h2v2H8V8zm-2 2h2v2H6v-2zm-2 2h2v2H4v-2zm0 2h2v2H4v-2zm0 2h2v2H4v-2zm2 2h2v2H6v-2zm2 2h2v2H8v-2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2z"/></svg>,
            up: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M11 6h2v2h-2V6zm-2 2h2v2H9V8zm6 0h2v2h-2V8zm-8 2h2v2H7v-2zm10 0h2v2h-2v-2zm-12 2h2v6h-2v-6zm14 0h2v6h-2v-6zm14 0h2v6h-2v-6z"/></svg>,
            down: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M8 6h8v2H8V6zm-1 2h2v6H7V8zm10 0h2v6h-2V8zm-8 6h2v2H9v-2zm6 0h2v2h-2v-2zm-4 2h2v2h-2v-2z"/></svg>,
            save: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>,
            cal: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>,
            clear: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>,
            csv: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>,
            mic: <svg className="icon-svg text-black" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        };

        const COMMON_EMOJIS = ["‚öîÔ∏è", "üíª", "üìñ", "üìù", "üß†", "üî•", "üöÄ", "üí°", "üõ†Ô∏è", "üéØ", "üí™", "üßò", "üèÉ", "üö∂", "üö¥", "üèä", "üèÄ", "‚öΩ", "ü•ä", "üîã", "üßπ", "üç≥", "‚òï", "üöø", "üß∫", "üè†", "ü™¥", "üõå", "üåô", "üß¥", "üì±", "üéÆ", "üéß", "üé¨", "üé®", "üì∏", "üé∏", "üé§", "üçø", "üçé", "ü•ó", "üçï", "üçî", "üç¶", "üç∫", "üç∑", "ü•Ç", "üçµ", "üç±", "üåç", "üåä", "üå≤", "üå∏", "‚òÄÔ∏è", "üöó", "‚úàÔ∏è", "üó∫Ô∏è", "üêï", "üêà"];

        const App = () => {
            const [activities, setActivities] = useState(() => JSON.parse(localStorage.getItem('tc_v10_14_acts') || '[]'));
            useEffect(() => {
                if (activities.length === 0) {
                    setActivities([
                        { id: '1', name: 'Ê∑±Â∫¶Â∑•‰Ωú', emoji: '‚öîÔ∏è', parentId: null },
                        { id: '2', name: 'ÂÜô‰ª£Á†Å', emoji: 'üíª', parentId: '1' },
                        { id: '3', name: 'ÂºÄ‰ºö', emoji: 'üë•', parentId: '1' },
                        { id: '4', name: 'ÊäÄËÉΩÂ≠¶‰π†', emoji: 'üìñ', parentId: null },
                        { id: '5', name: 'ËØª‰π¶', emoji: 'üìö', parentId: '4' },
                        { id: '6', name: '‰ΩìÂäõÈîªÁÇº', emoji: 'üí™', parentId: null }
                    ]);
                }
            }, []);

            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('tc_v10_14_logs') || '[]'));
            const [currentParentId, setCurrentParentId] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [showCalendar, setShowCalendar] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [backupString, setBackupString] = useState('');
            const [isCapturing, setIsCapturing] = useState(false);
            const [activeEditId, setActiveEditId] = useState(null);
            const [formData, setFormData] = useState({ name: '', emoji: 'üìç', parentId: '' });
            const [msg, setMsg] = useState({ show: false, text: '', type: 'info' });
            
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            const [itemDeleteConfirmId, setItemDeleteConfirmId] = useState(null);
            const recognitionRef = useRef(null);
            const cardRef = useRef(null);
            const activitiesRef = useRef(activities);

            const showMsg = (text, type = 'info') => {
                setMsg({ show: true, text, type });
                setTimeout(() => setMsg(prev => ({ ...prev, show: false })), 4000);
            };

            useEffect(() => {
                activitiesRef.current = activities;
                localStorage.setItem('tc_v10_14_acts', JSON.stringify(activities));
                localStorage.setItem('tc_v10_14_logs', JSON.stringify(logs));
            }, [activities, logs]);

            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);
            const currentEmoji = useMemo(() => activities.find(a => a.name === currentLog?.activityName)?.emoji || 'üßä', [currentLog, activities]);

            const triggerVibrate = (ms = 50) => {
                if (window.navigator?.vibrate) window.navigator.vibrate(ms);
            };

            const stopCurrent = () => {
                if (!currentLog) return;
                triggerVibrate();
                setLogs(prev => prev.map(l => l.endTime === null ? { ...l, endTime: Date.now() } : l));
            };

            const handleActivityClick = (act) => {
                if (isEditMode) {
                    const children = activities.filter(a => a.parentId === act.id);
                    if (children.length > 0) { 
                        setCurrentParentId(act.id);
                        triggerVibrate(20);
                    }
                    return;
                }
                const children = activities.filter(a => a.parentId === act.id);
                if (children.length > 0) { 
                    setCurrentParentId(act.id);
                    triggerVibrate(30);
                } 
                else {
                    const now = Date.now();
                    triggerVibrate(40);
                    setLogs(prev => [...prev.map(l => l.endTime === null ? { ...l, endTime: now } : l), { 
                        id: Math.random().toString(36).substr(2, 9), 
                        activityName: act.name, 
                        activityEmoji: act.emoji, 
                        parentId: act.parentId,
                        startTime: now, 
                        endTime: null 
                    }]);
                }
            };

            // ÂèåÂáªÂà†Èô§ÈÄªËæë (V10.12)
            const handleDeleteItem = (e, actId) => {
                e.stopPropagation();
                if (itemDeleteConfirmId === actId) {
                    setActivities(prev => prev.filter(a => a.id !== actId && a.parentId !== actId));
                    setItemDeleteConfirmId(null);
                    triggerVibrate(50);
                } else {
                    setItemDeleteConfirmId(actId);
                    triggerVibrate(20);
                    setTimeout(() => setItemDeleteConfirmId(null), 3000);
                }
            };

            const toggleVoice = async () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    handleManualInput({ preventDefault: () => {} });
                    return showMsg("Á≥ªÁªü‰∏çÊîØÊåÅËØ≠Èü≥ÔºåÂ∑≤ËΩ¨‰∏∫ÊâãÂä®ËæìÂÖ•", "error");
                }
                if (isListening) {
                    if (recognitionRef.current) recognitionRef.current.stop();
                    setIsListening(false);
                    return;
                }
                try { await navigator.mediaDevices.getUserMedia({ audio: true }); } 
                catch (e) {
                    handleManualInput({ preventDefault: () => {} });
                    return showMsg("È∫¶ÂÖãÈ£éÂèóÈôêÔºåÂ∑≤ËΩ¨‰∏∫ÊâãÂä®ËæìÂÖ•", "error"); 
                }
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;
                recognitionRef.current = recognition;
                recognition.onstart = () => { setIsListening(true); triggerVibrate(20); showMsg("Ê≠£Âú®Âê¨..."); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.replace(/[ .,?!„ÄÇÔºåÔºüÔºÅ\s\n]/g, '');
                    const allActivities = activitiesRef.current;
                    const match = allActivities.find(act => {
                        const name = act.name.replace(/[ .,?!„ÄÇÔºåÔºüÔºÅ\s\n]/g, '');
                        return transcript.includes(name) || name.includes(transcript);
                    });
                    if (match) {
                        const now = Date.now();
                        triggerVibrate(40);
                        setLogs(prev => {
                            const newLogs = prev.map(l => l.endTime === null ? { ...l, endTime: now } : l);
                            newLogs.push({ id: Math.random().toString(36).substr(2, 9), activityName: match.name, activityEmoji: match.emoji, parentId: match.parentId, startTime: now, endTime: null });
                            return newLogs;
                        });
                        showMsg(`Â∑≤ÂêØÂä®: ${match.name}`);
                    } else { showMsg(`Êú™ËØÜÂà´: "${transcript}"`, "error"); }
                    setIsListening(false);
                };
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);
                recognition.start();
            };
            
            const handleManualInput = (e) => {
                e.preventDefault();
                const input = prompt("ÊâãÂä®ËæìÂÖ•Ê¥ªÂä®ÂêçÁß∞Ôºö");
                if (input) {
                     const match = activitiesRef.current.find(act => input.includes(act.name) || act.name.includes(input));
                     if (match) {
                        handleActivityClick(match);
                        showMsg(`Êåá‰ª§Â∑≤ÊâßË°å: ${match.name}`);
                     } else {
                        showMsg("Êâæ‰∏çÂà∞ËØ•Ê¥ªÂä®", "error");
                     }
                }
            };

            const moveItem = (actId, direction) => {
                const currentList = activities.filter(a => a.parentId === currentParentId);
                const currentIndex = currentList.findIndex(a => a.id === actId);
                if (currentIndex === -1) return;
                const targetIndex = currentIndex + direction;
                if (targetIndex < 0 || targetIndex >= currentList.length) return;
                const targetActivity = currentList[targetIndex];
                const newActivities = [...activities];
                const realIndexA = newActivities.findIndex(a => a.id === actId);
                const realIndexB = newActivities.findIndex(a => a.id === targetActivity.id);
                [newActivities[realIndexA], newActivities[realIndexB]] = [newActivities[realIndexB], newActivities[realIndexA]];
                setActivities(newActivities);
                triggerVibrate(20);
            };

            const clearAllData = () => {
                if (deleteConfirm) {
                    setLogs([]);
                    localStorage.setItem('tc_v10_14_logs', JSON.stringify([])); 
                    showMsg("Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫", "error");
                    setShowSummary(false); 
                    setDeleteConfirm(false);
                } else {
                    setDeleteConfirm(true);
                    setTimeout(() => setDeleteConfirm(false), 3000);
                }
            };

            // V10.13 ÂÆåÊï¥Ë∑ØÂæÑÂØºÂá∫ÈÄªËæë
            const exportCSV = (targetDate = null) => {
                let targetLogs = logs.filter(l => l.endTime);
                if (targetDate) {
                    targetLogs = targetLogs.filter(l => {
                        const d = new Date(l.endTime);
                        return d.getDate() === targetDate.getDate() && d.getMonth() === targetDate.getMonth() && d.getFullYear() === targetDate.getFullYear();
                    });
                } else {
                    const today = new Date();
                    targetLogs = targetLogs.filter(l => {
                        const d = new Date(l.endTime);
                        return d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
                    });
                }
                if (targetLogs.length === 0) return showMsg("ÊöÇÊó†Êï∞ÊçÆ", "error");
                let csv = "\ufeffÊó•Êúü,ÂêçÁß∞,ÂºÄÂßãÊó∂Èó¥,ÁªìÊùüÊó∂Èó¥,Êó∂Èïø(ÂàÜ)\n";
                targetLogs.forEach(l => {
                    const dateStr = new Date(l.endTime).toLocaleDateString();
                    const startStr = new Date(l.startTime).toLocaleTimeString([],{hour12:false});
                    const endStr = new Date(l.endTime).toLocaleTimeString([],{hour12:false});
                    const duration = Math.round((l.endTime-l.startTime)/60000);
                    // ÂÆåÊï¥Ë∑ØÂæÑÈÄªËæë
                    const activityObj = activities.find(a => a.name === l.activityName);
                    const parentObj = activityObj?.parentId ? activities.find(a => a.id === activityObj.parentId) : null;
                    const displayName = parentObj ? `${parentObj.name}-${l.activityName}` : l.activityName;
                    csv += `${dateStr},${displayName},${startStr},${endStr},${duration}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const fileNameDate = targetDate ? targetDate.toLocaleDateString().replace(/\//g,'-') : 'Today';
                link.download = `TimeCatcher_${fileNameDate}.csv`;
                link.click();
            };

            const exportICS = (targetLogs) => {
                const validLogs = targetLogs.filter(l => l.endTime);
                if (validLogs.length === 0) return;
                const fmt = (ts) => new Date(ts).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TimeCatcher//EN\n";
                validLogs.forEach(l => { 
                    const activityObj = activities.find(a => a.name === l.activityName);
                    const parentObj = activityObj?.parentId ? activities.find(a => a.id === activityObj.parentId) : null;
                    const displayName = parentObj ? `${parentObj.name}-${l.activityName}` : l.activityName;
                    ics += `BEGIN:VEVENT\nSUMMARY:[ÊçïÊâã] ${displayName}\nDTSTART:${fmt(l.startTime)}\nDTEND:${fmt(l.endTime)}\nEND:VEVENT\n`; 
                });
                ics += "END:VCALENDAR";
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([ics], {type:'text/calendar'}));
                link.download = "calendar.ics";
                link.click();
            };

            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});

            const saveAsImage = () => {
                const card = document.getElementById('summary-card');
                if (!card) return;
                setIsCapturing(true);
                setTimeout(() => {
                    html2canvas(card, { backgroundColor: '#E0F2F1', scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `ÊàòÊä•_${new Date().toLocaleDateString()}.png`;
                        link.click();
                        setIsCapturing(false);
                    }).catch(() => setIsCapturing(false));
                }, 200);
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay };
            };

            const handleMonthChange = (e) => {
                const [y, m] = e.target.value.split('-');
                const newDate = new Date(parseInt(y), parseInt(m) - 1, 1);
                setSelectedDate(newDate);
            };

            const renderCalendar = () => {
                const { days, firstDay } = getDaysInMonth(selectedDate);
                const monthLogs = logs.filter(l => {
                    if (!l.endTime) return false;
                    const d = new Date(l.endTime); 
                    return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear();
                });

                const grid = [];
                for (let i = 0; i < firstDay; i++) grid.push(<div key={`empty-${i}`} className="h-8"></div>);
                
                for (let d = 1; d <= days; d++) {
                    const dateLogs = monthLogs.filter(l => new Date(l.endTime).getDate() === d);
                    const hasData = dateLogs.length > 0;
                    const isSelected = selectedDate.getDate() === d;
                    grid.push(
                        <button key={d} onClick={() => { const newDate = new Date(selectedDate); newDate.setDate(d); setSelectedDate(newDate); setShowCalendar(false); setShowSummary(true); }} className={`h-8 flex flex-col items-center justify-center border font-bold relative ${isSelected ? 'bg-black text-white' : 'bg-white text-black'} ${hasData ? 'border-black' : 'border-gray-200 text-gray-300'}`}>
                            {d}
                            {hasData && <div className="absolute bottom-1 w-1 h-1 bg-[#FFD60A] border border-black"></div>}
                        </button>
                    );
                }
                return grid;
            };

            const getLogsForDate = (date) => {
                return logs.filter(l => {
                    if (!l.endTime) return false;
                    const d = new Date(l.endTime); 
                    return d.getDate() === date.getDate() && d.getMonth() === date.getMonth() && d.getFullYear() === date.getFullYear();
                }).sort((a,b) => a.startTime - b.startTime);
            };

            return (
                <div className={`flex flex-col h-full w-full p-6 text-[#2D3436] justify-between ${isCapturing ? 'is-capturing' : ''}`}>
                    {msg.show && <div className="fixed top-32 left-1/2 -translate-x-1/2 z-[500] w-[80%] pointer-events-none"><div className="pixel-border p-2 shadow-[4px_4px_0px_0px_black] bg-[#FFD60A] text-black font-black text-center text-xs">{msg.text}</div></div>}

                    {/* Banner */}
                    <div className="flex-shrink-0 mb-4">
                        <div className={`pixel-border pixel-shadow p-5 transition-all duration-500 relative flex flex-col justify-center min-h-[140px] ${currentLog ? 'banner-active bg-white' : 'bg-gray-100 opacity-90'}`}>
                            <div className="flex items-center justify-center gap-4 w-full pr-2 pb-6"> 
                                <span className="text-4xl leading-none flex-shrink-0 drop-shadow-sm">{currentEmoji}</span>
                                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                                    <h1 className="text-2xl font-black truncate leading-none tracking-tighter uppercase">
                                        {currentLog ? currentLog.activityName : 'STANDBY'}
                                    </h1>
                                    {currentLog && <span className="text-sm font-bold text-blue-700 bg-blue-100 border-2 border-blue-500 px-2 py-0.5 leading-none whitespace-nowrap flex-shrink-0">{formatTime(currentLog.startTime)}</span>}
                                </div>
                            </div>
                            <div className="absolute bottom-3 right-3 flex gap-2">
                                <button onClick={toggleVoice} onContextMenu={handleManualInput} className={`w-7 h-7 pixel-border pixel-btn-flat bg-white flex items-center justify-center transition-all ${isListening ? 'mic-active' : ''}`}>{PIXEL_ICONS.mic}</button>
                                <button onClick={() => setIsEditMode(!isEditMode)} className={`w-7 h-7 pixel-border pixel-btn-flat bg-white flex items-center justify-center ${isEditMode ? 'bg-[#FFD60A]' : ''}`}>{PIXEL_ICONS.gear}</button>
                                <button onClick={stopCurrent} className={`w-7 h-7 pixel-border pixel-btn-flat flex items-center justify-center transition-all ${currentLog ? 'bg-white active:bg-red-50' : 'bg-gray-200 opacity-20'}`}>{PIXEL_ICONS.stop}</button>
                            </div>
                        </div>
                    </div>

                    {/* ÂàóË°® */}
                    <div className="flex-1 flex flex-col justify-center min-h-0 py-4 overflow-hidden">
                        <div className="overflow-y-auto no-scrollbar max-h-full">
                            <div className={`transition-all duration-300 ${isEditMode ? 'pt-14' : 'pt-2'}`}>
                                {currentParentId && <button onClick={() => setCurrentParentId(null)} className="mb-8 px-1 text-xs font-black flex items-center gap-2 underline underline-offset-4 decoration-4 uppercase tracking-tighter">{PIXEL_ICONS.back} Back to menu</button>}
                                <div className="grid grid-cols-2 gap-x-6 gap-y-12 px-1 pb-10">
                                    {activities.filter(a => a.parentId === currentParentId).map((act, idx) => {
                                        const hasChildren = activities.some(child => child.parentId === act.id);
                                        return (
                                            <div key={act.id} className="relative">
                                                <button onClick={() => handleActivityClick(act)} className="w-full bg-white pixel-border p-3 pixel-btn-flat flex items-center gap-2 h-20 text-left relative overflow-hidden">
                                                    <span className="text-3xl leading-none flex-shrink-0 select-none">{act.emoji}</span>
                                                    <p className="font-black text-lg uppercase leading-none truncate flex-1">{act.name}</p>
                                                    {hasChildren && <div className="absolute bottom-2 right-2">{PIXEL_ICONS.folder}</div>}
                                                </button>
                                                {isEditMode && (
                                                    <div className="absolute -top-11 left-0 right-0 flex justify-center gap-1.5 z-20">
                                                        <button onClick={() => { setActiveEditId(act.id); setFormData({name: act.name, emoji: act.emoji, parentId: act.parentId || ''}); setShowEditModal(true); }} className="bg-[#FFD60A] border-2 border-black w-8 h-8 flex items-center justify-center shadow-sm">{PIXEL_ICONS.edit}</button>
                                                        {/* ÂèåÂáªÁ°ÆËÆ§Âà†Èô§ */}
                                                        <button onClick={(e) => handleDeleteItem(e, act.id)} className={`border-2 border-black w-8 h-8 flex items-center justify-center shadow-sm transition-colors ${itemDeleteConfirmId === act.id ? 'bg-red-600 text-white animate-pulse' : 'bg-red-500 text-white'}`}>{itemDeleteConfirmId === act.id ? <span className="text-[6px] font-black">SURE</span> : PIXEL_ICONS.trash}</button>
                                                        <button onClick={() => moveItem(act.id, -1)} className="bg-white border-2 border-black w-8 h-8 flex items-center justify-center shadow-sm">{PIXEL_ICONS.up}</button>
                                                        <button onClick={() => moveItem(act.id, 1)} className="bg-white border-2 border-black w-8 h-8 flex items-center justify-center shadow-sm">{PIXEL_ICONS.down}</button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {isEditMode && (
                                        <div className="flex flex-col gap-2">
                                            <button onClick={() => { setFormData({name:'', emoji:'üìç', parentId:''}); setShowAddModal(true); }} className="border-4 border-dashed border-gray-400 p-3 flex items-center justify-center h-20 text-gray-400 bg-white/30">{PIXEL_ICONS.plus}</button>
                                            <button onClick={() => { const data = { activities, logs }; const str = btoa(unescape(encodeURIComponent(JSON.stringify(data)))); setBackupString(str); setShowBackupModal(true); }} className="border-2 border-black bg-white p-2 text-[8px] font-bold tracking-tighter shadow-sm uppercase">Backup Vault</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Â∫ïÈÉ®ÂØºËà™ */}
                    <div className="flex-shrink-0 grid grid-cols-2 gap-5 pb-2">
                        <button onClick={() => { setSelectedDate(new Date()); setShowSummary(true); }} className="bg-black text-white pixel-border p-3 font-bold text-lg flex items-center justify-center gap-2 active:bg-gray-800 uppercase italic tracking-tighter shadow-sm">SUMMARY</button>
                        <button onClick={() => setShowCalendar(true)} className="bg-white pixel-border p-3 font-bold text-lg active:bg-gray-100 uppercase italic tracking-tighter shadow-sm">HISTORY</button>
                    </div>

                    {/* Êó•ÂéÜÂºπÁ™ó */}
                    {showCalendar && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
                            <div className="bg-white pixel-border p-6 w-full max-w-sm">
                                <div className="flex justify-between items-center mb-6 border-b-4 border-black pb-2">
                                    <h2 className="text-2xl font-black uppercase">TIME TRAVEL</h2>
                                    <button onClick={() => setShowCalendar(false)} className="text-xl font-bold border-2 border-black px-3">X</button>
                                </div>
                                <div className="flex justify-center items-center mb-4">
                                    <input type="month" value={`${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}`} onChange={handleMonthChange} className="font-black text-xl text-center bg-[#E0F2F1] border-2 border-black p-2 outline-none uppercase" />
                                </div>
                                <div className="grid grid-cols-7 gap-2 mb-6">
                                    {['S','M','T','W','T','F','S'].map((d,i) => <div key={i} className="text-center text-xs font-bold opacity-40">{d}</div>)}
                                    {renderCalendar()}
                                </div>
                                <div className="border-t-4 border-dashed border-gray-300 pt-4">
                                    <button onClick={() => exportCSV(null)} className="w-full bg-[#E0F2F1] pixel-border p-3 font-bold text-xs uppercase shadow-sm active:bg-gray-200">EXPORT ALL HISTORY (CSV)</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ÊÄªÁªìÈ°µÈù¢ (2x2 Áü©Èòµ + Ê∏ÖÈô§) */}
                    {showSummary && (
                        <div className={`fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm ${isCapturing ? 'is-capturing' : ''}`}>
                            <div id="summary-card" className="bg-[#E0F2F1] pixel-border p-6 w-full max-w-sm flex flex-col overflow-hidden max-h-[85vh] text-left">
                                <div className="flex justify-between items-center mb-5 border-b-4 border-black pb-2">
                                    <div><h2 className="text-3xl font-black italic uppercase tracking-tighter">Mission Clear</h2><p className="text-[10px] font-bold opacity-40 mt-1">Date: {selectedDate.toLocaleDateString()}</p></div>
                                    <button onClick={() => setShowSummary(false)} className="hide-in-capture text-xl font-bold border-4 border-black px-4 py-1 bg-white mb-2 shadow-sm shadow-black">X</button>
                                </div>
                                <div className="flex-1 space-y-1 overflow-y-auto no-scrollbar pr-1 pb-4">
                                    {getLogsForDate(selectedDate).length === 0 ? (
                                        <p className="text-center font-bold opacity-30 py-20 italic uppercase tracking-tight">No Data Found</p>
                                    ) : (
                                        getLogsForDate(selectedDate).map((l, i) => {
                                            const activityObj = activities.find(a => a.name === l.activityName);
                                            const parentObj = activityObj?.parentId ? activities.find(a => a.id === activityObj.parentId) : null;
                                            const displayName = parentObj ? `${parentObj.name}-${l.activityName}` : l.activityName;
                                            return (
                                                <div key={i} className="bg-white border-b-2 border-black/10 p-2 flex justify-between items-center text-left">
                                                    <div className="flex items-center gap-1.5 min-w-0">
                                                        <span className="text-lg flex-shrink-0">{l.activityEmoji || 'üìç'}</span>
                                                        <div className="flex items-baseline gap-1.5 truncate">
                                                            <span className="font-black text-[13px] uppercase truncate leading-none">{displayName}</span>
                                                            <span className="text-[9px] font-bold text-blue-600 opacity-60 flex-shrink-0">[{formatTime(l.startTime)}-{formatTime(l.endTime)}]</span>
                                                        </div>
                                                    </div>
                                                    <div className="font-black text-xs flex-shrink-0 ml-2">{Math.round((l.endTime-l.startTime)/60000)}M</div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                                <div className="mt-2 pt-4 border-t-4 border-black flex justify-between items-end flex-shrink-0 text-left">
                                    <div className="flex-1">
                                        <p className="text-[10px] font-bold opacity-40 uppercase mb-1">Total XP</p>
                                        <p className="text-5xl font-black leading-none">
                                            {Math.round(getLogsForDate(selectedDate).reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0
                                        </p>
                                    </div>
                                    <div className="hide-in-capture grid grid-cols-2 gap-2 w-32">
                                        <button onClick={saveAsImage} className="bg-[#FFD60A] border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Save Image">{PIXEL_ICONS.save} PNG</button>
                                        <button onClick={() => exportICS(getLogsForDate(selectedDate))} className="bg-[#6D83F2] text-white border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Sync Calendar">{PIXEL_ICONS.cal} CAL</button>
                                        <button onClick={() => exportCSV(selectedDate)} className="bg-white text-black border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Export CSV">{PIXEL_ICONS.csv} CSV</button>
                                        <button onClick={clearAllData} className={`border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1 transition-colors ${deleteConfirm ? 'bg-red-600 text-white' : 'bg-white text-red-600'}`} title="Clear Data">{PIXEL_ICONS.trash} {deleteConfirm ? '?' : 'CLR'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Êñ∞Â¢û/ÁºñËæëÂºπÁ™ó */}
                    {(showAddModal || showEditModal) && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md text-left">
                            <div className="bg-white pixel-border p-6 w-full max-w-sm shadow-[10px_10px_0px_0px_black]">
                                <h2 className="text-3xl font-black mb-6 uppercase border-b-4 border-black">{showEditModal ? 'Edit' : 'New'}</h2>
                                <div className="space-y-5 max-h-[50vh] overflow-y-auto no-scrollbar pr-1">
                                    <input type="text" placeholder="Name..." className="w-full pixel-border p-4 font-bold text-xl outline-none focus:bg-yellow-50" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                    <div className="pixel-border p-4 bg-gray-50">
                                        <div className="grid grid-cols-5 gap-3 h-28 overflow-y-auto pr-1 no-scrollbar text-3xl text-center">
                                            {COMMON_EMOJIS.map(e => <button key={e} onClick={() => setFormData({...formData, emoji: e})} className={`p-1 border-2 transition-all ${formData.emoji === e ? 'border-black bg-yellow-100 shadow-[3px_3px_0px_0px_black]' : 'border-transparent'}`}>{e}</button>)}
                                        </div>
                                    </div>
                                    <select className="w-full pixel-border p-4 font-bold bg-white text-lg outline-none" value={formData.parentId} onChange={e => setFormData({...formData, parentId: e.target.value})}>
                                        <option value="">Top Category</option>
                                        {activities.filter(a => !a.parentId && a.id !== activeEditId).map(a => <option key={a.id} value={a.id}>Under: {a.name}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-4 mt-8">
                                    <button onClick={() => {setShowAddModal(false); setShowEditModal(false);}} className="flex-1 pixel-border p-4 font-black uppercase text-xs text-center">Abort</button>
                                    <button onClick={() => {
                                        if(!formData.name) return;
                                        if(showEditModal) setActivities(prev => prev.map(a => a.id === activeEditId ? { ...a, name: formData.name, emoji: formData.emoji, parentId: formData.parentId || null } : a));
                                        else setActivities([...activities, { id: Math.random().toString(36).substr(2, 9), ...formData, parentId: formData.parentId || null }]);
                                        setShowAddModal(false); setShowEditModal(false);
                                        triggerVibrate(30);
                                    }} className="flex-1 bg-black text-white p-4 font-black uppercase text-xs text-center">Save</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
