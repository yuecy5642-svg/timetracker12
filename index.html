<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¶é—´æ•æ‰‹ TimeCatcher V3.1</title>
    <!-- æ ¸å¿ƒèµ„æºï¼šTailwind, PixelArtIcons, html2canvas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/pixelarticons@1.8.1/css/pixelarticons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- å¼•å…¥ React è¿è¡Œç¯å¢ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        body {
            font-family: 'DotGothic16', 'Courier New', monospace;
            background-color: #cedede;
            margin: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å›¾æ ‡ä¿åº•æ ·å¼ */
        .pa {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.25em; 
            min-height: 1.25em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- å›¾æ ‡ä¸ Emoji ä¿åº•æ˜ å°„ ---
        const ICON_MAP = {
            'briefcase': 'ğŸ’¼', 'code': 'ğŸ’»', 'users': 'ğŸ‘¥', 'book-open': 'ğŸ“–',
            'book': 'ğŸ“š', 'heart': 'â¤ï¸', 'device-mobile': 'ğŸ“±', 'sleep': 'ğŸŒ™',
            'coffee': 'â˜•', 'microphone': 'ğŸ™ï¸', 'chevron-down': 'â–¼', 'chevron-left': 'â—€',
            'close-circle': 'âŒ', 'plus': 'ï¼‹', 'gear': 'âš™ï¸', 'file': 'ğŸ“„', 'calendar': 'ğŸ“…',
            'zap': 'âš¡', 'check': 'âœ…', 'trash': 'ğŸ—‘ï¸', 'image': 'ğŸ–¼ï¸'
        };

        const App = () => {
            // --- 1. çŠ¶æ€ç®¡ç† ---
            const [activities, setActivities] = useState(() => {
                const saved = localStorage.getItem('tc_activities');
                return saved ? JSON.parse(saved) : [
                    { id: '1', name: 'å·¥ä½œ', icon: 'briefcase', parentId: null },
                    { id: '2', name: 'å†™ä»£ç ', icon: 'code', parentId: '1' },
                    { id: '3', name: 'å¼€ä¼š', icon: 'users', parentId: '1' },
                    { id: '4', name: 'å­¦ä¹ ', icon: 'book', parentId: null },
                    { id: '5', name: 'è¯»ä¹¦', icon: 'book-open', parentId: '4' },
                    { id: '6', name: 'å†¥æƒ³', icon: 'heart', parentId: null },
                    { id: '7', name: 'ç©æ‰‹æœº', icon: 'device-mobile', parentId: null },
                    { id: '8', name: 'ç¡è§‰', icon: 'sleep', parentId: null }
                ];
            });

            const [logs, setLogs] = useState(() => {
                const saved = localStorage.getItem('tc_logs');
                return saved ? JSON.parse(saved) : [];
            });

            const [currentParentId, setCurrentParentId] = useState(null);
            const [isManageMode, setIsManageMode] = useState(false);
            const [isOpen, setIsOpen] = useState(true);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [iconsLoaded, setIconsLoaded] = useState(true);
            const [newActivity, setNewActivity] = useState({ name: '', icon: 'zap', parentId: '' });

            // --- 2. å­˜å‚¨ä¸æ£€æµ‹ ---
            useEffect(() => {
                localStorage.setItem('tc_activities', JSON.stringify(activities));
            }, [activities]);

            useEffect(() => {
                localStorage.setItem('tc_logs', JSON.stringify(logs));
            }, [logs]);

            // æ£€æµ‹å›¾æ ‡åº“æ˜¯å¦åŠ è½½æˆåŠŸ
            useEffect(() => {
                const checkIcons = () => {
                    const span = document.createElement('span');
                    span.className = 'pa pa-briefcase';
                    span.style.display = 'none';
                    document.body.appendChild(span);
                    const fontName = window.getComputedStyle(span).getPropertyValue('font-family');
                    if (!fontName.includes('pixelarticons')) {
                        setIconsLoaded(false);
                    }
                    document.body.removeChild(span);
                };
                setTimeout(checkIcons, 2000);
            }, []);

            // --- 3. æ ¸å¿ƒåŠŸèƒ½ ---
            const triggerVibrate = () => { if (window.navigator?.vibrate) window.navigator.vibrate(50); };
            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);

            const startActivity = useCallback((activityId) => {
                const activity = activities.find(a => a.id === activityId);
                if (!activity) return;
                triggerVibrate();
                const now = Date.now();
                setLogs(prev => {
                    const newLogs = [...prev];
                    const activeIndex = newLogs.findIndex(l => l.endTime === null);
                    if (activeIndex !== -1) newLogs[activeIndex].endTime = now;
                    newLogs.push({ 
                        id: (Math.random() * 1000).toString(), 
                        activityId: activity.id, 
                        activityName: activity.name, 
                        startTime: now, 
                        endTime: null 
                    });
                    return newLogs;
                });
                setIsOpen(false);
            }, [activities]);

            const handleActivityClick = (activity) => {
                if (isManageMode) return;
                const children = activities.filter(a => a.parentId === activity.id);
                if (children.length > 0) {
                    setCurrentParentId(activity.id);
                    triggerVibrate();
                } else {
                    startActivity(activity.id);
                }
            };

            const exportCSV = () => {
                let csv = "\ufeffæ´»åŠ¨åç§°,å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´,è€—æ—¶(åˆ†é’Ÿ)\n";
                logs.forEach(l => {
                    const duration = l.endTime ? Math.round((l.endTime - l.startTime) / 60000) : 0;
                    csv += `${l.activityName},${new Date(l.startTime).toLocaleString()},${l.endTime ? new Date(l.endTime).toLocaleString() : 'è¿›è¡Œä¸­'},${duration}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `æ—¶é—´è´¦å•_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            const exportICS = () => {
                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\n";
                logs.forEach(l => {
                    if (!l.endTime) return;
                    const fmt = (ts) => new Date(ts).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    ics += `BEGIN:VEVENT\nSUMMARY:${l.activityName}\nDTSTART:${fmt(l.startTime)}\nDTEND:${fmt(l.endTime)}\nEND:VEVENT\n`;
                });
                ics += "END:VCALENDAR";
                const blob = new Blob([ics], { type: 'text/calendar' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "timecatcher.ics";
                link.click();
            };

            const startVoice = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
                const rec = new Speech();
                rec.lang = 'zh-CN';
                setIsListening(true);
                rec.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    const match = activities.find(a => text.includes(a.name));
                    if (match) handleActivityClick(match);
                    else alert("æ²¡è¯†åˆ«å‡ºæ´»åŠ¨: " + text);
                };
                rec.onend = () => setIsListening(false);
                rec.start();
            };

            const saveAsImage = () => {
                const el = document.getElementById('summary-card');
                window.html2canvas(el, { backgroundColor: '#E0F2F1', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL();
                    link.download = 'ä»Šæ—¥ç»“ç®—å¡.png';
                    link.click();
                });
            };

            const getIcon = (name) => {
                if (iconsLoaded) return <i className={`pa pa-${name} text-xl`}></i>;
                return <span className="text-xl leading-none">{ICON_MAP[name] || 'ğŸ“'}</span>;
            };

            const displayedActivities = activities.filter(a => a.parentId === currentParentId);

            return (
                <div className="min-h-screen bg-[#cedede] font-mono text-[#2D3436] select-none">
                    {/* é¡¶éƒ¨æ§åˆ¶å° (Top Drawer) */}
                    <div className={`fixed top-0 left-1/2 -translate-x-1/2 w-[94%] bg-[#E0F2F1] border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] z-50 transition-all duration-300 ${isOpen ? 'translate-y-2' : '-translate-y-[85%]'}`} style={{ maxHeight: '48vh' }}>
                        <div className="p-4 flex justify-between items-center border-b-2 border-black bg-white/40">
                            <div>
                                <p className="text-[10px] opacity-50 font-bold uppercase tracking-widest">Current Task</p>
                                <h2 className="font-bold text-lg">{currentLog ? currentLog.activityName : 'ä¼‘æ¯ä¸­'}</h2>
                                {currentLog && <p className="text-[10px] text-blue-600 font-bold mt-1 uppercase">Since {new Date(currentLog.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={startVoice} className={`w-11 h-11 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center transition-all active:translate-y-0.5 ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-white'}`}>{getIcon('microphone')}</button>
                                <button onClick={() => { setIsManageMode(!isManageMode); triggerVibrate(); }} className={`w-11 h-11 border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] flex items-center justify-center transition-all active:translate-y-0.5 ${isManageMode ? 'bg-[#E57373]' : 'bg-white'}`}>{getIcon('gear')}</button>
                            </div>
                        </div>

                        <div className="p-4 overflow-y-auto max-h-[32vh] no-scrollbar">
                            {currentParentId && (
                                <button onClick={() => setCurrentParentId(null)} className="mb-4 text-xs flex items-center gap-1 border-b-2 border-black pb-1 font-bold italic">
                                    {getIcon('chevron-left')} è¿”å›ä¸»é¡µ
                                </button>
                            )}
                            <div className="grid grid-cols-1 gap-3">
                                {displayedActivities.map(act => (
                                    <div key={act.id} onClick={() => handleActivityClick(act)} className="bg-white border-2 border-black p-4 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[1px] active:translate-y-[1px] flex justify-between items-center cursor-pointer">
                                        <div className="flex items-center gap-4">
                                            <div className="w-6 flex justify-center">{getIcon(act.icon)}</div>
                                            <span className="font-bold text-sm tracking-tight">{act.name}</span>
                                        </div>
                                        <div className="flex items-center">
                                            {isManageMode ? <button onClick={(e) => {e.stopPropagation(); if(confirm('åˆ é™¤å—ï¼Ÿ')) setActivities(prev => prev.filter(a => a.id !== act.id && a.parentId !== act.id))}} className="text-[#E57373]">{getIcon('trash')}</button> : activities.some(a => a.parentId === act.id) && <div className="opacity-30">{getIcon('chevron-down')}</div>}
                                        </div>
                                    </div>
                                ))}
                                {isManageMode && <button onClick={() => setShowAddModal(true)} className="border-2 border-dashed border-gray-400 p-4 flex items-center justify-center gap-2 text-gray-400 font-bold uppercase text-xs">{getIcon('plus')} Add Category</button>}
                            </div>
                        </div>

                        <div className="p-3 border-t-2 border-black flex justify-around bg-white/30 text-[10px] font-bold uppercase">
                            <button onClick={() => { setShowSummary(true); triggerVibrate(); }}>ä»Šæ—¥æ€»ç»“</button>
                            <button onClick={exportCSV}>CSVå¯¼å‡º</button>
                            <button onClick={exportICS}>æ—¥å†åŒæ­¥</button>
                        </div>
                        <div onClick={() => setIsOpen(!isOpen)} className="h-6 flex items-center justify-center cursor-pointer group"><div className="w-14 h-1 bg-black/10 group-hover:bg-black/20 rounded-full"></div></div>
                    </div>

                    {isOpen && <div className="fixed inset-0 bg-black/30 backdrop-blur-[1px] z-40" onClick={() => setIsOpen(false)}></div>}

                    {/* ä»Šæ—¥æ€»ç»“å¡ç‰‡ */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
                            <div id="summary-card" className="bg-[#E0F2F1] border-[3px] border-black p-6 w-full max-w-sm shadow-[10px_10px_0px_0px_rgba(0,0,0,0.5)]">
                                <h1 className="text-2xl font-black italic border-b-4 border-black mb-6 pb-1 uppercase italic tracking-tight">Today's Results</h1>
                                <div className="space-y-6">
                                    {Object.entries(logs.reduce((acc, l) => {
                                        const duration = l.endTime ? (l.endTime - l.startTime) / 60000 : 0;
                                        if (duration > 0) acc[l.activityName] = (acc[l.activityName] || 0) + duration;
                                        return acc;
                                    }, {})).sort((a, b) => b[1] - a[1]).map(([name, time]) => (
                                        <div key={name}>
                                            <div className="flex justify-between text-[11px] font-bold mb-1.5 uppercase"><span>{name}</span><span>{Math.round(time)} MIN</span></div>
                                            <div className="h-4 bg-white border-2 border-black relative"><div className="h-full bg-[#6D83F2] border-r-2 border-black" style={{ width: `${Math.min(100, (time / 300) * 100)}%` }}></div></div>
                                        </div>
                                    ))}
                                    <div className="pt-6 border-t-2 border-black flex justify-between items-end">
                                        <div><p className="text-[10px] opacity-60 font-bold uppercase">Total XP</p><p className="text-5xl font-black leading-none mt-1">{Math.round(logs.reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0</p></div>
                                        <p className="text-[10px] font-bold opacity-40">{new Date().toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-10 flex gap-4">
                                <button onClick={() => setShowSummary(false)} className="bg-white border-2 border-black px-8 py-3 text-xs font-bold shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">å…³é—­</button>
                                <button onClick={saveAsImage} className="bg-[#6D83F2] border-2 border-black px-8 py-3 text-xs font-bold shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] text-white">ä¿å­˜å›¾ç‰‡</button>
                            </div>
                        </div>
                    )}

                    {/* æ–°å¢åˆ†ç±»å¼¹çª— */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-white border-2 border-black p-6 w-full max-w-xs shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                <h2 className="font-bold text-lg border-b-2 border-black mb-6 pb-1 uppercase tracking-tighter">New Activity</h2>
                                <div className="space-y-5 text-sm">
                                    <input type="text" placeholder="è¾“å…¥åç§°..." className="w-full border-2 border-black p-3 outline-none font-bold focus:bg-blue-50" value={newActivity.name} onChange={e => setNewActivity({...newActivity, name: e.target.value})} />
                                    <select className="w-full border-2 border-black p-3 outline-none font-bold bg-white" value={newActivity.parentId} onChange={e => setNewActivity({...newActivity, parentId: e.target.value})}>
                                        <option value="">è®¾ä¸ºé¡¶çº§åˆ†ç±»</option>
                                        {activities.filter(a => !a.parentId).map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <div className="grid grid-cols-5 gap-2 h-24 overflow-y-auto p-2 border-2 border-black bg-gray-50 no-scrollbar">
                                        {Object.keys(ICON_MAP).map(icon => <button key={icon} onClick={() => setNewActivity({...newActivity, icon})} className={`flex items-center justify-center p-2 border-2 ${newActivity.icon === icon ? 'bg-[#6D83F2] border-black text-white' : 'border-transparent hover:bg-gray-200'}`}>{ICON_MAP[icon]}</button>)}
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setShowAddModal(false)} className="flex-1 border-2 border-black p-3 text-xs font-bold active:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                                    <button onClick={() => { if(!newActivity.name) return; setActivities([...activities, {id: (Math.random()*1000).toString(), ...newActivity, parentId: newActivity.parentId || null}]); setShowAddModal(false); setNewActivity({name:'', icon:'zap', parentId:''}); triggerVibrate(); }} className="flex-1 bg-black text-white p-3 text-xs font-bold active:bg-gray-800 transition-colors">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
