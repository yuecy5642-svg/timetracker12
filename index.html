<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>时间捕手 TimeCatcher V3.5</title>
    
    <!-- 核心资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        :root {
            --pixel-bg: #E0F2F1;
            --pixel-blue: #6D83F2;
            --pixel-red: #E57373;
        }

        body {
            font-family: 'DotGothic16', 'Courier New', monospace;
            background-color: transparent; 
            margin: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .pixel-border { border: 2px solid black; }
        .pixel-shadow { box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .pixel-shadow-sm { box-shadow: 2px 2px 0px 0px rgba(0,0,0,1); }
        
        .pixel-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px 0px rgba(0,0,0,1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .icon-svg { 
            fill: currentColor; 
            width: 20px; 
            height: 20px; 
            display: inline-block;
        }

        /* 打字机效果 */
        .typing-effect {
            border-right: 2px solid #000;
            white-space: pre-wrap;
            animation: caret 0.75s step-end infinite;
        }
        @keyframes caret {
            from, to { border-color: transparent }
            50% { border-color: black }
        }
    </style>
</head>
<body class="bg-[#cedede]/70 backdrop-blur-md">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 内置像素 SVG 图标集 ---
        const PIXEL_ICONS = {
            briefcase: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M3 4h18v16H3V4zm2 2v12h14V6H5zm4-4h6v2H9V2zm3 9h2v2h-2v-2z"/></svg>,
            code: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M8 5l-5 7 5 7h2l-5-7 5-7H8zm8 0l5 7-5 7h-2l 5-7-5-7h2zm-7 14h2l2-14h-2l-2 14z"/></svg>,
            users: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M12 2h2v2h-2V2zM8 2h2v2H8V2zm10 2h2v2h-2V4zm-2 2h2v2h-2V6zm-2 2h2v2h-2V8zm-2 2h2v2h-2v-2zm-2 2h2v2h-2v-2zm-2 2h2v2H8v-2zm-2 2h2v2H6v-2zm-2 2h2v2H4v-2zm0-10h2v2H4V8zm2-2h2v2H6V6z"/></svg>,
            book: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M5 2h14v16h-14v-16zm2 2v12h10v-12h-10zm2 2h6v2h-6v-2zm0 4h6v2h-6v-2zm-4 12h14v2h-14v-2z"/></svg>,
            heart: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M9 2h2v2H9V2zm6 0h-2v2h2V2zm2 2h2v2h-2V4zM7 4H5v2h2V4zm0 2H3v6h2v2h2v2h2v2h2v2h2v-2h2v-2h2v-2h2V6h-2V4h-2v2h-2v2H9V6H7z"/></svg>,
            mobile: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M7 2h10v20H7V2zm2 2v16h6V4H9zm2 14h2v2h-2v-2z"/></svg>,
            sleep: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M12 2h2v2h-2V2zm4 2h2v2h-2V4zm2 2h2v6h-2v2h-2v2h-2v2h-4v-2H8v-2H6v-2H4V6h2V4h2v2h2v2h2v2h2V8h2V6z"/></svg>,
            microphone: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v12h-2V2zM7 8h2v6H7V8zm8 0h2v6h-2V8zm-6 8h6v2H9v-2zm2 4h2v2h-2v-2z"/></svg>,
            gear: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm6 2l1.4 1.4-2.8 2.8-1.4-1.4L17 4zM7 4L5.6 5.4l2.8 2.8 1.4-1.4L7 4zm13 7v2h-4v-2h4zM8 11v2H4v-2h4zm9 8l-1.4 1.4-2.8-2.8 1.4-1.4 2.8 2.8zM7 19l1.4-1.4 2.8 2.8-1.4 1.4L7 19zm4 1h2v4h-2v-4zm1-11a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>,
            chevronDown: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M4 8h16v2H4V8zm2 2h12v2H6v-2zm2 2h8v2H8v-2zm2 2h4v2h-4v-2zm2 2h2v2h-2v-2z"/></svg>,
            back: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M10 4v2H8v2H6v2H4v4h2v2h2v2h2v2h2v-4h-2v-2h-2v-4h2V8h2V4h-2zM12 10h8v4h-8v-4z"/></svg>,
            stop: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>,
            plus: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z"/></svg>,
            sparkles: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm6 2l1.4 1.4-2.8 2.8-1.4-1.4L17 4zM7 4L5.6 5.4l2.8 2.8 1.4-1.4L7 4zm13 7v2h-4v-2h4zM8 11v2H4v-2h4zm9 8l-1.4 1.4-2.8-2.8 1.4-1.4 2.8 2.8zM7 19l1.4-1.4 2.8 2.8-1.4 1.4L7 19zm4 1h2v4h-2v-4z"/></svg>,
            trash: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M9 2h6v2H9V2zM5 4h14v2H5V4zm2 2h10v14H7V6zm2 2v10h2V8H9zm4 0v10h2V8h-2z"/></svg>,
            zap: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v9h6v2h-8v9h-2v-9H5v-2h6V2z"/></svg>
        };

        const App = () => {
            const [activities, setActivities] = useState(() => {
                const saved = localStorage.getItem('tc_v3_5_acts');
                return saved ? JSON.parse(saved) : [
                    { id: '1', name: '工作', icon: 'briefcase', parentId: null },
                    { id: '2', name: '写代码', icon: 'code', parentId: '1' },
                    { id: '3', name: '开会', icon: 'users', parentId: '1' },
                    { id: '4', name: '学习', icon: 'book', parentId: null },
                    { id: '5', name: '看书', icon: 'book', parentId: '4' },
                    { id: '6', name: '冥想', icon: 'heart', parentId: null },
                    { id: '7', name: '玩手机', icon: 'mobile', parentId: null },
                    { id: '8', name: '睡觉', icon: 'sleep', parentId: null }
                ];
            });

            const [logs, setLogs] = useState(() => {
                const saved = localStorage.getItem('tc_v3_5_logs');
                return saved ? JSON.parse(saved) : [];
            });

            const [currentParentId, setCurrentParentId] = useState(null);
            const [isManageMode, setIsManageMode] = useState(false);
            const [isPanelOpen, setIsPanelOpen] = useState(true);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [newActForm, setNewActForm] = useState({ name: '', icon: 'zap', parentId: '' });
            
            const [aiAdvice, setAiAdvice] = useState("");
            const [isAiThinking, setIsAiThinking] = useState(false);
            const apiKey = ""; 

            useEffect(() => {
                localStorage.setItem('tc_v3_5_acts', JSON.stringify(activities));
                localStorage.setItem('tc_v3_5_logs', JSON.stringify(logs));
            }, [activities, logs]);

            const triggerVibrate = () => { if (window.navigator?.vibrate) window.navigator.vibrate(50); };
            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);

            // --- 核心：结束当前活动 ---
            const stopAll = () => {
                triggerVibrate();
                setLogs(prev => {
                    const newList = [...prev];
                    const activeIdx = newList.findIndex(l => l.endTime === null);
                    if (activeIdx !== -1) {
                        newList[activeIdx].endTime = Date.now();
                    }
                    return newList;
                });
            };

            const startActivity = useCallback((id) => {
                const activity = activities.find(a => a.id === id);
                if (!activity) return;
                triggerVibrate();
                const now = Date.now();
                setLogs(prev => {
                    const newList = [...prev];
                    const activeIdx = newList.findIndex(l => l.endTime === null);
                    if (activeIdx !== -1) newList[activeIdx].endTime = now;
                    newList.push({ id: Math.random().toString(36).substr(2, 9), activityId: activity.id, activityName: activity.name, startTime: now, endTime: null });
                    return newList;
                });
                setIsPanelOpen(false);
            }, [activities]);

            const handleActivityClick = (act) => {
                if (isManageMode) return;
                const subs = activities.filter(a => a.parentId === act.id);
                if (subs.length > 0) {
                    setCurrentParentId(act.id);
                    triggerVibrate();
                } else {
                    startActivity(act.id);
                }
            };

            const askGemini = async () => {
                if (logs.length === 0) return alert("无数据");
                setIsAiThinking(true);
                const summary = Object.entries(logs.reduce((acc, l) => {
                    const d = l.endTime ? (l.endTime - l.startTime) / 60000 : 0;
                    if (d > 0) acc[l.activityName] = (acc[l.activityName] || 0) + d;
                    return acc;
                }, {})).map(([n, t]) => `${n}:${Math.round(t)}分`).join(',');
                const sysPrompt = "你是一位像素游戏的时间大师。请分析数据，给出一句犀利的游戏化评价。不超过50字。";
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `今日数据: ${summary}` }] }], systemInstruction: { parts: [{ text: sysPrompt }] } })
                    });
                    const data = await res.json();
                    setAiAdvice(data.candidates?.[0]?.content?.parts?.[0]?.text || "大师累了。");
                } catch (e) { setAiAdvice("通讯中断..."); } finally { setIsAiThinking(false); }
            };

            return (
                <div className="min-h-screen flex flex-col justify-start">
                    
                    {/* 顶部控制台 */}
                    <div className={`mx-auto w-[94%] bg-[#E0F2F1] pixel-border pixel-shadow z-50 transition-all duration-300 ${isPanelOpen ? 'translate-y-2' : '-translate-y-[82%]'}`} style={{ maxHeight: '60vh' }}>
                        
                        {/* 状态栏：右上角固定结束键 */}
                        <div className="p-4 flex justify-between items-center border-b-2 border-black bg-white/40">
                            <div className="flex-1 overflow-hidden">
                                <p className="text-[9px] opacity-40 font-bold uppercase tracking-widest leading-none">Questing</p>
                                <h2 className="font-bold text-base leading-tight truncate mr-2">{currentLog ? currentLog.activityName : '闲置中'}</h2>
                            </div>
                            <div className="flex gap-2 ml-2 items-center">
                                {/* 停止按钮：即使闲置也显示，只是变淡 */}
                                <button 
                                    onClick={stopAll} 
                                    disabled={!currentLog}
                                    className={`w-10 h-10 pixel-border pixel-shadow-sm pixel-btn flex items-center justify-center transition-all ${currentLog ? 'bg-white text-[#E57373]' : 'bg-gray-100 text-gray-300 opacity-50'}`}
                                >
                                    {PIXEL_ICONS.stop}
                                </button>
                                <button onClick={() => {
                                    const sr = window.SpeechRecognition || window.webkitSpeechRecognition;
                                    if(!sr) return alert("不支持");
                                    const r = new sr(); r.lang='zh-CN'; setIsListening(true);
                                    r.onresult=(e)=>{const t=e.results[0][0].transcript; const m=activities.find(a=>t.includes(a.name)); if(m) handleActivityClick(m);};
                                    r.onend=()=>setIsListening(false); r.start();
                                }} className={`w-10 h-10 bg-white pixel-border pixel-shadow-sm pixel-btn flex items-center justify-center ${isListening ? 'bg-red-500 animate-pulse text-white' : ''}`}>
                                    {PIXEL_ICONS.microphone}
                                </button>
                                <button onClick={() => setIsManageMode(!isManageMode)} className={`w-10 h-10 pixel-border pixel-shadow-sm pixel-btn flex items-center justify-center ${isManageMode ? 'bg-[#E57373]' : 'bg-white'}`}>
                                    {PIXEL_ICONS.gear}
                                </button>
                            </div>
                        </div>

                        {/* 列表区 */}
                        <div className="p-4 overflow-y-auto max-h-[40vh] no-scrollbar">
                            {currentParentId && <button onClick={() => setCurrentParentId(null)} className="mb-3 text-[10px] font-bold border-b-2 border-black pb-1 flex items-center gap-1">{PIXEL_ICONS.back} BACK</button>}
                            <div className="grid grid-cols-1 gap-2">
                                {activities.filter(a => a.parentId === currentParentId).map(act => (
                                    <div key={act.id} onClick={() => handleActivityClick(act)} className="bg-white pixel-border p-3 pixel-shadow-sm pixel-btn flex justify-between items-center cursor-pointer">
                                        <div className="flex items-center gap-3 text-black">
                                            {PIXEL_ICONS[act.icon] || PIXEL_ICONS.zap}
                                            <span className="font-bold text-xs">{act.name}</span>
                                        </div>
                                        <div className="text-black/30">
                                            {isManageMode ? <button onClick={(e) => {e.stopPropagation(); if(confirm('删除？')) setActivities(activities.filter(a=>a.id!==act.id && a.parentId!==act.id))}} className="text-[#E57373]">{PIXEL_ICONS.trash}</button> : activities.some(a=>a.parentId===act.id) && PIXEL_ICONS.chevronDown}
                                        </div>
                                    </div>
                                ))}
                                {isManageMode && <button onClick={() => setShowAddModal(true)} className="border-2 border-dashed border-gray-400 p-3.5 text-gray-400 font-bold uppercase text-[10px] flex items-center justify-center gap-2">{PIXEL_ICONS.plus} NEW CATEGORY</button>}
                            </div>
                        </div>

                        {/* 底部导航条：修复文字重叠，确保完整展出 */}
                        <div className="border-t-2 border-black flex flex-row w-full bg-white/30 divide-x-2 divide-black/10 overflow-hidden">
                            <button onClick={() => {setShowSummary(true); triggerVibrate()}} className="flex-1 py-3 text-[10px] font-bold uppercase tracking-tight active:bg-black/5 whitespace-nowrap px-1 text-center">今日总结</button>
                            <button onClick={() => {
                                let csv = "\ufeff活动,时长(分)\n";
                                logs.forEach(l => { const d = l.endTime ? Math.round((l.endTime - l.startTime)/60000) : 0; csv += `"${l.activityName}",${d}\n`; });
                                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "data.csv"; link.click();
                            }} className="flex-1 py-3 text-[10px] font-bold uppercase tracking-tight active:bg-black/5 whitespace-nowrap px-1 text-center">导出CSV</button>
                            <button onClick={() => {
                                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\n";
                                logs.forEach(l => { if(!l.endTime) return; const f = (t) => new Date(t).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; ics += `BEGIN:VEVENT\nSUMMARY:${l.activityName}\nDTSTART:${f(l.startTime)}\nDTEND:${f(l.endTime)}\nEND:VEVENT\n`; });
                                ics += "END:VCALENDAR";
                                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' })); link.download = "sync.ics"; link.click();
                            }} className="flex-1 py-3 text-[10px] font-bold uppercase tracking-tight active:bg-black/5 whitespace-nowrap px-1 text-center">日历同步</button>
                        </div>
                        
                        <div onClick={() => setIsPanelOpen(!isPanelOpen)} className="h-5 flex items-center justify-center cursor-pointer group"><div className="w-12 h-1 bg-black/15 group-hover:bg-black/30 rounded-full"></div></div>
                    </div>

                    {/* 点击背景遮罩 */}
                    {isPanelOpen && <div className="fixed inset-0 bg-transparent z-40" onClick={() => setIsPanelOpen(false)}></div>}

                    {/* 总结弹窗 */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex flex-col items-center justify-center p-6 backdrop-blur-sm overflow-y-auto">
                            <div id="summary-card" className="bg-[#E0F2F1] border-[3px] border-black p-5 w-full max-w-sm shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)] my-auto">
                                <h1 className="text-xl font-black border-b-4 border-black mb-5 pb-1 uppercase italic">MISSION CLEAR</h1>
                                <div className="space-y-4">
                                    {Object.entries(logs.reduce((acc, l) => {
                                        const d = l.endTime ? (l.endTime - l.startTime) / 60000 : 0;
                                        if (d > 0) acc[l.activityName] = (acc[l.activityName] || 0) + d;
                                        return acc;
                                    }, {})).sort((a,b)=>b[1]-a[1]).map(([n, t]) => (
                                        <div key={n}>
                                            <div className="flex justify-between text-[10px] font-bold mb-1 uppercase"><span>{n}</span><span>{Math.round(t)} MIN</span></div>
                                            <div className="h-3 bg-white border-2 border-black relative overflow-hidden"><div className="h-full bg-[#6D83F2] border-r-2 border-black" style={{ width: `${Math.min(100, (t / 300) * 100)}%` }}></div></div>
                                        </div>
                                    ))}
                                    <div className="border-2 border-black bg-white/50 p-2.5 mt-2">
                                        <p className="text-[9px] font-bold opacity-70 mb-1 uppercase flex items-center gap-1">{PIXEL_ICONS.sparkles} Master's Advice</p>
                                        {aiAdvice ? <p className="text-[10px] italic leading-tight typing-effect">{aiAdvice}</p> : isAiThinking ? <div className="animate-pulse text-[9px]">...</div> : <button onClick={askGemini} className="w-full py-1.5 bg-black text-white text-[9px] font-bold">✨ AI 深度分析 ✨</button>}
                                    </div>
                                    <div className="pt-3 border-t-2 border-black flex justify-between items-end">
                                        <div><p className="text-[9px] font-bold uppercase text-black/50 leading-none">Total XP</p><p className="text-3xl font-black text-black leading-none mt-1">{Math.round(logs.reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0</p></div>
                                        <p className="text-[9px] font-bold opacity-30 italic">{new Date().toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-8 flex gap-3 w-full max-w-sm">
                                <button onClick={() => {setShowSummary(false); setAiAdvice("");}} className="flex-1 bg-white border-2 border-black py-2.5 text-xs font-bold pixel-shadow-sm pixel-btn">关闭</button>
                                <button onClick={() => {
                                    const el = document.getElementById('summary-card');
                                    window.html2canvas(el, { backgroundColor: '#E0F2F1', scale: 2 }).then(canvas => {
                                        const link = document.createElement('a'); link.download = "quest.png"; link.href = canvas.toDataURL(); link.click();
                                    });
                                }} className="flex-1 bg-[#6D83F2] text-white border-2 border-black py-2.5 text-xs font-bold pixel-shadow-sm pixel-btn">保存图片</button>
                            </div>
                        </div>
                    )}

                    {/* 新增分类 */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-white pixel-border p-5 w-full max-w-xs pixel-shadow">
                                <h2 className="font-bold text-base border-b-2 border-black mb-4 pb-1 uppercase italic tracking-tighter">New Quest</h2>
                                <div className="space-y-4 text-xs">
                                    <input type="text" placeholder="名称..." className="w-full pixel-border p-2.5 outline-none font-bold focus:bg-blue-50" value={newActForm.name} onChange={e => setNewActForm({...newActForm, name: e.target.value})} />
                                    <select className="w-full pixel-border p-2.5 outline-none font-bold bg-white" value={newActForm.parentId} onChange={e => setNewActForm({...newActForm, parentId: e.target.value})}>
                                        <option value="">顶级分类</option>
                                        {activities.filter(a => !a.parentId).map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <div className="grid grid-cols-5 gap-1.5 h-24 overflow-y-auto p-1.5 pixel-border bg-gray-50 no-scrollbar text-black">
                                        {Object.keys(PIXEL_ICONS).filter(k => !['back','chevronDown','sparkles','trash','plus','stop'].includes(k)).map(k => <button key={k} onClick={() => setNewActForm({...newActForm, icon: k})} className={`flex items-center justify-center p-1.5 border-2 ${newActForm.icon === k ? 'bg-[#6D83F2] border-black text-white' : 'border-transparent'}`}>{PIXEL_ICONS[k]}</button>)}
                                    </div>
                                </div>
                                <div className="flex gap-2.5 mt-6">
                                    <button onClick={() => setShowAddModal(false)} className="flex-1 pixel-border p-2.5 text-xs font-bold active:bg-gray-50">取消</button>
                                    <button onClick={() => { if(!newActForm.name) return; setActivities([...activities, {id: Math.random().toString(36).substr(2,9), ...newActForm, parentId: newActForm.parentId || null}]); setShowAddModal(false); setNewActForm({name:'', icon:'zap', parentId:''}); }} className="flex-1 bg-black text-white p-2.5 text-xs font-bold active:bg-gray-800">保存</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
