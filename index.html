<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êó∂Èó¥ÊçïÊâã TimeCatcher V3.1</title>
    
    <!-- Ê†∏ÂøÉËµÑÊ∫êÔºöTailwindCSS, html2canvas, React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ÂÉèÁ¥†ÂõæÊ†áÂ∫ì - ‰∏âÈáçÂ§áÈÄâ CDN Á°Æ‰øùÂõæÊ†á‰∏ÄÂÆöËÉΩÂä†ËΩΩ -->
    <link id="pixel-css-1" href="https://cdn.jsdelivr.net/npm/pixelarticons@1.8.1/css/pixelarticons.css" rel="stylesheet">
    <link id="pixel-css-2" href="https://unpkg.com/pixelarticons@1.8.1/css/pixelarticons.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        :root {
            --pixel-bg: #E0F2F1;
            --pixel-blue: #6D83F2;
            --pixel-red: #E57373;
        }

        body {
            font-family: 'DotGothic16', 'Courier New', monospace;
            background-color: #cedede;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .pixel-border { border: 2px solid black; }
        .pixel-shadow { box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .pixel-shadow-sm { box-shadow: 2px 2px 0px 0px rgba(0,0,0,1); }
        
        .pixel-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .pa {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25em;
            height: 1.25em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // ÂõæÊ†áÂä†ËΩΩÂ§±Ë¥•Êó∂ÁöÑ‰øùÂ∫ï Emoji
        const EMOJI_MAP = {
            'briefcase': 'üíº', 'code': 'üíª', 'users': 'üë•', 'book-open': 'üìñ',
            'book': 'üìö', 'heart': '‚ù§Ô∏è', 'device-mobile': 'üì±', 'sleep': 'üåô',
            'coffee': '‚òï', 'microphone': 'üéôÔ∏è', 'chevron-down': '‚ñº', 'chevron-left': '‚óÄ',
            'close-circle': '‚ùå', 'plus': 'Ôºã', 'gear': '‚öôÔ∏è', 'file': 'üìÑ', 'calendar': 'üìÖ',
            'zap': '‚ö°', 'check': '‚úÖ', 'trash': 'üóëÔ∏è', 'image': 'üñºÔ∏è'
        };

        const App = () => {
            // --- Áä∂ÊÄÅÂàùÂßãÂåñ ---
            const [activities, setActivities] = useState(() => {
                const saved = localStorage.getItem('tc_activities_v3');
                return saved ? JSON.parse(saved) : [
                    { id: '1', name: 'Â∑•‰Ωú', icon: 'briefcase', parentId: null },
                    { id: '2', name: 'ÂÜô‰ª£Á†Å', icon: 'code', parentId: '1' },
                    { id: '3', name: 'ÂºÄ‰ºö', icon: 'users', parentId: '1' },
                    { id: '4', name: 'Â≠¶‰π†', icon: 'book', parentId: null },
                    { id: '5', name: 'ËØª‰π¶', icon: 'book-open', parentId: '4' },
                    { id: '6', name: 'ÂÜ•ÊÉ≥', icon: 'heart', parentId: null },
                    { id: '7', name: 'Áé©ÊâãÊú∫', icon: 'device-mobile', parentId: null },
                    { id: '8', name: 'Áù°Ëßâ', icon: 'sleep', parentId: null }
                ];
            });

            const [logs, setLogs] = useState(() => {
                const saved = localStorage.getItem('tc_logs_v3');
                return saved ? JSON.parse(saved) : [];
            });

            const [currentParentId, setCurrentParentId] = useState(null);
            const [isManageMode, setIsManageMode] = useState(false);
            const [isOpen, setIsOpen] = useState(true);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [iconsLoaded, setIconsLoaded] = useState(true);
            const [newAct, setNewAct] = useState({ name: '', icon: 'zap', parentId: '' });

            // --- Êï∞ÊçÆÊåÅ‰πÖÂåñ ---
            useEffect(() => {
                localStorage.setItem('tc_activities_v3', JSON.stringify(activities));
            }, [activities]);

            useEffect(() => {
                localStorage.setItem('tc_logs_v3', JSON.stringify(logs));
            }, [logs]);

            // --- ÂõæÊ†áÂèØÁî®ÊÄßÊ£ÄÊµã ---
            useEffect(() => {
                const checkIcons = () => {
                    const span = document.createElement('span');
                    span.className = 'pa pa-briefcase';
                    span.style.position = 'absolute';
                    span.style.visibility = 'hidden';
                    document.body.appendChild(span);
                    if (span.offsetWidth === 0) setIconsLoaded(false);
                    document.body.removeChild(span);
                };
                setTimeout(checkIcons, 1500);
            }, []);

            // --- Ê†∏ÂøÉÈÄªËæë ---
            const triggerVibrate = () => { if (window.navigator?.vibrate) window.navigator.vibrate(50); };
            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);

            const startActivity = useCallback((id) => {
                const activity = activities.find(a => a.id === id);
                if (!activity) return;

                triggerVibrate();
                const now = Date.now();
                
                setLogs(prev => {
                    const newLogs = [...prev];
                    const activeIndex = newLogs.findIndex(l => l.endTime === null);
                    if (activeIndex !== -1) {
                        newLogs[activeIndex].endTime = now;
                    }
                    newLogs.push({
                        id: (Math.random() * 10000).toString(36),
                        activityId: activity.id,
                        activityName: activity.name,
                        startTime: now,
                        endTime: null
                    });
                    return newLogs;
                });
                setIsOpen(false);
            }, [activities]);

            const handleActivityClick = (activity) => {
                if (isManageMode) return;
                const children = activities.filter(a => a.parentId === activity.id);
                if (children.length > 0) {
                    setCurrentParentId(activity.id);
                    triggerVibrate();
                } else {
                    startActivity(activity.id);
                }
            };

            // --- ÂØºÂá∫ÂäüËÉΩ (ÂÖ®Èù¢Ë°•ÂÖ®) ---

            const exportCSV = () => {
                if (logs.length === 0) return alert("ÊöÇÊó†ËÆ∞ÂΩïÂèØÂØºÂá∫");
                let csv = "\ufeffÊ¥ªÂä®ÂêçÁß∞,ÂºÄÂßãÊó∂Èó¥,ÁªìÊùüÊó∂Èó¥,Êó∂Èïø(ÂàÜÈíü)\n";
                logs.forEach(l => {
                    const dur = l.endTime ? Math.round((l.endTime - l.startTime) / 60000) : 0;
                    csv += `"${l.activityName}","${new Date(l.startTime).toLocaleString()}","${l.endTime ? new Date(l.endTime).toLocaleString() : 'ËøõË°å‰∏≠'}",${dur}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Êó∂Èó¥ÊçïÊâãË¥¶Âçï_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            const exportICS = () => {
                if (logs.length === 0) return alert("ÊöÇÊó†Êï∞ÊçÆ");
                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\n";
                logs.forEach(l => {
                    if (!l.endTime) return;
                    const fmt = (ts) => new Date(ts).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    ics += `BEGIN:VEVENT\nSUMMARY:${l.activityName}\nDTSTART:${fmt(l.startTime)}\nDTEND:${fmt(l.endTime)}\nEND:VEVENT\n`;
                });
                ics += "END:VCALENDAR";
                const blob = new Blob([ics], { type: 'text/calendar' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "timecatcher_sync.ics";
                link.click();
            };

            const startVoice = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("ÊµèËßàÂô®ÊöÇ‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´");
                const rec = new Speech();
                rec.lang = 'zh-CN';
                setIsListening(true);
                rec.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    const match = activities.find(a => text.includes(a.name));
                    if (match) handleActivityClick(match);
                };
                rec.onend = () => setIsListening(false);
                rec.start();
            };

            const saveAsImage = () => {
                const el = document.getElementById('summary-card');
                if (!window.html2canvas) return alert("ÂõæÁâáÂ∫ìÂ∞öÊú™Âä†ËΩΩÂÆåÊØï");
                window.html2canvas(el, { backgroundColor: '#E0F2F1', scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL();
                    link.download = `‰ªäÊó•ÊàêÂ∞±_${new Date().toLocaleDateString()}.png`;
                    link.click();
                });
            };

            const getIcon = (name) => {
                if (iconsLoaded) return <i className={`pa pa-${name} text-xl`}></i>;
                return <span className="text-xl leading-none">{EMOJI_MAP[name] || 'üìç'}</span>;
            };

            const displayedActivities = activities.filter(a => a.parentId === currentParentId);

            return (
                <div className="min-h-screen bg-[#cedede] font-mono text-[#2D3436] select-none">
                    
                    {/* È°∂ÈÉ®ÊÇ¨ÊµÆÊéßÂà∂Âè∞ (Top Console) */}
                    <div 
                        className={`fixed top-0 left-1/2 -translate-x-1/2 w-[94%] bg-[#E0F2F1] pixel-border pixel-shadow z-50 transition-all duration-300 ${isOpen ? 'translate-y-2' : '-translate-y-[85%]'}`}
                        style={{ maxHeight: '48vh' }}
                    >
                        {/* Áä∂ÊÄÅÊ†è */}
                        <div className="p-4 flex justify-between items-center border-b-2 border-black bg-white/40">
                            <div>
                                <p className="text-[10px] opacity-50 font-bold uppercase tracking-widest">Active Now</p>
                                <h2 className="font-bold text-lg leading-tight">{currentLog ? currentLog.activityName : 'Á≠âÂæÖ‰∏≠...'}</h2>
                                {currentLog && (
                                    <p className="text-[10px] text-blue-600 font-bold mt-1 uppercase italic">
                                        Started {new Date(currentLog.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </p>
                                )}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={startVoice} className={`w-11 h-11 bg-white pixel-border pixel-shadow-sm pixel-btn flex items-center justify-center ${isListening ? 'bg-red-500 animate-pulse text-white' : ''}`}>
                                    {getIcon('microphone')}
                                </button>
                                <button onClick={() => { setIsManageMode(!isManageMode); triggerVibrate(); }} className={`w-11 h-11 pixel-border pixel-shadow-sm pixel-btn flex items-center justify-center ${isManageMode ? 'bg-[#E57373]' : 'bg-white'}`}>
                                    {getIcon('gear')}
                                </button>
                            </div>
                        </div>

                        {/* Ê¥ªÂä®ÁΩëÊ†ºÂÆπÂô® */}
                        <div className="p-4 overflow-y-auto max-h-[32vh] no-scrollbar">
                            {currentParentId && (
                                <button onClick={() => setCurrentParentId(null)} className="mb-4 text-xs font-bold border-b-2 border-black pb-1 italic flex items-center gap-1">
                                    {getIcon('chevron-left')} ËøîÂõû
                                </button>
                            )}
                            <div className="grid grid-cols-1 gap-3">
                                {displayedActivities.map(act => {
                                    const hasChildren = activities.some(a => a.parentId === act.id);
                                    return (
                                        <div 
                                            key={act.id} 
                                            onClick={() => handleActivityClick(act)} 
                                            className="bg-white pixel-border p-4 pixel-shadow-sm pixel-btn flex justify-between items-center cursor-pointer"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className="w-6 flex justify-center">{getIcon(act.icon)}</div>
                                                <span className="font-bold text-sm tracking-tight">{act.name}</span>
                                            </div>
                                            <div className="flex items-center">
                                                {isManageMode ? (
                                                    <button onClick={(e) => {e.stopPropagation(); if(confirm('Âà†Èô§ÂêóÔºü')) setActivities(prev => prev.filter(a => a.id !== act.id && a.parentId !== act.id))}} className="text-[#E57373] p-1">
                                                        {getIcon('trash')}
                                                    </button>
                                                ) : (
                                                    hasChildren && <div className="opacity-30">{getIcon('chevron-down')}</div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                                {isManageMode && (
                                    <button onClick={() => setShowAddModal(true)} className="border-2 border-dashed border-gray-400 p-4 flex items-center justify-center gap-2 text-gray-400 text-xs font-bold uppercase">
                                        {getIcon('plus')} Add New Category
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Â∫ïÈÉ®ÂäüËÉΩÊù° - ÊâÄÊúâÁöÑÂØºÂá∫ÂäüËÉΩÈÉΩÂú®Ëøô */}
                        <div className="p-3 border-t-2 border-black flex justify-around bg-white/20 text-[10px] font-bold uppercase tracking-tighter">
                            <button onClick={() => {setShowSummary(true); triggerVibrate()}} className="hover:underline">‰ªäÊó•ÊÄªÁªì</button>
                            <button onClick={exportCSV} className="hover:underline">ExcelÂØºÂá∫</button>
                            <button onClick={exportICS} className="hover:underline">Êó•ÂéÜÂêåÊ≠•</button>
                        </div>
                        <div onClick={() => setIsOpen(!isOpen)} className="h-6 flex items-center justify-center cursor-pointer group">
                            <div className="w-14 h-1 bg-black/10 group-hover:bg-black/20 rounded-full transition-all"></div>
                        </div>
                    </div>

                    {/* ÁÇπÂáªËÉåÊôØÈÅÆÁΩ© */}
                    {isOpen && <div className="fixed inset-0 bg-black/30 backdrop-blur-[1px] z-40" onClick={() => setIsOpen(false)}></div>}

                    {/* ‰ªäÊó•ÊÄªÁªìÂç°ÁâáÂºπÁ™ó */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
                            <div id="summary-card" className="bg-[#E0F2F1] border-[3px] border-black p-6 w-full max-w-sm shadow-[10px_10px_0px_0px_rgba(0,0,0,0.5)]">
                                <h1 className="text-2xl font-black italic border-b-4 border-black mb-6 pb-1 uppercase italic tracking-tighter">Daily Cleared!</h1>
                                <div className="space-y-6">
                                    {Object.entries(logs.reduce((acc, l) => {
                                        const duration = l.endTime ? (l.endTime - l.startTime) / 60000 : 0;
                                        if (duration > 0) acc[l.activityName] = (acc[l.activityName] || 0) + duration;
                                        return acc;
                                    }, {})).length === 0 ? (
                                        <p className="py-10 text-center font-bold opacity-30 italic">No energy spent today...</p>
                                    ) : (
                                        Object.entries(logs.reduce((acc, l) => {
                                            const duration = l.endTime ? (l.endTime - l.startTime) / 60000 : 0;
                                            if (duration > 0) acc[l.activityName] = (acc[l.activityName] || 0) + duration;
                                            return acc;
                                        }, {})).sort((a,b)=>b[1]-a[1]).map(([name, time]) => (
                                            <div key={name}>
                                                <div className="flex justify-between text-[11px] font-bold mb-1.5 uppercase tracking-tighter">
                                                    <span>{name}</span>
                                                    <span>{Math.round(time)} MIN</span>
                                                </div>
                                                <div className="h-4 bg-white border-2 border-black relative overflow-hidden">
                                                    <div className="h-full bg-[#6D83F2] border-r-2 border-black" style={{ width: `${Math.min(100, (time / 300) * 100)}%` }}></div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                    <div className="pt-6 border-t-2 border-black flex justify-between items-end">
                                        <div>
                                            <p className="text-[10px] opacity-60 font-bold uppercase tracking-widest leading-none">Total XP gained</p>
                                            <p className="text-5xl font-black leading-none mt-1">
                                                {Math.round(logs.reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[10px] font-bold opacity-40">{new Date().toLocaleDateString()}</p>
                                            <p className="text-[8px] font-black uppercase opacity-60">Time Catcher V3.1</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-10 flex gap-4">
                                <button onClick={() => setShowSummary(false)} className="bg-white border-2 border-black px-8 py-3 text-xs font-bold pixel-shadow-sm pixel-btn">ÂÖ≥Èó≠</button>
                                <button onClick={saveAsImage} className="bg-[#6D83F2] text-white border-2 border-black px-8 py-3 text-xs font-bold pixel-shadow-sm pixel-btn">‰øùÂ≠òÂõæÁâá</button>
                            </div>
                        </div>
                    )}

                    {/* Êñ∞Â¢ûÂàÜÁ±ªÂºπÁ™ó */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-white pixel-border p-6 w-full max-w-xs pixel-shadow">
                                <h2 className="font-bold text-lg border-b-2 border-black mb-6 pb-1 uppercase tracking-tighter italic italic">New Activity</h2>
                                <div className="space-y-5 text-sm">
                                    <input type="text" placeholder="Name..." className="w-full pixel-border p-3 outline-none font-bold" value={newAct.name} onChange={e => setNewAct({...newAct, name: e.target.value})} />
                                    <select className="w-full pixel-border p-3 outline-none font-bold bg-white" value={newAct.parentId} onChange={e => setNewAct({...newAct, parentId: e.target.value})}>
                                        <option value="">È°∂Á∫ßÂàÜÁ±ª</option>
                                        {activities.filter(a => !a.parentId).map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <div className="grid grid-cols-5 gap-2 h-24 overflow-y-auto p-2 pixel-border bg-gray-50 no-scrollbar">
                                        {Object.keys(EMOJI_MAP).map(k => <button key={k} onClick={() => setNewAct({...newAct, icon: k})} className={`flex items-center justify-center p-2 border-2 ${newAct.icon === k ? 'bg-[#6D83F2] border-black text-white' : 'border-transparent hover:bg-gray-200'}`}>{EMOJI_MAP[k]}</button>)}
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setShowAddModal(false)} className="flex-1 pixel-border p-3 text-xs font-bold">ÂèñÊ∂à</button>
                                    <button onClick={() => { if(!newAct.name) return; setActivities([...activities, {id: Math.random().toString(36).substr(2,9), ...newAct, parentId: newAct.parentId || null}]); setShowAddModal(false); setNewAct({name:'', icon:'zap', parentId:''}); triggerVibrate(); }} className="flex-1 bg-black text-white p-3 text-xs font-bold">‰øùÂ≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
