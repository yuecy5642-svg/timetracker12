<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êó∂Èó¥ÊçïÊâã TimeCatcher 2.3 Final Fixed</title>
    
    <!-- Ê†∏ÂøÉËµÑÊ∫ê -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Silkscreen:wght@400;700&display=swap');
        
        :root {
            --p-red: #FF3B30;
            --p-blue: #6D83F2;
            --p-yellow: #FFD60A;
            --p-bg: #E0F2F1;
            --p-green: #4CD964;
        }

        body {
            font-family: 'DotGothic16', 'Silkscreen', 'Courier New', Courier, monospace;
            background-color: var(--p-bg);
            margin: 0;
            position: fixed;
            inset: 0;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .pixel-border { border: 3px solid black; }
        .pixel-shadow { box-shadow: 5px 5px 0px 0px rgba(0,0,0,1); }
        
        .pixel-btn-flat:active {
            transform: translate(2px, 2px);
            background-color: #f8fafc;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .banner-active { animation: pulse-bg 2.5s infinite; }
        @keyframes pulse-bg {
            0%, 100% { background-color: white; }
            50% { background-color: #fffde7; }
        }

        .icon-svg { fill: currentColor; width: 20px; height: 20px; }
        
        #root { height: 100%; width: 100%; }

        .mic-active {
            animation: mic-pulse 0.8s infinite;
            background-color: var(--p-red) !important;
            color: white !important;
        }
        @keyframes mic-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.92); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Êà™Âõæ‰∏ìÁî® */
        .hide-in-capture { display: flex; }
        .is-capturing .hide-in-capture { display: none !important; }

        /* ‰øÆÂ§çÊó•ÊúüËæìÂÖ•Ê°ÜÂú® iOS ‰∏äÁöÑÈªòËÆ§Ê†∑Âºè */
        input[type="date"] {
            -webkit-appearance: none;
            min-width: 0; 
            background-color: white;
            display: block; /* Âº∫Âà∂ÂùóÁ∫ßÊòæÁ§∫ */
            width: 100%;
            padding-top: 8px; /* Â¢ûÂä†ÁÇπÂáªÂå∫Âüü */
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PIXEL_ICONS = {
            stop: <svg className="icon-svg text-red-600" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>,
            gear: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm6 2l1.4 1.4-2.8 2.8-1.4-1.4L17 4zM7 4L5.6 5.4l2.8 2.8 1.4-1.4L7 4zm13 7v2h-4v-2h4zM8 11v2H4v-2h4zm9 8l-1.4 1.4-2.8-2.8 1.4-1.4 2.8 2.8zM7 19l1.4-1.4 2.8 2.8-1.4 1.4L7 19zm4 1h2v4h-2v-4zm1-11a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>,
            play: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>,
            back: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M10 4v2H8v2H6v2H4v4h2v2h2v2h2v2h2v-4h-2v-2h-2v-4h2V8h2V4h-2zM12 10h8v4h-8v-4z"/></svg>,
            plus: <svg className="icon-svg" viewBox="0 0 24 24"><path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z"/></svg>,
            folder: <svg className="w-3 h-3 opacity-40" viewBox="0 0 24 24"><path d="M2 4h8l2 2h10v14H2V4zm2 4v10h16V8H4z"/></svg>,
            trash: <svg className="w-4 h-4 text-white" viewBox="0 0 24 24"><path d="M9 2h6v2H9V2zM5 4h14v2H5V4zm2 2h10v14H7V6zm2 2v10h2V8H9zm4 0v10h2V8h-2z"/></svg>,
            edit: <svg className="w-4 h-4 text-black" viewBox="0 0 24 24"><path d="M14 2h2v2h-2V2zM12 4h2v2h-2V4zm-2 2h2v2h-2V6zm-2 2h2v2H8V8zm-2 2h2v2H6v-2zm-2 2h2v2H4v-2zm0 2h2v2H4v-2zm0 2h2v2H4v-2zm0 2h2v2H4v-2zm2 2h2v2H6v-2zm2 2h2v2H8v-2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2zm2-2h2v-2h-2v2z"/></svg>,
            up: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M11 6h2v2h-2V6zm-2 2h2v2H9V8zm6 0h2v2h-2V8zm-8 2h2v2H7v-2zm10 0h2v2h-2v-2zm-12 2h2v6h-2v-6zm14 0h2v6h-2v-6zm14 0h2v6h-2v-6z"/></svg>,
            down: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M8 6h8v2H8V6zm-1 2h2v6H7V8zm10 0h2v6h-2V8zm-8 6h2v2H9v-2zm6 0h2v2h-2v-2zm-4 2h2v2h-2v-2z"/></svg>,
            save: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>,
            cal: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>,
            clear: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>,
            mic: <svg className="icon-svg text-black" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>,
            csv: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>,
            target: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>,
            chart: <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>,
            snow: <svg className="w-3 h-3" viewBox="0 0 24 24"><path d="M12 2L12 22 M2 12L22 12 M4.9 4.9L19.1 19.1 M4.9 19.1L19.1 4.9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" /></svg>
        };

        const COMMON_EMOJIS = ["‚öîÔ∏è", "üíª", "üìñ", "üìù", "üß†", "üî•", "üöÄ", "üí°", "üõ†Ô∏è", "üéØ", "üí™", "üßò", "üèÉ", "üö∂", "üö¥", "üèä", "üèÄ", "‚öΩ", "ü•ä", "üîã", "üßπ", "üç≥", "‚òï", "üöø", "üß∫", "üè†", "ü™¥", "üõå", "üåô", "üß¥", "üì±", "üéÆ", "üéß", "üé¨", "üé®", "üì∏", "üé∏", "üé§", "üçø", "üçé", "ü•ó", "üçï", "üçî", "üç¶", "üç∫", "üç∑", "ü•Ç", "üçµ", "üç±", "üåç", "üåä", "üå≤", "üå∏", "‚òÄÔ∏è", "üöó", "‚úàÔ∏è", "üó∫Ô∏è", "üêï", "üêà"];

        const App = () => {
            const [activities, setActivities] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('tc_v10_17_acts') || '[]');
                if (saved.length === 0) {
                    return [
                        { id: '1', name: 'Ê∑±Â∫¶Â∑•‰Ωú', emoji: '‚öîÔ∏è', parentId: null, nature: 'positive' },
                        { id: '2', name: 'ÂÜô‰ª£Á†Å', emoji: 'üíª', parentId: '1', nature: 'positive' },
                        { id: '3', name: 'ÂºÄ‰ºö', emoji: 'üë•', parentId: '1', nature: 'neutral' },
                        { id: '4', name: 'ÊäÄËÉΩÂ≠¶‰π†', emoji: 'üìñ', parentId: null, nature: 'positive' },
                        { id: '5', name: 'ËØª‰π¶', emoji: 'üìö', parentId: '4', nature: 'positive' },
                        { id: '6', name: '‰ΩìÂäõÈîªÁÇº', emoji: 'üí™', parentId: null, nature: 'positive' }
                    ];
                }
                // ÊÅ¢Â§çÔºöÊóßÊï∞ÊçÆËøÅÁßªÊó∂ÔºåÈªòËÆ§Ë°•ÂÖ®‰∏∫ neutralÔºå‰∏çÂº∫Âà∂ËΩ¨ positiveÔºå‰øùÊä§ÂéüÊúâÈÄªËæë
                return saved.map(a => ({ nature: 'neutral', ...a })); 
            });

            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('tc_v10_17_logs') || '[]'));
            const [customGoals, setCustomGoals] = useState(() => JSON.parse(localStorage.getItem('tc_v2_custom_goals') || '[]'));
            // Êñ∞Â¢ûÔºöÊöÇÂÅúËÆ∞ÂΩïÁä∂ÊÄÅ (TC v2.1)
            const [dailyPauses, setDailyPauses] = useState(() => JSON.parse(localStorage.getItem('tc_v2_pauses') || '[]'));
            
            const [currentParentId, setCurrentParentId] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [showCalendar, setShowCalendar] = useState(false);
            const [showGoalModal, setShowGoalModal] = useState(false);
            const [goalTab, setGoalTab] = useState('active'); 
            
            const [showStatsModal, setShowStatsModal] = useState(false);
            const [statsTab, setStatsTab] = useState('overview'); 
            const [insightDrillId, setInsightDrillId] = useState(null);
            const [pkDrillId, setPkDrillId] = useState(null);
            
            const [statsDateRange, setStatsDateRange] = useState({
                start: new Date().toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            });
            const [compareDateRange, setCompareDateRange] = useState({
                startA: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                endA: new Date().toISOString().split('T')[0],
                startB: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                endB: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
            });

            const [selectedDate, setSelectedDate] = useState(new Date());
            const [backupString, setBackupString] = useState('');
            const [isCapturing, setIsCapturing] = useState(false); 
            const [activeEditId, setActiveEditId] = useState(null);
            
            // ÊÅ¢Â§çÔºöÊñ∞Âª∫Ê¥ªÂä®ÈªòËÆ§Â±ûÊÄßÊîπÂõû neutral
            const [formData, setFormData] = useState({ name: '', emoji: 'üìç', parentId: '', dailyGoal: 0, nature: 'neutral' });
            
            // Ëá™ÂÆö‰πâÊåëÊàòÂ¢ûÂä† isNegativeOverride
            const [newGoalData, setNewGoalData] = useState(() => {
                const today = new Date().toISOString().split('T')[0];
                return { activityId: '', startDate: today, endDate: today, targetMinutes: '', isNegativeOverride: false };
            });
            const [newDailyData, setNewDailyData] = useState({ activityId: '', targetMinutes: '' });
            
            const [archiveFilters, setArchiveFilters] = useState({
                type: 'custom', 
                startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0], 
                endDate: new Date().toISOString().split('T')[0]
            });

            const [msg, setMsg] = useState({ show: false, text: '', type: 'info' });
            
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            const [itemDeleteConfirmId, setItemDeleteConfirmId] = useState(null);
            const [logDeleteConfirmId, setLogDeleteConfirmId] = useState(null);
            const [challengeDeleteConfirmId, setChallengeDeleteConfirmId] = useState(null);

            const [isDeleteMode, setIsDeleteMode] = useState(false);
            const [isRestoreMode, setIsRestoreMode] = useState(false);
            const [restoreInputValue, setRestoreInputValue] = useState('');

            const recognitionRef = useRef(null);
            const activitiesRef = useRef(activities);

            const showMsg = (text, type = 'info') => {
                setMsg({ show: true, text, type });
                setTimeout(() => setMsg(prev => ({ ...prev, show: false })), 4000);
            };

            useEffect(() => {
                activitiesRef.current = activities;
                localStorage.setItem('tc_v10_17_acts', JSON.stringify(activities));
                localStorage.setItem('tc_v10_17_logs', JSON.stringify(logs));
                localStorage.setItem('tc_v2_custom_goals', JSON.stringify(customGoals));
                localStorage.setItem('tc_v2_pauses', JSON.stringify(dailyPauses));
            }, [activities, logs, customGoals, dailyPauses]);

            const currentLog = useMemo(() => logs.find(l => l.endTime === null) || null, [logs]);
            const currentEmoji = useMemo(() => activities.find(a => a.name === currentLog?.activityName)?.emoji || 'üßä', [currentLog, activities]);

            const triggerVibrate = (ms = 50) => {
                if (window.navigator?.vibrate) window.navigator.vibrate(ms);
            };

            const stopCurrent = () => {
                if (!currentLog) return;
                triggerVibrate();
                setLogs(prev => prev.map(l => l.endTime === null ? { ...l, endTime: Date.now() } : l));
            };

            const getTodayProgress = (act) => {
                const selfAndChildren = [act];
                const children = activities.filter(a => a.parentId === act.id);
                children.forEach(c => selfAndChildren.push(c));
                const targetNames = selfAndChildren.map(a => a.name);

                const today = new Date();
                const todayLogs = logs.filter(l => {
                    const d = new Date(l.endTime || l.startTime);
                    return d.getDate() === today.getDate() && 
                           d.getMonth() === today.getMonth() && 
                           d.getFullYear() === today.getFullYear();
                });

                const totalMs = todayLogs.reduce((acc, l) => {
                    if (targetNames.includes(l.activityName)) {
                        const end = l.endTime || Date.now();
                        return acc + (end - l.startTime);
                    }
                    return acc;
                }, 0);

                return Math.round(totalMs / 60000);
            };

            const getRangeProgress = (actId, startStr, endStr) => {
                const activityObj = activities.find(a => a.id === actId);
                if (!activityObj) return 0;

                const selfAndChildren = [activityObj];
                const children = activities.filter(a => a.parentId === actId);
                children.forEach(c => selfAndChildren.push(c));
                const targetNames = selfAndChildren.map(a => a.name);

                const parseLocalStart = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
                };
                const parseLocalEnd = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
                };

                const start = parseLocalStart(startStr);
                const end = parseLocalEnd(endStr);

                const rangeLogs = logs.filter(l => {
                    const logEnd = l.endTime || Date.now(); 
                    return logEnd >= start && l.startTime <= end;
                });

                const totalMs = rangeLogs.reduce((acc, l) => {
                    if (targetNames.includes(l.activityName)) {
                        const logEnd = l.endTime || Date.now();
                        const effectiveStart = Math.max(l.startTime, start);
                        const effectiveEnd = Math.min(logEnd, end);
                        if (effectiveEnd > effectiveStart) {
                            return acc + (effectiveEnd - effectiveStart);
                        }
                    }
                    return acc;
                }, 0);

                return Math.round(totalMs / 60000);
            };

            const getStrictProgress = (actName, startStr, endStr) => {
                const parseLocalStart = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
                };
                const parseLocalEnd = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
                };

                const start = parseLocalStart(startStr);
                const end = parseLocalEnd(endStr);

                const rangeLogs = logs.filter(l => {
                    const logEnd = l.endTime || Date.now(); 
                    return logEnd >= start && l.startTime <= end;
                });

                const totalMs = rangeLogs.reduce((acc, l) => {
                    if (l.activityName === actName) { 
                        const logEnd = l.endTime || Date.now();
                        const effectiveStart = Math.max(l.startTime, start);
                        const effectiveEnd = Math.min(logEnd, end);
                        if (effectiveEnd > effectiveStart) {
                            return acc + (effectiveEnd - effectiveStart);
                        }
                    }
                    return acc;
                }, 0);

                return Math.round(totalMs / 60000);
            };

            // ÁªüËÆ°ÂøÉËÑèÈáçÊûÑ (Algorithm Engine) v2.2 - with Score Accumulation
            const calculateStats = (startStr, endStr) => {
                const parseLocalStart = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
                };
                const parseLocalEnd = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
                };

                const start = parseLocalStart(startStr);
                const end = parseLocalEnd(endStr);

                const validLogs = logs.filter(l => {
                    const logEnd = l.endTime || Date.now();
                    return l.endTime && logEnd >= start && l.startTime <= end;
                });

                let totalPeriodMins = 0;
                let netScore = 0; 
                // Map to store aggregation. Key: Activity ID
                const statsMap = new Map(); 

                validLogs.forEach(l => {
                    const logEnd = l.endTime || Date.now();
                    const effectiveStart = Math.max(l.startTime, start);
                    const effectiveEnd = Math.min(logEnd, end);
                    if (effectiveEnd <= effectiveStart) return;
                    
                    const durationMins = (effectiveEnd - effectiveStart) / 60000;
                    totalPeriodMins += durationMins;

                    let actDef = activities.find(a => a.name === l.activityName);
                    let logScore = 0;
                    
                    // ÂéüÂßãÂàÜÂÄºËÆ°ÁÆó (Item-level Score Calculation)
                    if (actDef) {
                        if (actDef.nature === 'positive') logScore = durationMins;
                        else if (actDef.nature === 'negative') logScore = -durationMins;
                    }
                    netScore += logScore; // Global Net Score

                    // Á°ÆÂÆö RootÔºåÂêåÊó∂Á¥ØËÆ° Root ÁöÑÂàÜÂÄº (Algebraic Sum)
                    let rootAct;
                    if (actDef) {
                        if (actDef.parentId) {
                            rootAct = activities.find(a => a.id === actDef.parentId);
                            if (!rootAct) rootAct = actDef; 
                        } else {
                            rootAct = actDef;
                        }
                    } else {
                        rootAct = {
                            id: `orphan-${l.activityName}`,
                            name: l.activityName,
                            emoji: l.activityEmoji || '‚ùì',
                            isOrphan: true,
                            nature: 'neutral'
                        };
                    }

                    const key = rootAct.id; 
                    if (!statsMap.has(key)) {
                        statsMap.set(key, { ...rootAct, mins: 0, score: 0 });
                    }
                    const entry = statsMap.get(key);
                    entry.mins += durationMins;
                    entry.score += logScore; // Parent itemScore accumulates all children's scores
                });

                const sortedStats = Array.from(statsMap.values()).sort((a, b) => b.mins - a.mins);

                return { totalPeriodMins, stats: sortedStats, netScore };
            };

            // Helper to get detailed stats for a drill-down list (scans logs directly for accuracy)
            const getDrillStats = (parentAct, startStr, endStr) => {
                const subActivities = activities.filter(a => a.parentId === parentAct.id);
                const drillList = [parentAct, ...subActivities];
                
                return drillList.map(item => {
                    // Use getStrictProgress logic but also calc score
                    const parseLocalStart = (s) => {
                        const [y, m, d] = s.split('-').map(Number);
                        return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
                    };
                    const parseLocalEnd = (s) => {
                        const [y, m, d] = s.split('-').map(Number);
                        return new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
                    };
                    const start = parseLocalStart(startStr);
                    const end = parseLocalEnd(endStr);

                    const rangeLogs = logs.filter(l => {
                        const logEnd = l.endTime || Date.now(); 
                        return logEnd >= start && l.startTime <= end && l.activityName === item.name;
                    });
                    
                    let mins = 0;
                    let score = 0;

                    rangeLogs.forEach(l => {
                        const logEnd = l.endTime || Date.now();
                        const effectiveStart = Math.max(l.startTime, start);
                        const effectiveEnd = Math.min(logEnd, end);
                        if (effectiveEnd > effectiveStart) {
                            const duration = (effectiveEnd - effectiveStart) / 60000;
                            mins += duration;
                            if (item.nature === 'positive') score += duration;
                            else if (item.nature === 'negative') score -= duration;
                        }
                    });

                    return { ...item, mins, score };
                }).sort((a, b) => b.mins - a.mins);
            };

            const isChallengeActive = (endDateStr) => {
                const [y, m, d] = endDateStr.split('-').map(Number);
                const endTime = new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
                return endTime >= Date.now();
            };

            const getChallengeStatus = (startStr, endStr) => {
                const now = Date.now();
                const [sy, sm, sd] = startStr.split('-').map(Number);
                const startTime = new Date(sy, sm - 1, sd, 0, 0, 0, 0).getTime();
                
                const [ey, em, ed] = endStr.split('-').map(Number);
                const endTime = new Date(ey, em - 1, ed, 23, 59, 59, 999).getTime();

                if (now < startTime) return 'upcoming';
                if (now > endTime) return 'ended';
                return 'active';
            };

            const togglePause = (activityId, dateStr) => {
                setDailyPauses(prev => {
                    const exists = prev.find(p => p.activityId === activityId && p.date === dateStr);
                    if (exists) {
                        return prev.filter(p => !(p.activityId === activityId && p.date === dateStr));
                    } else {
                        return [...prev, { activityId, date: dateStr }];
                    }
                });
                triggerVibrate(20);
            };

            const saveArchiveImage = () => {
                const card = document.getElementById('archive-capture-area');
                const parent = document.getElementById('goal-card');
                if (!card) return;
                
                const targetToCapture = document.getElementById('goal-card');
                
                setIsCapturing(true);
                setTimeout(() => {
                    html2canvas(targetToCapture, { 
                        backgroundColor: '#FFFFFF', 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true,
                        onclone: (clonedDoc) => {
                            const clonedCard = clonedDoc.getElementById('goal-card');
                            const scrollableContent = clonedDoc.getElementById('archive-capture-area');
                            
                            if (clonedCard) {
                                clonedCard.style.maxHeight = 'none';
                                clonedCard.style.height = 'auto';
                                clonedCard.style.overflow = 'visible';
                                clonedCard.style.display = 'block'; 
                                
                                const inputs = clonedCard.querySelectorAll('input');
                                inputs.forEach(input => {
                                    const div = clonedDoc.createElement('div');
                                    div.textContent = input.value; 
                                    div.className = input.className; 
                                    
                                    div.style.display = 'flex';            
                                    div.style.alignItems = 'center';       
                                    div.style.justifyContent = 'center';  
                                    div.style.height = 'auto';             
                                    div.style.minHeight = input.offsetHeight + 'px'; 
                                    div.style.padding = '4px 0';           
                                    div.style.fontFamily = 'Arial, sans-serif'; 
                                    div.style.lineHeight = '1.2';
                                    div.style.overflow = 'visible';
                                    
                                    if(input.parentNode) {
                                        input.parentNode.replaceChild(div, input);
                                    }
                                });

                                const bigNumbers = clonedCard.querySelectorAll('.text-5xl, .text-3xl, .text-xl');
                                bigNumbers.forEach(el => {
                                    el.style.fontFamily = 'Arial, sans-serif'; 
                                    el.style.lineHeight = '1.2'; 
                                    el.style.overflow = 'visible'; 
                                    el.style.paddingBottom = '5px'; 
                                });
                            }
                            if (scrollableContent) {
                                scrollableContent.style.maxHeight = 'none';
                                scrollableContent.style.height = 'auto';
                                scrollableContent.style.overflow = 'visible';
                            }
                            
                            const buttonsToHide = clonedCard.querySelectorAll('button, .hide-in-capture');
                            buttonsToHide.forEach(btn => btn.style.display = 'none');
                            
                            const truncatedElements = clonedCard.querySelectorAll('.truncate');
                            truncatedElements.forEach(el => {
                                el.style.overflow = 'visible'; 
                                el.style.whiteSpace = 'normal'; 
                                el.style.textOverflow = 'clip';
                                el.style.paddingBottom = '5px'; 
                            });
                        }
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `ÊåëÊàòÊÄªÁªì_${new Date().toLocaleDateString()}.png`;
                        link.click();
                        setIsCapturing(false);
                    }).catch(() => setIsCapturing(false));
                }, 200);
            };

            const saveStatsImage = () => {
                const targetToCapture = document.getElementById('stats-card'); 
                if (!targetToCapture) return;
                
                setIsCapturing(true);
                setTimeout(() => {
                    html2canvas(targetToCapture, { 
                        backgroundColor: '#FFFFFF', 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true,
                        onclone: (clonedDoc) => {
                            const clonedCard = clonedDoc.getElementById('stats-card');
                            
                            if (clonedCard) {
                                clonedCard.style.maxHeight = 'none';
                                clonedCard.style.height = 'auto';
                                clonedCard.style.overflow = 'visible';
                                clonedCard.style.display = 'block';

                                // ‰øÆÂ§çÔºö‰ΩøÁî® querySelectorAll Êü•ÊâæÊâÄÊúâÂ∏¶ÊªöÂä®Êù°ÁöÑÂÆπÂô®ÔºàÂåÖÊã¨ PK Ê®°Âºè‰∏ãÁöÑÂÜÖÈÉ®ÂàóË°®Ôºâ
                                const scrollables = clonedCard.querySelectorAll('.overflow-y-auto');
                                scrollables.forEach(el => {
                                    el.style.maxHeight = 'none';
                                    el.style.height = 'auto';
                                    el.style.overflow = 'visible';
                                });

                                const inputs = clonedCard.querySelectorAll('input');
                                inputs.forEach(input => {
                                    const div = clonedDoc.createElement('div');
                                    div.textContent = input.value;
                                    div.className = input.className;
                                    
                                    div.style.display = 'flex';
                                    div.style.alignItems = 'center';
                                    div.style.justifyContent = 'center';
                                    div.style.height = 'auto';
                                    div.style.minHeight = input.offsetHeight + 'px';
                                    div.style.padding = '4px 0';
                                    div.style.fontFamily = 'Arial, sans-serif';
                                    div.style.lineHeight = '1.2';
                                    div.style.overflow = 'visible';

                                    if(input.parentNode) {
                                        input.parentNode.replaceChild(div, input);
                                    }
                                });

                                const bigNumbers = clonedCard.querySelectorAll('.text-4xl, .text-2xl');
                                bigNumbers.forEach(el => {
                                    el.style.fontFamily = 'Arial, sans-serif';
                                    el.style.lineHeight = '1.2';
                                    el.style.overflow = 'visible';
                                    el.style.paddingBottom = '5px';
                                });
                            }
                            
                            const buttonsToHide = clonedCard.querySelectorAll('button, .hide-in-capture');
                            buttonsToHide.forEach(btn => btn.style.display = 'none');
                            
                            const truncatedElements = clonedCard.querySelectorAll('.truncate');
                            truncatedElements.forEach(el => {
                                el.style.overflow = 'visible'; 
                                el.style.whiteSpace = 'normal'; 
                                el.style.textOverflow = 'clip';
                                el.style.paddingBottom = '5px'; 
                            });
                        }
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `Êï∞ÊçÆÁªüËÆ°_${new Date().toLocaleDateString()}.png`;
                        link.click();
                        setIsCapturing(false);
                    }).catch(() => setIsCapturing(false));
                }, 200);
            };

            const saveSummaryImage = () => {
                const card = document.getElementById('summary-card');
                if (!card) return;
                setIsCapturing(true);
                setTimeout(() => {
                    html2canvas(card, { 
                        backgroundColor: '#E0F2F1', 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true,
                        onclone: (clonedDoc) => {
                            const clonedCard = clonedDoc.getElementById('summary-card');
                            const scrollableContent = clonedCard.querySelector('.overflow-y-auto');
                            if (clonedCard) {
                                clonedCard.style.maxHeight = 'none';
                                clonedCard.style.height = 'auto';
                                clonedCard.style.overflow = 'visible';
                            }
                            if (scrollableContent) {
                                scrollableContent.style.maxHeight = 'none';
                                scrollableContent.style.height = 'auto';
                                scrollableContent.style.overflow = 'visible';
                            }
                            const truncatedElements = clonedCard.querySelectorAll('.truncate');
                            truncatedElements.forEach(el => {
                                el.style.overflow = 'visible'; 
                                el.style.whiteSpace = 'normal'; 
                                el.style.textOverflow = 'clip';
                                el.style.paddingBottom = '5px'; 
                            });
                        }
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `ÊàòÊä•_${new Date().toLocaleDateString()}.png`;
                        link.click();
                        setIsCapturing(false);
                    }).catch(() => setIsCapturing(false));
                }, 200);
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay };
            };

            const handleMonthChange = (e) => {
                const [y, m] = e.target.value.split('-');
                const newDate = new Date(parseInt(y), parseInt(m) - 1, 1);
                setSelectedDate(newDate);
            };

            const renderCalendar = () => {
                const { days, firstDay } = getDaysInMonth(selectedDate);
                const monthLogs = logs.filter(l => {
                    if (!l.endTime) return false;
                    const d = new Date(l.endTime); 
                    return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear();
                });

                const grid = [];
                for (let i = 0; i < firstDay; i++) grid.push(<div key={`empty-${i}`} className="h-8"></div>);
                
                for (let d = 1; d <= days; d++) {
                    const dateLogs = monthLogs.filter(l => new Date(l.endTime).getDate() === d);
                    const hasData = dateLogs.length > 0;
                    const isSelected = selectedDate.getDate() === d;
                    
                    grid.push(
                        <button 
                            key={d}
                            onClick={() => {
                                const newDate = new Date(selectedDate);
                                newDate.setDate(d);
                                setSelectedDate(newDate);
                                setShowCalendar(false);
                                setShowSummary(true);
                            }}
                            className={`h-8 flex flex-col items-center justify-center border font-bold relative ${isSelected ? 'bg-black text-white' : 'bg-white text-black'} ${hasData ? 'border-black' : 'border-gray-200 text-gray-300'}`}
                        >
                            {d}
                            {hasData && <div className="absolute bottom-1 w-1 h-1 bg-[#FFD60A] border border-black"></div>}
                        </button>
                    );
                }
                return grid;
            };

            const getExportDisplayName = (log) => {
                if (!log.parentId) return log.activityName;
                const parent = activities.find(a => a.id === log.parentId);
                return parent ? `${parent.name}-${log.activityName}` : log.activityName;
            };

            const exportCSV = (targetDate = null) => {
                let targetLogs = logs.filter(l => l.endTime);
                if (targetDate) {
                    targetLogs = targetLogs.filter(l => {
                        const d = new Date(l.endTime);
                        return d.getDate() === targetDate.getDate() && 
                               d.getMonth() === targetDate.getMonth() && 
                               d.getFullYear() === targetDate.getFullYear();
                    });
                } else {
                    const today = new Date();
                    targetLogs = targetLogs.filter(l => {
                        const d = new Date(l.endTime);
                        return d.getDate() === today.getDate() && 
                               d.getMonth() === today.getMonth() && 
                               d.getFullYear() === today.getFullYear();
                    });
                }

                if (targetLogs.length === 0) return showMsg("ÊöÇÊó†Êï∞ÊçÆ", "error");
                
                let csv = "\ufeffÊó•Êúü,ÂêçÁß∞,ÂºÄÂßãÊó∂Èó¥,ÁªìÊùüÊó∂Èó¥,Êó∂Èïø(ÂàÜ)\n";
                targetLogs.forEach(l => {
                    const dateStr = new Date(l.endTime).toLocaleDateString();
                    const startStr = new Date(l.startTime).toLocaleTimeString([],{hour12:false});
                    const endStr = new Date(l.endTime).toLocaleTimeString([],{hour12:false});
                    const duration = Math.round((l.endTime-l.startTime)/60000);
                    const displayName = getExportDisplayName(l);
                    csv += `${dateStr},${displayName},${startStr},${endStr},${duration}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const fileNameDate = targetDate ? targetDate.toLocaleDateString().replace(/\//g,'-') : 'Today';
                link.download = `TimeCatcher_${fileNameDate}.csv`;
                link.click();
            };

            const exportICS = (targetLogs) => {
                const validLogs = targetLogs.filter(l => l.endTime);
                if (validLogs.length === 0) return;
                const fmt = (ts) => new Date(ts).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TimeCatcher//EN\n";
                validLogs.forEach(l => { 
                    const displayName = getExportDisplayName(l);
                    ics += `BEGIN:VEVENT\nSUMMARY:${displayName}\nDTSTART:${fmt(l.startTime)}\nDTEND:${fmt(l.endTime)}\nEND:VEVENT\n`; 
                });
                ics += "END:VCALENDAR";
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([ics], {type:'text/calendar'}));
                link.download = "calendar.ics";
                link.click();
            };

            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});

            const restoreBackup = (str) => {
                try {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(str))));
                    if (decoded.activities && decoded.logs) {
                        setActivities(decoded.activities);
                        setLogs(decoded.logs);
                        if (decoded.customGoals) setCustomGoals(decoded.customGoals);
                        showMsg("Êï∞ÊçÆÂ∑≤ÊÅ¢Â§ç");
                        setShowBackupModal(false);
                    } else {
                        showMsg("Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè", "error");
                    }
                } catch (e) {
                    showMsg("Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰ª£Á†Å", "error");
                }
            };

            // ÊäΩÁ¶ªÊ†∏ÂøÉÂºÄÂßãËÆ°Êó∂ÈÄªËæëÔºå‰æõÂ§öÁßçÂÖ•Âè£Ë∞ÉÁî®
            const startActivity = (act) => {
                const now = Date.now();
                triggerVibrate(40);
                setLogs(prev => [...prev.map(l => l.endTime === null ? { ...l, endTime: now } : l), { 
                    id: Math.random().toString(36).substr(2, 9), 
                    activityName: act.name, 
                    activityEmoji: act.emoji, 
                    parentId: act.parentId,
                    startTime: now, 
                    endTime: null 
                }]);
            };

            const handleActivityClick = (act) => {
                if (isEditMode) {
                    const children = activities.filter(a => a.parentId === act.id);
                    if (children.length > 0) { 
                        setCurrentParentId(act.id);
                        triggerVibrate(20);
                    }
                    return;
                }
                const children = activities.filter(a => a.parentId === act.id);
                if (children.length > 0) { 
                    setCurrentParentId(act.id);
                    triggerVibrate(30);
                } 
                else {
                    startActivity(act);
                }
            };

            const handleDeleteItem = (e, actId) => {
                e.stopPropagation();
                if (itemDeleteConfirmId === actId) {
                    setActivities(prev => prev.filter(a => a.id !== actId && a.parentId !== actId));
                    setItemDeleteConfirmId(null);
                    triggerVibrate(50);
                } else {
                    setItemDeleteConfirmId(actId);
                    triggerVibrate(20);
                    setTimeout(() => setItemDeleteConfirmId(null), 3000);
                }
            };

            const handleDeleteLog = (e, logId) => {
                e.stopPropagation();
                if (logDeleteConfirmId === logId) {
                    setLogs(prev => prev.filter(l => l.id !== logId));
                    setLogDeleteConfirmId(null);
                    triggerVibrate(50);
                    showMsg("ËÆ∞ÂΩïÂ∑≤Âà†Èô§");
                } else {
                    setLogDeleteConfirmId(logId);
                    triggerVibrate(20);
                    setTimeout(() => setLogDeleteConfirmId(null), 3000);
                }
            };

            const toggleVoice = async () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    handleManualInput({ preventDefault: () => {} });
                    return showMsg("Á≥ªÁªü‰∏çÊîØÊåÅËØ≠Èü≥ÔºåÂ∑≤ËΩ¨‰∏∫ÊâãÂä®ËæìÂÖ•", "error");
                }

                if (isListening) {
                    if (recognitionRef.current) recognitionRef.current.stop();
                    setIsListening(false);
                    return;
                }

                try { await navigator.mediaDevices.getUserMedia({ audio: true }); } 
                catch (e) {
                    handleManualInput({ preventDefault: () => {} });
                    return showMsg("È∫¶ÂÖãÈ£éÂèóÈôêÔºåÂ∑≤ËΩ¨‰∏∫ÊâãÂä®ËæìÂÖ•", "error"); 
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;
                recognitionRef.current = recognition;

                recognition.onstart = () => { setIsListening(true); triggerVibrate(20); showMsg("Ê≠£Âú®Âê¨..."); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.replace(/[ .,?!„ÄÇÔºåÔºüÔºÅ\s\n]/g, '');
                    const allActivities = activitiesRef.current;
                    const match = allActivities.find(act => {
                        const name = act.name.replace(/[ .,?!„ÄÇÔºåÔºüÔºÅ\s\n]/g, '');
                        return transcript.includes(name) || name.includes(transcript);
                    });
                    if (match) {
                        const now = Date.now();
                        triggerVibrate(40);
                        setLogs(prev => {
                            const newLogs = prev.map(l => l.endTime === null ? { ...l, endTime: now } : l);
                            newLogs.push({ 
                                id: Math.random().toString(36).substr(2, 9), 
                                activityName: match.name, 
                                activityEmoji: match.emoji, 
                                parentId: match.parentId,
                                startTime: now, 
                                endTime: null 
                            });
                            return newLogs;
                        });
                        showMsg(`Â∑≤ÂêØÂä®: ${match.name}`);
                    } else { showMsg(`Êú™ËØÜÂà´: "${transcript}"`, "error"); }
                    setIsListening(false);
                };
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);
                recognition.start();
            };
            
            const handleManualInput = (e) => {
                e.preventDefault();
                const input = prompt("ÊâãÂä®ËæìÂÖ•Ê¥ªÂä®ÂêçÁß∞Ôºö");
                if (input) {
                      const match = activitiesRef.current.find(act => input.includes(act.name) || act.name.includes(input));
                      if (match) {
                        handleActivityClick(match);
                        showMsg(`Êåá‰ª§Â∑≤ÊâßË°å: ${match.name}`);
                      } else {
                        showMsg("Êâæ‰∏çÂà∞ËØ•Ê¥ªÂä®", "error");
                      }
                }
            };

            const moveItem = (actId, direction) => {
                const currentList = activities.filter(a => a.parentId === currentParentId);
                const currentIndex = currentList.findIndex(a => a.id === actId);
                if (currentIndex === -1) return;
                const targetIndex = currentIndex + direction;
                if (targetIndex < 0 || targetIndex >= currentList.length) return;
                const targetActivity = currentList[targetIndex];
                const newActivities = [...activities];
                const realIndexA = newActivities.findIndex(a => a.id === actId);
                const realIndexB = newActivities.findIndex(a => a.id === targetActivity.id);
                [newActivities[realIndexA], newActivities[realIndexB]] = [newActivities[realIndexB], newActivities[realIndexA]];
                setActivities(newActivities);
                triggerVibrate(20);
            };

            const clearAllData = () => {
                if (deleteConfirm) {
                    setLogs([]);
                    localStorage.setItem('tc_v10_17_logs', JSON.stringify([])); 
                    showMsg("Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫", "error");
                    setShowSummary(false); 
                    setDeleteConfirm(false);
                } else {
                    setDeleteConfirm(true);
                    setTimeout(() => setDeleteConfirm(false), 3000);
                }
            };

            // Added back the missing helper function
            const getLogsForDate = (date) => {
                return logs.filter(l => {
                    if (!l.endTime) return false;
                    const d = new Date(l.endTime); 
                    return d.getDate() === date.getDate() && 
                           d.getMonth() === date.getMonth() && 
                           d.getFullYear() === date.getFullYear();
                }).sort((a,b) => a.startTime - b.startTime);
            };

            // Ëé∑ÂèñÂàÜÁ∫ßÊ¥ªÂä®ÂàóË°®ÔºàÁî®‰∫éÈÄâÊã©Âô®Ôºâ
            const getHierarchicalActivities = () => {
                const roots = activities.filter(a => !a.parentId);
                const list = [];
                roots.forEach(root => {
                    list.push({ ...root, level: 0 });
                    const children = activities.filter(c => c.parentId === root.id);
                    children.forEach(child => list.push({ ...child, level: 1 }));
                });
                return list;
            };

            return (
                <div className={`flex flex-col h-full w-full p-6 text-[#2D3436] justify-between ${isCapturing ? 'is-capturing' : ''}`}>
                    {msg.show && <div className="fixed top-32 left-1/2 -translate-x-1/2 z-[500] w-[80%] pointer-events-none"><div className="pixel-border p-2 shadow-[4px_4px_0px_0px_black] bg-[#FFD60A] text-black font-black text-center text-xs">{msg.text}</div></div>}

                    {/* Banner */}
                    <div className="flex-shrink-0 mb-4">
                        <div className={`pixel-border pixel-shadow p-5 transition-all duration-500 relative flex flex-col justify-center min-h-[160px] ${currentLog ? 'banner-active bg-white' : 'bg-gray-100 opacity-90'}`}>
                            <div className="flex items-center justify-center gap-4 w-full pr-2 pb-6"> 
                                <span className="text-4xl leading-none flex-shrink-0 drop-shadow-sm">{currentEmoji}</span>
                                <div className="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                                    <h1 className="text-2xl font-black truncate leading-none tracking-tighter uppercase">
                                        {currentLog ? currentLog.activityName : 'STANDBY'}
                                    </h1>
                                    {currentLog && <span className="text-sm font-bold text-blue-700 bg-blue-100 border-2 border-blue-500 px-2 py-0.5 leading-none whitespace-nowrap flex-shrink-0">{formatTime(currentLog.startTime)}</span>}
                                </div>
                            </div>
                            <div className="absolute bottom-3 right-3 flex gap-2">
                                <button onClick={toggleVoice} onContextMenu={handleManualInput} className={`w-7 h-7 pixel-border pixel-btn-flat bg-white flex items-center justify-center transition-all ${isListening ? 'mic-active' : ''}`}>{PIXEL_ICONS.mic}</button>
                                <button onClick={() => setIsEditMode(!isEditMode)} className={`w-7 h-7 pixel-border pixel-btn-flat bg-white flex items-center justify-center ${isEditMode ? 'bg-[#FFD60A]' : ''}`}>{PIXEL_ICONS.gear}</button>
                                <button onClick={stopCurrent} className={`w-7 h-7 pixel-border pixel-btn-flat flex items-center justify-center transition-all ${currentLog ? 'bg-white active:bg-red-50' : 'bg-gray-200 opacity-20'}`}>{PIXEL_ICONS.stop}</button>
                            </div>
                        </div>
                    </div>

                    {/* ÂàóË°® */}
                    <div className="flex-1 flex flex-col justify-center min-h-0 py-4 overflow-hidden">
                        <div className="overflow-y-auto no-scrollbar max-h-full">
                            <div className={`transition-all duration-300 ${isEditMode ? 'pt-14' : 'pt-2'}`}>
                                {currentParentId && <button onClick={() => setCurrentParentId(null)} className="mb-8 px-1 text-xs font-black flex items-center gap-2 underline underline-offset-4 decoration-4 uppercase tracking-tighter">{PIXEL_ICONS.back} Back to menu</button>}
                                <div className="grid grid-cols-2 gap-x-6 gap-y-12 px-1 pb-10">
                                    {/* ‰øÆÂ§ç1Ôºö‰ºòÂåñËøáÊª§Âô®ÔºåÂêåÊó∂ÂÖºÂÆπ null Âíå "" ‰Ωú‰∏∫Ê†πËäÇÁÇπÊ†áËÆ∞ÔºåÊâæÂõûÊ∂àÂ§±ÁöÑÊ¥ªÂä® */}
                                    {activities.filter(a => currentParentId === null ? !a.parentId : a.parentId === currentParentId).map((act, idx) => {
                                        const hasChildren = activities.some(child => child.parentId === act.id);
                                        const currentMins = getTodayProgress(act);
                                        const goalMins = act.dailyGoal || 0;
                                        const progressPercent = goalMins > 0 ? Math.min(100, (currentMins / goalMins) * 100) : 0;
                                        
                                        // ÁõÆÊ†áÂà§ÂÆöÈÄªËæë (Quest Logic) - ‰∏ªÂàóË°®
                                        const isNegative = act.nature === 'negative';
                                        let barColor = '#FFD60A';
                                        if (isNegative && currentMins > goalMins) barColor = 'var(--p-red)'; // Ë¥üÂêëË∂ÖÊ†áÂèòÁ∫¢
                                        
                                        return (
                                            <div key={act.id} className="relative">
                                                <button onClick={() => handleActivityClick(act)} className="w-full bg-white pixel-border p-3 pixel-btn-flat flex flex-col justify-center gap-1 h-20 text-left relative overflow-hidden">
                                                    {goalMins > 0 && (
                                                        <div className="absolute bottom-0 left-0 h-1.5 transition-all duration-500 opacity-80" style={{width: `${progressPercent}%`, backgroundColor: barColor}}></div>
                                                    )}
                                                    
                                                    <div className="flex items-center gap-2 relative z-10 w-full">
                                                        <span className="text-3xl leading-none flex-shrink-0 select-none">{act.emoji}</span>
                                                        <div className="flex-1 min-w-0">
                                                            <p className="font-black text-lg uppercase leading-none truncate">{act.name}</p>
                                                            {goalMins > 0 && (
                                                                <p className="text-[10px] font-bold text-gray-400 mt-1 flex items-center gap-1">
                                                                            {currentMins}/{goalMins}m 
                                                                        {/* Ê≠£ÂêëÔºöËææÊàêÊòæÁ§∫ÊòüÔºõË¥üÂêëÔºöÊú™Ë∂ÖÊ†áÊòæÁ§∫Êòü */}
                                                                        {(!isNegative && currentMins >= goalMins) && <span className="text-yellow-500">‚òÖ</span>}
                                                                        {(isNegative && currentMins <= goalMins) && <span className="text-yellow-500">‚òÖ</span>}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    {hasChildren && <div className="absolute top-2 right-2">{PIXEL_ICONS.folder}</div>}
                                                    
                                                    {/* ‰øÆÂ§çÔºöÈíàÂØπÂê´ÊúâÂ≠êÈ°πÁöÑÁà∂Á∫ßÊ¥ªÂä®ÔºåÊèê‰æõÁõ¥Êé•ÂºÄÂßãÁöÑÊåâÈíÆÂÖ•Âè£ */}
                                                    {hasChildren && !isEditMode && (
                                                        <div 
                                                            onClick={(e) => { e.stopPropagation(); startActivity(act); }}
                                                            // ‰øÆÊîπÔºöÁº©Â∞èÊåâÈíÆÂ∞∫ÂØ∏Ëá≥ w-4 h-4ÔºåË∞ÉÊï¥‰ΩçÁΩÆËá≥ bottom-1.5 right-1.5ÔºåÂπ∂Âº∫Âà∂Áº©Â∞èÂÜÖÈÉ® SVG ÂõæÊ†á
                                                            className="absolute bottom-1.5 right-1.5 w-4 h-4 bg-[#FFD60A] pixel-border flex items-center justify-center z-20 shadow-sm active:translate-y-0.5 hover:bg-yellow-300 transition-colors [&>svg]:w-3 [&>svg]:h-3"
                                                            title={`Start ${act.name}`}
                                                        >
                                                            {PIXEL_ICONS.play}
                                                        </div>
                                                    )}
                                                </button>
                                                {isEditMode && (
                                                    <div className="absolute -top-6 left-0 right-0 flex justify-center gap-1.5 z-20">
                                                        <button onClick={() => { setActiveEditId(act.id); setFormData({name: act.name, emoji: act.emoji, parentId: act.parentId || '', dailyGoal: act.dailyGoal || 0, nature: act.nature || 'neutral' }); setShowEditModal(true); }} className="bg-[#FFD60A] border-2 border-black w-6 h-6 flex items-center justify-center shadow-sm">{PIXEL_ICONS.edit}</button>
                                                        <button onClick={(e) => handleDeleteItem(e, act.id)} className={`border-2 border-black w-6 h-6 flex items-center justify-center shadow-sm transition-colors ${itemDeleteConfirmId === act.id ? 'bg-red-600 text-white animate-pulse' : 'bg-red-500 text-white'}`}>{itemDeleteConfirmId === act.id ? <span className="text-[6px] font-black">SURE</span> : PIXEL_ICONS.trash}</button>
                                                        <button onClick={() => moveItem(act.id, -1)} className="bg-white border-2 border-black w-6 h-6 flex items-center justify-center shadow-sm">{PIXEL_ICONS.up}</button>
                                                        <button onClick={() => moveItem(act.id, 1)} className="bg-white border-2 border-black w-6 h-6 flex items-center justify-center shadow-sm">{PIXEL_ICONS.down}</button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {isEditMode && (
                                        <div className="flex flex-col gap-2">
                                            <button onClick={() => { setFormData({name:'', emoji:'üìç', parentId:'', nature: 'neutral'}); setShowAddModal(true); }} className="border-4 border-dashed border-gray-400 p-3 flex items-center justify-center h-20 text-gray-400 bg-white/30">{PIXEL_ICONS.plus}</button>
                                            <button onClick={() => { const data = { activities, logs, customGoals }; const str = btoa(unescape(encodeURIComponent(JSON.stringify(data)))); setBackupString(str); setIsRestoreMode(false); setShowBackupModal(true); }} className="border-2 border-black bg-white p-2 text-[8px] font-bold tracking-tighter shadow-sm uppercase">Backup Vault</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Â∫ïÈÉ®ÂØºËà™ */}
                    <div className="flex-shrink-0 grid grid-cols-4 gap-2 pb-2">
                        <button onClick={() => { setSelectedDate(new Date()); setShowSummary(true); }} className="bg-black text-white pixel-border p-3 font-bold text-xs flex items-center justify-center gap-1 active:bg-gray-800 uppercase italic tracking-tighter shadow-sm">SUMMARY</button>
                        <button onClick={() => setShowGoalModal(true)} className="bg-white pixel-border p-3 font-bold text-xs active:bg-gray-100 uppercase italic tracking-tighter shadow-sm">GOAL</button>
                        <button onClick={() => {
                            const year = selectedDate.getFullYear();
                            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                            const day = String(selectedDate.getDate()).padStart(2, '0');
                            const dateStr = `${year}-${month}-${day}`;
                            
                            setStatsDateRange({ start: dateStr, end: dateStr });
                            setShowStatsModal(true);
                        }} className="bg-white pixel-border p-3 font-bold text-xs active:bg-gray-100 uppercase italic tracking-tighter shadow-sm flex items-center justify-center gap-1">STATS</button>
                        <button onClick={() => setShowCalendar(true)} className="bg-white pixel-border p-3 font-bold text-xs active:bg-gray-100 uppercase italic tracking-tighter shadow-sm">HISTORY</button>
                    </div>

                    {/* Show Calendar Modal (Restored from v2.2) */}
                    {showCalendar && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
                            <div className="bg-white pixel-border p-6 w-full max-w-sm">
                                <div className="flex justify-between items-center mb-6 border-b-4 border-black pb-2">
                                    <h2 className="text-2xl font-black uppercase">TIME TRAVEL</h2>
                                    <button onClick={() => setShowCalendar(false)} className="text-xl font-bold border-2 border-black px-3">X</button>
                                </div>
                                <div className="flex justify-center items-center mb-4">
                                    <input 
                                        type="month" 
                                        value={`${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}`}
                                        onChange={handleMonthChange}
                                        className="font-black text-xl text-center bg-[#E0F2F1] border-2 border-black p-2 outline-none uppercase"
                                    />
                                </div>
                                <div className="grid grid-cols-7 gap-2 mb-6">
                                    {['S','M','T','W','T','F','S'].map((d,i) => <div key={i} className="text-center text-xs font-bold opacity-40">{d}</div>)}
                                    {renderCalendar()}
                                </div>
                                <div className="border-t-4 border-dashed border-gray-300 pt-4">
                                    <button onClick={() => exportCSV(null)} className="w-full bg-[#E0F2F1] pixel-border p-3 font-bold text-xs uppercase shadow-sm active:bg-gray-200">EXPORT ALL HISTORY (CSV)</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Summary Modal (Restored from v2.2) */}
                    {showSummary && (
                        <div className={`fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm ${isCapturing ? 'is-capturing' : ''}`}>
                            <div id="summary-card" className="bg-[#E0F2F1] pixel-border p-6 w-full max-w-sm flex flex-col overflow-hidden max-h-[85vh] text-left">
                                <div className="flex justify-between items-center mb-5 border-b-4 border-black pb-2">
                                    <div><h2 className="text-3xl font-black italic uppercase tracking-tighter">Mission Clear</h2><p className="text-[10px] font-bold opacity-40 mt-1">Date: {selectedDate.toLocaleDateString()}</p></div>
                                    <button onClick={() => setShowSummary(false)} className="hide-in-capture text-xl font-bold border-4 border-black px-4 py-1 bg-white mb-2 shadow-sm shadow-black">X</button>
                                </div>
                                <div className="flex-1 space-y-1 overflow-y-auto no-scrollbar pr-1 pb-4">
                                    {getLogsForDate(selectedDate).length === 0 ? (
                                        <p className="text-center font-bold opacity-30 py-20 italic uppercase tracking-tight">No Data Found</p>
                                    ) : (
                                        getLogsForDate(selectedDate).map((l, i) => {
                                            const activityObj = activities.find(a => a.name === l.activityName);
                                            const parentObj = activityObj?.parentId ? activities.find(a => a.id === activityObj.parentId) : null;
                                            const displayName = parentObj ? `${parentObj.name}-${l.activityName}` : l.activityName;
                                            return (
                                                <div key={l.id} className="bg-white border-b-2 border-black/10 p-2 flex justify-between items-center text-left">
                                                    <div className="flex items-center gap-1.5 min-w-0">
                                                        <span className="text-lg flex-shrink-0">{l.activityEmoji || 'üìç'}</span>
                                                        <div className="flex items-center gap-1.5 truncate py-1">
                                                            <span className="font-black text-[13px] uppercase truncate leading-relaxed">{displayName}</span>
                                                            <span className="text-[9px] font-bold text-blue-600 opacity-60 flex-shrink-0">[{formatTime(l.startTime)}-{formatTime(l.endTime)}]</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="font-black text-xs flex-shrink-0">{Math.round((l.endTime-l.startTime)/60000)}M</div>
                                                        {isDeleteMode && (
                                                            <button 
                                                                onClick={(e) => handleDeleteLog(e, l.id)}
                                                                className={`hide-in-capture w-5 h-5 flex items-center justify-center border-2 border-black text-[10px] font-bold transition-all shadow-sm ${logDeleteConfirmId === l.id ? 'bg-red-500 text-white border-red-800' : 'bg-white text-gray-400 border-gray-200'}`}
                                                            >
                                                                {logDeleteConfirmId === l.id ? '?' : 'x'}
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                                <div className="mt-2 pt-4 border-t-4 border-black flex justify-between items-end flex-shrink-0 text-left">
                                    <div className="flex-1">
                                        <p className="text-[10px] font-bold opacity-40 uppercase mb-1">Total XP</p>
                                        <p className="text-5xl font-black leading-relaxed pb-2">
                                            {Math.round(getLogsForDate(selectedDate).reduce((acc, l) => acc + (l.endTime ? (l.endTime - l.startTime) / 60000 : 0), 0))}0
                                        </p>
                                    </div>
                                    <div className="hide-in-capture grid grid-cols-2 gap-2 w-32">
                                        <button onClick={saveSummaryImage} className="bg-[#FFD60A] border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Save Image">{PIXEL_ICONS.save} PNG</button>
                                        <button onClick={() => exportICS(getLogsForDate(selectedDate))} className="bg-[#6D83F2] text-white border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Sync Calendar">{PIXEL_ICONS.cal} CAL</button>
                                        <button onClick={() => exportCSV(selectedDate)} className="bg-white text-black border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1" title="Export CSV">{PIXEL_ICONS.csv} CSV</button>
                                        <button 
                                            onClick={() => setIsDeleteMode(!isDeleteMode)} 
                                            className={`border-2 border-black py-1.5 font-bold uppercase text-[9px] italic shadow-sm active:translate-y-0.5 flex items-center justify-center gap-1 transition-colors ${isDeleteMode ? 'bg-black text-white' : 'bg-white text-red-600'}`} 
                                            title="Toggle Delete Mode"
                                        >
                                            {PIXEL_ICONS.trash} {isDeleteMode ? 'DONE' : 'DEL'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Backup Modal (Restored from v2.2) */}
                    {showBackupModal && (
                        <div className="fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 text-left">
                            <div className="bg-white pixel-border p-6 w-full max-w-sm shadow-[10px_10px_0px_0px_black]">
                                <h2 className="text-2xl font-black mb-4 border-b-4 border-black uppercase">{isRestoreMode ? 'RESTORE' : 'VAULT'}</h2>
                                
                                {isRestoreMode ? (
                                    <textarea 
                                        className="w-full h-40 pixel-border p-3 text-[9px] font-mono mb-4 break-all bg-yellow-50 outline-none placeholder-gray-400" 
                                        placeholder="Paste backup code here..." 
                                        value={restoreInputValue}
                                        onChange={(e) => setRestoreInputValue(e.target.value)}
                                    ></textarea>
                                ) : (
                                    <textarea id="backup-output" readOnly className="w-full h-40 pixel-border p-3 text-[9px] font-mono mb-4 break-all bg-gray-50 outline-none" value={backupString}></textarea>
                                )}

                                <div className="flex flex-col gap-3">
                                    {isRestoreMode ? (
                                        <>
                                            <button onClick={() => restoreBackup(restoreInputValue)} className="bg-[#6D83F2] text-white p-4 font-black">CONFIRM RESTORE</button>
                                            <button onClick={() => setIsRestoreMode(false)} className="bg-white border-2 border-black p-3 font-black text-xs">CANCEL</button>
                                        </>
                                    ) : (
                                        <>
                                            <button onClick={() => { 
                                                const el = document.getElementById('backup-output');
                                                if (el) {
                                                    el.select();
                                                    el.setSelectionRange(0, 99999);
                                                    document.execCommand('copy');
                                                    showMsg("Copied");
                                                }
                                            }} className="bg-[#FFD60A] p-4 font-black">COPY CODE</button>
                                            <button onClick={() => { setIsRestoreMode(true); setRestoreInputValue(''); }} className="bg-[#6D83F2] text-white p-4 font-black">ENTER RESTORE MODE</button>
                                        </>
                                    )}
                                    <button onClick={() => setShowBackupModal(false)} className="bg-black text-white p-3 font-black text-xs">EXIT</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* STATS ÂºπÁ™ó (Updated v2.2) */}
                    {showStatsModal && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
                            <div id="stats-card" className="bg-white pixel-border p-6 w-full max-w-sm max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b-4 border-black pb-2 flex-shrink-0">
                                    <h2 className="text-2xl font-black uppercase">DATA CENTER</h2>
                                    <div className="flex gap-2 hide-in-capture">
                                        <button onClick={saveStatsImage} className="border-2 border-black w-9 h-9 flex items-center justify-center bg-[#FFD60A] shadow-sm active:translate-y-0.5">{PIXEL_ICONS.save}</button>
                                        <button onClick={() => setShowStatsModal(false)} className="text-xl font-bold border-2 border-black w-9 h-9 flex items-center justify-center shadow-sm active:translate-y-0.5 bg-white">X</button>
                                    </div>
                                </div>

                                <div className="flex gap-2 mb-4 flex-shrink-0">
                                    <button onClick={() => { setStatsTab('overview'); setInsightDrillId(null); }} className={`flex-1 font-bold text-xs py-2 uppercase border-2 border-black ${statsTab === 'overview' ? 'bg-[#FFD60A]' : 'bg-white opacity-50'}`}>INSIGHTS</button>
                                    <button onClick={() => setStatsTab('compare')} className={`flex-1 font-bold text-xs py-2 uppercase border-2 border-black ${statsTab === 'compare' ? 'bg-[#FFD60A]' : 'bg-white opacity-50'}`}>PK MODE</button>
                                </div>

                                <div id="stats-capture-area" className="flex-1 overflow-y-auto no-scrollbar space-y-4 bg-white p-1 mb-2">
                                    {statsTab === 'overview' ? (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-2 bg-gray-100 p-2 border-2 border-black">
                                                <input type="date" className="p-1 text-xs font-bold border-2 border-black text-center" value={statsDateRange.start} onChange={e => setStatsDateRange({...statsDateRange, start: e.target.value})} />
                                                <input type="date" className="p-1 text-xs font-bold border-2 border-black text-center" value={statsDateRange.end} onChange={e => setStatsDateRange({...statsDateRange, end: e.target.value})} />
                                            </div>

                                            {!insightDrillId ? (
                                                (() => {
                                                    const { totalPeriodMins, stats, netScore } = calculateStats(statsDateRange.start, statsDateRange.end);
                                                    return (
                                                        <>
                                                            <div className="text-center py-4 bg-[#E0F2F1] border-2 border-black">
                                                                <p className="text-xs font-bold opacity-50 mb-1">TOTAL FOCUS TIME</p>
                                                                <p className="text-4xl font-black">{(totalPeriodMins / 60).toFixed(1)}h</p>
                                                                <p className={`text-xs font-bold mt-2 font-mono ${netScore >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                                    Soul Net Score: {netScore > 0 ? '+' : ''}{Math.round(netScore)}m
                                                                </p>
                                                            </div>

                                                            <div className="space-y-2">
                                                                {stats.length === 0 ? <p className="text-center text-xs opacity-40 py-4">No data.</p> : stats.map(s => {
                                                                    const pct = totalPeriodMins > 0 ? (s.mins / totalPeriodMins) * 100 : 0;
                                                                    const hasChildren = activities.some(child => child.parentId === s.id);
                                                                    const scoreColor = s.score > 0 ? 'text-green-600' : (s.score < 0 ? 'text-red-500' : 'text-gray-400');
                                                                    
                                                                    return (
                                                                        <div 
                                                                            key={s.id} 
                                                                            onClick={() => { if(hasChildren) setInsightDrillId(s.id); }}
                                                                            className={`relative border-2 border-black bg-white h-10 flex items-center overflow-hidden transition-transform ${hasChildren ? 'active:scale-95 cursor-pointer' : 'cursor-default'}`}
                                                                        >
                                                                            <div 
                                                                                className="absolute top-0 left-0 h-full bg-[#6D83F2] opacity-20 z-0 transition-all duration-500 border-r-2 border-[#6D83F2]" 
                                                                                style={{width: `${pct}%`}}
                                                                            ></div>
                                                                            
                                                                            <div className="flex justify-between items-center w-full px-2 relative z-10">
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-xl">{s.emoji}</span>
                                                                                    <span className="font-bold text-sm uppercase">{s.name}</span>
                                                                                    {hasChildren && <span className="text-[8px] opacity-40">‚ñº</span>}
                                                                                </div>
                                                                                <div className="text-right flex items-center gap-2">
                                                                                    <span className={`text-[9px] font-bold ${scoreColor}`}>
                                                                                        {s.score > 0 ? '+' : ''}{Math.round(s.score)}
                                                                                    </span>
                                                                                    <span className="text-[10px] opacity-50 font-mono ml-1">{Math.round(s.mins)}m</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </>
                                                    );
                                                })()
                                            ) : (
                                                (() => {
                                                    const parentAct = activities.find(a => a.id === insightDrillId);
                                                    if (!parentAct) { setInsightDrillId(null); return null; }

                                                    // Use helper for drill-down stats
                                                    const drillStats = getDrillStats(parentAct, statsDateRange.start, statsDateRange.end);
                                                    const parentTotalMins = drillStats.reduce((acc, s) => acc + s.mins, 0);

                                                    return (
                                                        <>
                                                            <div className="flex items-center gap-2 mb-2 bg-black text-white p-2 border-2 border-black">
                                                                <button 
                                                                    onClick={() => setInsightDrillId(null)}
                                                                    className="text-xs font-bold border border-white px-2 py-1 hover:bg-white hover:text-black transition-colors"
                                                                >
                                                                    &lt; BACK
                                                                </button>
                                                                <span className="text-xl">{parentAct.emoji}</span>
                                                                <span className="font-black text-sm uppercase flex-1">{parentAct.name} Breakdown</span>
                                                                <span className="text-xs font-mono">{Math.round(parentTotalMins)}m</span>
                                                            </div>

                                                            <div className="space-y-2">
                                                                {drillStats.length === 0 || parentTotalMins === 0 ? (
                                                                    <p className="text-center text-xs opacity-40 py-4">No specific logs found.</p>
                                                                ) : drillStats.map(s => {
                                                                    const pct = parentTotalMins > 0 ? (s.mins / parentTotalMins) * 100 : 0;
                                                                    const isSelf = s.id === parentAct.id;
                                                                    const scoreColor = s.score > 0 ? 'text-green-600' : (s.score < 0 ? 'text-red-500' : 'text-gray-400');

                                                                    if (Math.round(s.mins) === 0) return null;

                                                                    return (
                                                                        <div key={s.id} className={`relative border-2 border-black h-10 flex items-center overflow-hidden ${isSelf ? 'bg-gray-50' : 'bg-white'}`}>
                                                                            <div 
                                                                                className="absolute top-0 left-0 h-full bg-[#FFD60A] opacity-30 z-0 transition-all duration-500 border-r-2 border-[#FFD60A]" 
                                                                                style={{width: `${pct}%`}}
                                                                            ></div>
                                                                            
                                                                            <div className="flex justify-between items-center w-full px-2 relative z-10">
                                                                                <div className="flex items-center gap-2">
                                                                                    <span className="text-xl">{s.emoji}</span>
                                                                                    <span className="font-bold text-sm uppercase">{s.name}</span>
                                                                                    {isSelf && <span className="text-[8px] bg-gray-200 px-1 rounded opacity-60">SELF</span>}
                                                                                </div>
                                                                                <div className="text-right flex items-center gap-2">
                                                                                    <span className={`text-[9px] font-bold ${scoreColor}`}>
                                                                                        {s.score > 0 ? '+' : ''}{Math.round(s.score)}
                                                                                    </span>
                                                                                    <span className="text-[10px] opacity-50 font-mono ml-1">{Math.round(s.mins)}m</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </>
                                                    );
                                                })()
                                            )}
                                        </div>
                                    ) : (
                                        // PK Mode (Updated v2.2)
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-2 text-center text-[10px] font-bold">
                                                <span>PERIOD A</span>
                                                <span>PERIOD B</span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="flex flex-col gap-1">
                                                    <input type="date" className="p-1 text-[10px] font-bold border-2 border-black text-center" value={compareDateRange.startA} onChange={e => setCompareDateRange({...compareDateRange, startA: e.target.value})} />
                                                    <input type="date" className="p-1 text-[10px] font-bold border-2 border-black text-center" value={compareDateRange.endA} onChange={e => setCompareDateRange({...compareDateRange, endA: e.target.value})} />
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <input type="date" className="p-1 text-[10px] font-bold border-2 border-black text-center" value={compareDateRange.startB} onChange={e => setCompareDateRange({...compareDateRange, startB: e.target.value})} />
                                                    <input type="date" className="p-1 text-[10px] font-bold border-2 border-black text-center" value={compareDateRange.endB} onChange={e => setCompareDateRange({...compareDateRange, endB: e.target.value})} />
                                                </div>
                                            </div>

                                            <div className="border-t-4 border-black my-2"></div>

                                            {(() => {
                                                const dataA = calculateStats(compareDateRange.startA, compareDateRange.endA);
                                                const dataB = calculateStats(compareDateRange.startB, compareDateRange.endB);
                                                
                                                if (!pkDrillId) {
                                                    const allRoots = [...new Set([...dataA.stats.map(s=>s.id), ...dataB.stats.map(s=>s.id)])];
                                                    
                                                    // Sort by max time delta interest
                                                    allRoots.sort((id1, id2) => {
                                                        const getMins = (dataSet, id) => dataSet.stats.find(s => s.id === id)?.mins || 0;
                                                        const max1 = Math.max(getMins(dataA, id1), getMins(dataB, id1));
                                                        const max2 = Math.max(getMins(dataA, id2), getMins(dataB, id2));
                                                        return max2 - max1; 
                                                    });
                                                    
                                                    const soulDelta = dataA.netScore - dataB.netScore;
                                                    const soulColor = soulDelta > 0 ? 'text-green-600' : (soulDelta < 0 ? 'text-red-500' : 'text-gray-400');

                                                    return (
                                                        <div className="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                                                            <div className="bg-black text-white p-2 border-2 border-black">
                                                                <div className="flex justify-between items-center mb-1">
                                                                    <span className="font-bold text-xs">TOTAL TIME</span>
                                                                    <div className="flex gap-4 text-xs font-mono">
                                                                        <span className="opacity-70">{Math.round(dataA.totalPeriodMins)}m</span>
                                                                        <span>vs</span>
                                                                        <span className="opacity-70">{Math.round(dataB.totalPeriodMins)}m</span>
                                                                    </div>
                                                                </div>
                                                                <div className="flex justify-between items-center text-[10px] border-t border-gray-700 pt-1">
                                                                    <span>Soul Score Delta (A-B)</span>
                                                                    <span className={`font-black ${soulColor.replace('text-', 'text-')}`}>
                                                                        {soulDelta > 0 ? '+' : ''}{Math.round(soulDelta)}m
                                                                    </span>
                                                                </div>
                                                            </div>

                                                            {allRoots.map(id => {
                                                                const act = activities.find(a => a.id === id);
                                                                if (!act) return null;
                                                                const itemA = dataA.stats.find(s => s.id === id) || { mins: 0, score: 0 };
                                                                const itemB = dataB.stats.find(s => s.id === id) || { mins: 0, score: 0 };
                                                                
                                                                const minsA = itemA.mins;
                                                                const minsB = itemB.mins;
                                                                const diff = minsA - minsB; // Time delta
                                                                const diffPct = minsB > 0 ? Math.round((diff / minsB) * 100) : (minsA > 0 ? 100 : 0);
                                                                
                                                                const scoreDelta = itemA.score - itemB.score; // Score delta
                                                                const scoreDeltaColor = scoreDelta > 0 ? 'text-green-600' : (scoreDelta < 0 ? 'text-red-500' : 'text-gray-300');

                                                                const hasChildren = activities.some(child => child.parentId === act.id);

                                                                return (
                                                                    <div 
                                                                        key={id} 
                                                                        onClick={() => { if(hasChildren) setPkDrillId(id); }}
                                                                        className={`border-b-2 border-gray-200 py-2 flex justify-between items-center text-xs transition-colors ${hasChildren ? 'hover:bg-gray-50 cursor-pointer' : ''}`}
                                                                    >
                                                                        <div className="flex items-center gap-1 w-1/3 min-w-0">
                                                                            <span className="flex-shrink-0">{act.emoji}</span>
                                                                            <span className="font-bold truncate">{act.name}</span>
                                                                            {hasChildren && <span className="text-[8px] opacity-40">‚ñº</span>}
                                                                        </div>
                                                                        <div className="flex gap-2 w-1/3 justify-center font-mono opacity-60">
                                                                            <span>{Math.round(minsA)}</span>
                                                                            <span>/</span>
                                                                            <span>{Math.round(minsB)}</span>
                                                                        </div>
                                                                        <div className="w-1/3 text-right flex flex-col items-end">
                                                                            <span className={`font-black ${diff >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                                                {diff > 0 ? '+' : ''}{diffPct}%
                                                                            </span>
                                                                            <span className={`text-[8px] font-bold ${scoreDeltaColor}`}>
                                                                                Œî {scoreDelta > 0 ? '+' : ''}{Math.round(scoreDelta)}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    );
                                                } else {
                                                    // PK Drill Down
                                                    const parentAct = activities.find(a => a.id === pkDrillId);
                                                    const drillStatsA = getDrillStats(parentAct, compareDateRange.startA, compareDateRange.endA);
                                                    const drillStatsB = getDrillStats(parentAct, compareDateRange.startB, compareDateRange.endB);
                                                    
                                                    const allSubIds = drillStatsA.map(i => i.id).concat(drillStatsB.map(i => i.id).filter(id => !drillStatsA.find(x => x.id === id)));
                                                    const uniqueIds = [...new Set(allSubIds)];
                                                    
                                                    // Sort by max time
                                                    uniqueIds.sort((id1, id2) => {
                                                        const getMins = (arr, id) => arr.find(s => s.id === id)?.mins || 0;
                                                        const max1 = Math.max(getMins(drillStatsA, id1), getMins(drillStatsB, id1));
                                                        const max2 = Math.max(getMins(drillStatsA, id2), getMins(drillStatsB, id2));
                                                        return max2 - max1;
                                                    });
                                                    
                                                    const parentMinsA = drillStatsA.reduce((acc, s) => acc + s.mins, 0);
                                                    const parentMinsB = drillStatsB.reduce((acc, s) => acc + s.mins, 0);

                                                    return (
                                                        <div className="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                                                            <div className="flex items-center gap-2 mb-2 bg-black text-white p-2 border-2 border-black">
                                                                <button 
                                                                    onClick={() => setPkDrillId(null)}
                                                                    className="text-xs font-bold border border-white px-2 py-1 hover:bg-white hover:text-black transition-colors"
                                                                >
                                                                    &lt; BACK
                                                                </button>
                                                                <span className="text-xl">{parentAct.emoji}</span>
                                                                <span className="font-black text-sm uppercase flex-1">{parentAct.name} VS</span>
                                                                <span className="text-xs font-mono">{Math.round(parentMinsA)}/{Math.round(parentMinsB)}m</span>
                                                            </div>

                                                            {uniqueIds.map(id => {
                                                                const itemA = drillStatsA.find(i => i.id === id); // Contains item info + mins + score
                                                                const itemB = drillStatsB.find(i => i.id === id);
                                                                
                                                                // Use either item for static info
                                                                const baseItem = itemA || itemB;
                                                                if (!baseItem) return null;

                                                                const minsA = itemA ? itemA.mins : 0;
                                                                const minsB = itemB ? itemB.mins : 0;
                                                                const scoreA = itemA ? itemA.score : 0;
                                                                const scoreB = itemB ? itemB.score : 0;
                                                                
                                                                if (Math.round(minsA) === 0 && Math.round(minsB) === 0) return null;

                                                                const diff = minsA - minsB;
                                                                const diffPct = minsB > 0 ? Math.round((diff / minsB) * 100) : (minsA > 0 ? 100 : 0);
                                                                const scoreDelta = scoreA - scoreB;
                                                                const scoreDeltaColor = scoreDelta > 0 ? 'text-green-600' : (scoreDelta < 0 ? 'text-red-500' : 'text-gray-300');
                                                                
                                                                const isSelf = id === parentAct.id;

                                                                return (
                                                                    <div key={id} className={`border-b-2 border-gray-200 py-2 flex justify-between items-center text-xs ${isSelf ? 'bg-gray-50 px-1' : ''}`}>
                                                                        <div className="flex items-center gap-1 w-1/3 min-w-0">
                                                                            <span className="flex-shrink-0">{baseItem.emoji}</span>
                                                                            <span className="font-bold truncate">{baseItem.name}</span>
                                                                            {isSelf && <span className="text-[8px] bg-gray-200 px-1 rounded opacity-60">SELF</span>}
                                                                        </div>
                                                                        <div className="flex gap-2 w-1/3 justify-center font-mono opacity-60">
                                                                            <span>{Math.round(minsA)}</span>
                                                                            <span>/</span>
                                                                            <span>{Math.round(minsB)}</span>
                                                                        </div>
                                                                        <div className="w-1/3 text-right flex flex-col items-end">
                                                                            <span className={`font-black ${diff >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                                                {diff > 0 ? '+' : ''}{diffPct}%
                                                                            </span>
                                                                            <span className={`text-[8px] font-bold ${scoreDeltaColor}`}>
                                                                                 Œî {scoreDelta > 0 ? '+' : ''}{Math.round(scoreDelta)}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    );
                                                }
                                            })()}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* GOAL Modal (RESTORED) */}
                    {showGoalModal && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
                            <div id="goal-card" className="bg-white pixel-border p-6 w-full max-w-sm max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center mb-6 border-b-4 border-black pb-2 flex-shrink-0">
                                    <h2 className="text-2xl font-black uppercase">GOAL CENTER</h2>
                                    <div className="flex gap-2 hide-in-capture">
                                        {goalTab === 'history' && (
                                            <button onClick={saveArchiveImage} className="border-2 border-black w-9 h-9 flex items-center justify-center bg-[#FFD60A] shadow-sm active:translate-y-0.5">{PIXEL_ICONS.save}</button>
                                        )}
                                        <button onClick={() => setShowGoalModal(false)} className="text-xl font-bold border-2 border-black w-9 h-9 flex items-center justify-center bg-white shadow-sm active:translate-y-0.5">X</button>
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-4 border-b-2 border-black/10 pb-2 flex-shrink-0">
                                    <button onClick={() => setGoalTab('active')} className={`flex-1 font-bold text-xs py-2 uppercase transition-all ${goalTab === 'active' ? 'bg-[#FFD60A] pixel-border' : 'opacity-50'}`}>üõ°Ô∏è Quests</button>
                                    <button onClick={() => setGoalTab('history')} className={`flex-1 font-bold text-xs py-2 uppercase transition-all ${goalTab === 'history' ? 'bg-[#6D83F2] text-white pixel-border' : 'opacity-50'}`}>üèÜ Reports</button>
                                </div>

                                {goalTab === 'active' && (
                                    <div className="space-y-6 flex-1 overflow-y-auto no-scrollbar">
                                            {/* 1. Daily Challenges */}
                                            <div className="relative z-0">
                                                <h3 className="text-sm font-black mb-2 uppercase opacity-60">DAILY CHALLENGES</h3>
                                                
                                                {/* Add/Edit Daily Goal */}
                                                <div className="bg-gray-100 pixel-border p-2 mb-2 flex gap-2 items-center hide-in-capture">
                                                    <select 
                                                        className="flex-1 pixel-border p-1.5 font-bold text-[10px] bg-white outline-none min-w-0"
                                                        value={newDailyData.activityId}
                                                        onChange={e => {
                                                            const act = activities.find(a => a.id === e.target.value);
                                                            setNewDailyData({
                                                                activityId: e.target.value,
                                                                targetMinutes: act ? (act.dailyGoal || '') : ''
                                                            });
                                                        }}
                                                    >
                                                        <option value="">Set Daily Goal...</option>
                                                        {getHierarchicalActivities().map(a => (
                                                            <option key={a.id} value={a.id}>
                                                                {'\u00A0\u00A0'.repeat(a.level)}{a.emoji} {a.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <input 
                                                        type="number" 
                                                        placeholder="Min" 
                                                        className="w-16 pixel-border p-1.5 text-[10px] font-bold text-center outline-none flex-shrink-0" 
                                                        value={newDailyData.targetMinutes} 
                                                        onChange={e => setNewDailyData({...newDailyData, targetMinutes: e.target.value})} 
                                                    />
                                                    <button 
                                                        onClick={() => {
                                                            if (!newDailyData.activityId) return;
                                                            const val = parseInt(newDailyData.targetMinutes) || 0;
                                                            const todayStr = new Date().toISOString().split('T')[0];
                                                            
                                                            setActivities(prev => prev.map(a => {
                                                                if (a.id === newDailyData.activityId) {
                                                                    // Ê†∏ÂøÉ‰øÆÂ§çÔºöÂÜôÂÖ• goalStartDate
                                                                    // ÈÄªËæëÔºöÂ¶ÇÊûúËÆæÂÆö‰∫ÜÊñ∞ÁõÆÊ†á(val>0)Ôºå‰∏î‰πãÂâçÊ≤°ÊúâÂºÄÂßãÊó•Êúü(Êàñ‰πãÂâçÊòØ0)ÔºåÂàôÊâì‰∏ä‰ªäÂ§©ÁöÑÊó∂Èó¥Êà≥
                                                                    // Â¶ÇÊûúÂè™ÊòØ‰øÆÊîπÊï∞Â≠ó(ÊØîÂ¶Ç30Êîπ60)ÔºåÈÄöÂ∏∏‰øùÊåÅÂéüÂºÄÂßãÊó•ÊúüÔºüËøôÈáåÁÆÄÂåñ‰∏∫ÔºöÂè™Ë¶ÅËÆæÁΩÆÂ∞±Êõ¥Êñ∞/‰øùÊåÅ
                                                                    // ‰∏∫‰∫ÜÁ®≥Â¶•ÔºöÂ¶ÇÊûúÂ∑≤ÁªèÊúâÊó•Êúü‰∏îÂè™ÊòØ‰øÆÊîπÊï∞ÂÄºÔºå‰øùÁïôÂéüÊó•ÊúüÔºõÂ¶ÇÊûúÊòØÊñ∞ËÆæÔºåÁî®‰ªäÂ§©„ÄÇ
                                                                    
                                                                    // Â¶ÇÊûú val ÊòØ 0 (ÁßªÈô§ÁõÆÊ†á)ÔºåÂèØ‰ª•‰øùÁïôÊó•ÊúüÊàñÊ∏ÖÁ©∫ÔºåËøôÈáå‰∏çÊ∏ÖÁ©∫‰ª•‰æøÊú™Êù•ÊÅ¢Â§çÔºåÊàñËÄÖÊ∏ÖÁ©∫Ôºü
                                                                    // Âª∫ËÆÆÔºöÁßªÈô§ÁõÆÊ†áÊó∂Ê∏ÖÁ©∫Êó•ÊúüÔºå‰∏ãÊ¨°ËÆæÊó∂ÈáçÊñ∞ÂºÄÂßã
                                                                    const startDate = (a.dailyGoal > 0 && a.goalStartDate) ? a.goalStartDate : todayStr;
                                                                    const finalDate = val > 0 ? startDate : null;

                                                                    return { ...a, dailyGoal: val, goalStartDate: finalDate };
                                                                }
                                                                return a;
                                                            }));
                                                            
                                                            setNewDailyData({ activityId: '', targetMinutes: '' });
                                                            showMsg(val > 0 ? "Goal Set!" : "Goal Removed");
                                                        }}
                                                        className="bg-black text-white px-3 py-1.5 text-[10px] font-bold pixel-border active:scale-95 flex-shrink-0"
                                                    >
                                                        SET
                                                    </button>
                                                </div>

                                                {/* List Active Daily Goals */}
                                                <div className="bg-[#E0F2F1] pixel-border p-3 space-y-2 max-h-40 overflow-y-auto no-scrollbar">
                                                    {activities.filter(a => a.dailyGoal > 0).length === 0 ? (
                                                        <p className="text-center text-[10px] opacity-40 font-bold">No daily goals set.</p>
                                                    ) : (
                                                        activities.filter(a => a.dailyGoal > 0).map(act => {
                                                            const current = getTodayProgress(act);
                                                            const goal = act.dailyGoal;
                                                            const pct = Math.min(100, (current / goal) * 100);
                                                            
                                                            const isPaused = dailyPauses.some(p => p.activityId === act.id && p.date === new Date().toISOString().split('T')[0]);

                                                            // Âà§ÂÆöÈÄªËæë - ËßÜËßâÁøªËΩ¨
                                                            const isNegative = act.nature === 'negative';
                                                            const isDone = isNegative ? current <= goal : current >= goal; 
                                                            
                                                            // È¢úËâ≤ÈÄªËæë
                                                            let barColor = '#FFD60A';
                                                            let checkColor = 'text-green-600';
                                                            
                                                            if (isPaused) {
                                                                barColor = '#D1D5DB'; // Gray 300
                                                                checkColor = 'text-gray-400';
                                                            } else if (isNegative) {
                                                                if (current > goal) {
                                                                    barColor = 'var(--p-red)'; // Ë∂ÖÊ†áÂèòÁ∫¢
                                                                    checkColor = 'text-red-600'; // Â§±Ë¥•È¢úËâ≤
                                                                } else {
                                                                    barColor = 'var(--p-green)'; // ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖÁªøËâ≤
                                                                }
                                                            } else {
                                                                if (isDone) barColor = 'var(--p-green)';
                                                            }

                                                            return (
                                                                <div key={act.id} className="relative">
                                                                        <div className="flex justify-between items-center mb-1 text-[10px] font-bold relative z-10">
                                                                            <div className="flex items-center gap-1">
                                                                                <span>{act.emoji}</span>
                                                                                <span>{act.name}</span>
                                                                                {isPaused && <span className="text-[8px] bg-gray-200 px-1 rounded opacity-60">PAUSED</span>}
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <button 
                                                                                    onClick={(e) => { e.stopPropagation(); togglePause(act.id, new Date().toISOString().split('T')[0]); }} 
                                                                                    className={`w-4 h-4 flex items-center justify-center rounded border border-gray-300 ${isPaused ? 'bg-blue-100 text-blue-500' : 'bg-white text-gray-300 hover:text-blue-400'}`}
                                                                                    title={isPaused ? "Unfreeze" : "Freeze/Pause"}
                                                                                >
                                                                                    {PIXEL_ICONS.snow}
                                                                                </button>
                                                                                <span className={`${checkColor} opacity-80`}>{Math.round((current / goal) * 100)}%</span>
                                                                                <span className="opacity-50 text-[9px]">|</span>
                                                                                <span>{current}/{goal}m</span>
                                                                                {/* ‰ªÖÂΩì‚ÄúËµ¢‚Äù‰∫ÜÊâçÊòæÁ§∫Â∫ÜÁ•ùÁ¨¶Âè∑, ÊöÇÂÅú‰∏çÊòæÁ§∫ */}
                                                                                {(!isPaused && (isNegative ? (current <= goal) : (current >= goal))) && <span className="text-sm leading-none">‚úÖ</span>}
                                                                            </div>
                                                                        </div>
                                                                        <div className="w-full h-1.5 bg-white border border-black relative">
                                                                            <div className="h-full transition-all duration-300" style={{width: `${pct}%`, backgroundColor: barColor}}></div>
                                                                        </div>
                                                                        <button 
                                                                            onClick={() => {
                                                                                setNewDailyData({ activityId: act.id, targetMinutes: act.dailyGoal });
                                                                            }}
                                                                            className="absolute inset-0 opacity-0 hover:opacity-10 bg-black transition-opacity cursor-pointer"
                                                                            title="Edit"
                                                                        ></button>
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            </div>

                                            {/* 2. Custom Challenges */}
                                            <div className="relative z-0">
                                                <h3 className="text-sm font-black mb-2 uppercase opacity-60">CUSTOM CHALLENGES</h3>
                                                
                                                {/* Create New Challenge - Flex Layout Fixed */}
                                                <div className="bg-gray-100 pixel-border p-3 mb-3 hide-in-capture flex flex-col gap-2">
                                                    <select 
                                                        className="w-full pixel-border p-2 font-bold text-xs bg-white outline-none"
                                                        value={newGoalData.activityId}
                                                        onChange={e => setNewGoalData({...newGoalData, activityId: e.target.value})}
                                                    >
                                                        <option value="">Select Target...</option>
                                                        {getHierarchicalActivities().map(a => (
                                                            <option key={a.id} value={a.id}>
                                                                {'\u00A0\u00A0'.repeat(a.level)}{a.emoji} {a.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    
                                                    <div className="flex gap-2">
                                                        <input 
                                                            type="date" 
                                                            className="flex-1 pixel-border p-1 text-xs font-bold appearance-none bg-white min-w-0" 
                                                            value={newGoalData.startDate} 
                                                            onChange={e => setNewGoalData({...newGoalData, startDate: e.target.value})} 
                                                        />
                                                        <input 
                                                            type="date" 
                                                            className="flex-1 pixel-border p-1 text-xs font-bold appearance-none bg-white min-w-0" 
                                                            value={newGoalData.endDate} 
                                                            onChange={e => setNewGoalData({...newGoalData, endDate: e.target.value})} 
                                                        />
                                                    </div>

                                                    <div className="flex gap-2">
                                                        <div className="flex-1 flex items-center bg-white pixel-border px-2 min-w-0">
                                                            <input 
                                                                type="number" 
                                                                placeholder="Total" 
                                                                className="flex-1 p-2 text-xs font-bold outline-none min-w-0" 
                                                                value={newGoalData.targetMinutes} 
                                                                onChange={e => setNewGoalData({...newGoalData, targetMinutes: e.target.value})} 
                                                            />
                                                            <span className="text-xs font-bold opacity-50 flex-shrink-0 ml-1">Min</span>
                                                        </div>
                                                        <button 
                                                            onClick={() => setNewGoalData({...newGoalData, isNegativeOverride: !newGoalData.isNegativeOverride})}
                                                            className={`flex-shrink-0 px-2 text-[10px] font-bold border-2 border-black flex items-center ${newGoalData.isNegativeOverride ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}
                                                        >
                                                            {newGoalData.isNegativeOverride ? 'LIMIT üö´' : 'REACH üéØ'}
                                                        </button>
                                                    </div>

                                                    <button 
                                                        onClick={() => {
                                                            if (newGoalData.activityId && newGoalData.startDate && newGoalData.endDate && newGoalData.targetMinutes > 0) {
                                                                setCustomGoals(prev => [...prev, { id: Math.random().toString(36).substr(2, 9), ...newGoalData, targetMinutes: parseInt(newGoalData.targetMinutes) }]);
                                                                
                                                                const today = new Date().toISOString().split('T')[0];
                                                                setNewGoalData({ activityId: '', startDate: today, endDate: today, targetMinutes: '', isNegativeOverride: false });
                                                                
                                                                showMsg("CHALLENGE ACCEPTED!");
                                                            }
                                                        }}
                                                        className="w-full bg-black text-white font-bold text-xs py-2 pixel-border active:scale-95 transition-transform"
                                                    >
                                                        + NEW CHALLENGE
                                                    </button>
                                                </div>

                                                {/* List Active Challenges */}
                                                <div className="space-y-3">
                                                    {customGoals.filter(g => isChallengeActive(g.endDate)).map(g => {
                                                        const act = activities.find(a => a.id === g.activityId);
                                                        if (!act) return null;
                                                        
                                                        const progress = getRangeProgress(g.activityId, g.startDate, g.endDate);
                                                        const pct = Math.min(100, (progress / g.targetMinutes) * 100);
                                                        
                                                        // Ëá™ÂÆö‰πâÊåëÊàòÂà§ÂÆöÈÄªËæëÔºö‰ºòÂÖà‰ΩøÁî® Override
                                                        const isNegative = g.isNegativeOverride;
                                                        const isDone = isNegative ? progress <= g.targetMinutes : progress >= g.targetMinutes;
                                                        
                                                        const start = new Date(g.startDate);
                                                        const end = new Date(g.endDate);
                                                        const daysTotal = Math.max(1, Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1);
                                                        const dailyAvg = Math.ceil(g.targetMinutes / daysTotal);

                                                        const status = getChallengeStatus(g.startDate, g.endDate);

                                                        // È¢úËâ≤ÈÄªËæë
                                                        let barColor = isDone ? 'var(--p-green)' : '#6D83F2';
                                                        if (isNegative && !isDone) barColor = 'var(--p-red)'; // Ë¥üÂêë‰∏îÂ§±Ë¥•ÂèòÁ∫¢

                                                        return (
                                                            <div key={g.id} className={`pixel-border p-3 relative group transition-all ${status === 'upcoming' ? 'bg-gray-50 border-dashed border-gray-400' : 'bg-white shadow-[2px_2px_0px_0px_rgba(0,0,0,0.1)]'}`}>
                                                                <button 
                                                                    onClick={() => {
                                                                        if (challengeDeleteConfirmId === g.id) {
                                                                            setCustomGoals(prev => prev.filter(item => item.id !== g.id));
                                                                            setChallengeDeleteConfirmId(null);
                                                                        } else {
                                                                            setChallengeDeleteConfirmId(g.id);
                                                                            setTimeout(() => setChallengeDeleteConfirmId(null), 3000);
                                                                        }
                                                                    }}
                                                                    className={`absolute -top-1 -right-1 text-[8px] font-bold border border-black px-1.5 transition-all z-20 hide-in-capture ${challengeDeleteConfirmId === g.id ? 'bg-red-500 text-white opacity-100' : 'bg-white text-black opacity-0 group-hover:opacity-100'}`}
                                                                >
                                                                    {challengeDeleteConfirmId === g.id ? 'SURE?' : 'DEL'}
                                                                </button>
                                                                
                                                                <div className="flex justify-between items-start mb-2">
                                                                        <div>
                                                                            <div className="flex items-center gap-1.5">
                                                                                <span className={`text-sm ${status === 'upcoming' ? 'grayscale opacity-50' : ''}`}>{act.emoji}</span>
                                                                                <span className={`font-bold text-xs uppercase ${status === 'upcoming' ? 'text-gray-500' : ''}`}>{act.name}</span>
                                                                                
                                                                                {status === 'upcoming' && <span className="text-[8px] bg-gray-200 text-gray-500 px-1 py-0.5 rounded border border-gray-300">WAITING</span>}
                                                                                {status === 'active' && <span className="text-[8px] bg-blue-100 text-blue-600 px-1 py-0.5 rounded border border-blue-200">ACTIVE</span>}
                                                                                {/* ÊòæÁ§∫Ê®°ÂºèÊ†áËÆ∞ */}
                                                                                {isNegative ? <span className="text-[8px] text-red-500 border border-red-200 px-1 rounded">LIMIT</span> : <span className="text-[8px] text-green-600 border border-green-200 px-1 rounded">REACH</span>}
                                                                            </div>
                                                                            <p className="text-[9px] font-bold opacity-40">{g.startDate.slice(5)} ~ {g.endDate.slice(5)} ({daysTotal} Days)</p>
                                                                            <p className="text-[9px] font-bold text-blue-600 mt-0.5">Avg: {dailyAvg}m/day</p>
                                                                        </div>
                                                                        
                                                                        {status !== 'upcoming' && (
                                                                            <div className="text-right">
                                                                                    <div className="flex items-center justify-end gap-1">
                                                                                        <p className={`text-lg font-black leading-none ${isDone ? 'text-green-600' : (isNegative ? 'text-red-500' : 'text-blue-600')}`}>
                                                                                            {Math.round((progress/g.targetMinutes)*100)}%
                                                                                        </p>
                                                                                        {/* ‰ªÖÂú®ÁúüÊ≠£ËÉúÂà©Êó∂Â∫ÜÁ•ù */}
                                                                                        {((!isNegative && progress >= g.targetMinutes) || (isNegative && progress <= g.targetMinutes)) && <span className="text-lg animate-bounce">üéâ</span>}
                                                                                    </div>
                                                                                    <p className="text-[9px] font-bold opacity-60">{progress}/{g.targetMinutes}m</p>
                                                                            </div>
                                                                        )}
                                                                </div>
                                                                
                                                                {status !== 'upcoming' ? (
                                                                    <div className="w-full h-3 border-2 border-black bg-gray-100 relative">
                                                                            <div className="h-full transition-all duration-300" style={{width: `${pct}%`, backgroundColor: barColor}}></div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="w-full h-3 border-2 border-dashed border-gray-300 bg-transparent flex items-center justify-center">
                                                                            <span className="text-[8px] text-gray-400 font-bold">STARTS SOON</span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                    {customGoals.filter(g => isChallengeActive(g.endDate)).length === 0 && (
                                                        <p className="text-center text-[10px] opacity-40 font-bold py-4">No active custom challenges.</p>
                                                    )}
                                                </div>
                                            </div>
                                    </div>
                                )}

                                {/* REPORTS TAB */}
                                {goalTab === 'history' && (
                                    <div className="flex flex-col flex-1 min-h-0">
                                            <div className="bg-gray-100 pixel-border p-2 mb-3 grid grid-cols-2 gap-2">
                                                <div className="col-span-2 flex bg-white pixel-border">
                                                    <button onClick={() => setArchiveFilters({...archiveFilters, type: 'daily'})} className={`flex-1 text-[10px] font-bold py-1.5 ${archiveFilters.type === 'daily' ? 'bg-black text-white' : ''}`}>DAILY</button>
                                                    <button onClick={() => setArchiveFilters({...archiveFilters, type: 'custom'})} className={`flex-1 text-[10px] font-bold py-1.5 ${archiveFilters.type === 'custom' ? 'bg-black text-white' : ''}`}>CUSTOM</button>
                                                </div>
                                                <input type="date" className="pixel-border p-1 text-xs font-bold text-center appearance-none bg-white min-w-0" value={archiveFilters.startDate} onChange={e => setArchiveFilters({...archiveFilters, startDate: e.target.value})} />
                                                <input type="date" className="pixel-border p-1 text-xs font-bold text-center appearance-none bg-white min-w-0" value={archiveFilters.endDate} onChange={e => setArchiveFilters({...archiveFilters, endDate: e.target.value})} />
                                            </div>

                                            <div id="archive-capture-area" className="flex-1 overflow-y-auto no-scrollbar bg-white p-2 border-2 border-dashed border-gray-300">
                                                <div className="text-center mb-4 border-b-2 border-black pb-2">
                                                    <h3 className="text-xl font-black uppercase">QUEST REPORT</h3>
                                                    <p className="text-[10px] font-bold opacity-50">{archiveFilters.startDate} ~ {archiveFilters.endDate}</p>
                                                    
                                                    {(() => {
                                                        let totalGoals = 0;
                                                        let totalAchieved = 0;
                                                        
                                                        if (archiveFilters.type === 'custom') {
                                                            const validGoals = customGoals.filter(g => 
                                                                g.startDate <= archiveFilters.endDate && g.endDate >= archiveFilters.startDate
                                                            );
                                                            totalGoals = validGoals.length;
                                                            totalAchieved = validGoals.filter(g => {
                                                                const p = getRangeProgress(g.activityId, g.startDate, g.endDate);
                                                                // Êä•Ë°®ÁøªËΩ¨Âà§ÂÆö
                                                                const isNegative = g.isNegativeOverride;
                                                                return isNegative ? p <= g.targetMinutes : p >= g.targetMinutes;
                                                            }).length;
                                                        } else {
                                                            // Daily Mode Âà§ÂÆö: ÂøΩÁï•‰∏≠ÊÄßÊ¥ªÂä®
                                                            const dailyActs = activities.filter(a => a.dailyGoal > 0 && a.nature !== 'neutral');
                                                            totalGoals = dailyActs.length;
                                                            
                                                            // ËÆ°ÁÆóÊúâÊïàÁõÆÊ†áÊÄªÊï∞ÔºàÂâîÈô§ÊöÇÂÅúÊó•Ôºâ
                                                            totalAchieved = dailyActs.filter(a => {
                                                                const reportStart = new Date(archiveFilters.startDate);
                                                                const reportEnd = new Date(archiveFilters.endDate);
                                                                
                                                                // ‰øÆÂ§çÔºöÊó∂Èó¥ÊóÖË°åÈÄªËæë (Time Travel Logic)
                                                                // 1. Ëé∑ÂèñÁõÆÊ†áÁîüÊïàÊó• (ÈªòËÆ§ 1970 ÂÖºÂÆπÊóßÊï∞ÊçÆ)
                                                                const goalStart = a.goalStartDate ? new Date(a.goalStartDate) : new Date(0);
                                                                
                                                                // 2. Á°ÆÂÆöÊúâÊïàËÆ°ÁÆóËµ∑ÂßãÊó•ÔºöÂèñ (Êä•Ë°®ÂºÄÂßãÊó•, ÁõÆÊ†áÁîüÊïàÊó•) ÁöÑËæÉÊôöËÄÖ
                                                                // ÈÅøÂÖç‚ÄúÊú™Âá∫Áîü‚ÄùÁöÑÁõÆÊ†áË¢´ËøáÊó©ÁªüËÆ°
                                                                let calcStart = reportStart > goalStart ? reportStart : goalStart;
                                                                
                                                                // 3. ËæπÁïåÊ£ÄÊü•ÔºöÂ¶ÇÊûúËÆ°ÁÆóËµ∑ÂßãÊó•Êôö‰∫éÊä•Ë°®ÁªìÊùüÊó•ÔºåËØ¥ÊòéËØ•ÁõÆÊ†áÂú®Ê≠§ÊúüÈó¥‰∏çÂ≠òÂú®
                                                                if (calcStart > reportEnd) return false;

                                                                // 4. ÈáçÁΩÆÊó∂Èó¥ÈÉ®ÂàÜÔºåÁ°Æ‰øùÊó•ÊúüËø≠‰ª£ÂáÜÁ°Æ
                                                                calcStart.setHours(0,0,0,0);
                                                                reportEnd.setHours(23,59,59,999);

                                                                let effectiveDays = 0;
                                                                
                                                                // Âæ™ÁéØËÆ°ÁÆóÊØè‰∏ÄÂ§©ÊòØÂê¶ÊöÇÂÅú
                                                                for (let d = new Date(calcStart); d <= reportEnd; d.setDate(d.getDate() + 1)) {
                                                                    const dateStr = d.toISOString().split('T')[0];
                                                                    const isPaused = dailyPauses.some(p => p.activityId === a.id && p.date === dateStr);
                                                                    if (!isPaused) effectiveDays++;
                                                                }
                                                                
                                                                if (effectiveDays === 0) return false; // Êó†ÊúâÊïàÂ§©Êï∞ÔºàÂÖ®Á®ãÊöÇÂÅúÊàñÊú™ÁîüÊïàÔºâ

                                                                const targetTotal = a.dailyGoal * effectiveDays;
                                                                
                                                                // ‰øÆÂ§çÔºöËøõÂ∫¶ÁªüËÆ°ÂøÖÈ°ª‰ΩøÁî® calcStartÔºåÈò≤Ê≠¢‚ÄúÂéÜÂè≤Êï∞ÊçÆÂÅ∑Ë∑ë‚Äù
                                                                const calcStartStr = calcStart.toISOString().split('T')[0];
                                                                const progress = getRangeProgress(a.id, calcStartStr, archiveFilters.endDate);
                                                                
                                                                // Daily Report ÁøªËΩ¨
                                                                return a.nature === 'negative' ? progress <= targetTotal : progress >= targetTotal;
                                                            }).length;
                                                        }
                                                        
                                                        const rate = totalGoals > 0 ? Math.round((totalAchieved / totalGoals) * 100) : 0;
                                                        const isPerfect = rate >= 100;
                                                        
                                                        return (
                                                            <div className={`mt-2 py-1 px-2 inline-block pixel-border transform -rotate-2 ${isPerfect ? 'bg-[#4CD964] text-white' : 'bg-[#FFE4B5] text-black'}`}>
                                                                <span className="text-[10px] font-bold mr-2">OVERALL RATE</span>
                                                                <span className="text-lg font-black">{rate}%</span>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>

                                                <div className="space-y-2">
                                                    {archiveFilters.type === 'custom' ? (
                                                        customGoals.filter(g => g.startDate <= archiveFilters.endDate && g.endDate >= archiveFilters.startDate).length === 0 ? (
                                                            <p className="text-center text-[10px] opacity-30 py-4 font-bold">No records in this period.</p>
                                                        ) : (
                                                            customGoals.filter(g => g.startDate <= archiveFilters.endDate && g.endDate >= archiveFilters.startDate)
                                                            .sort((a,b) => new Date(b.endDate) - new Date(a.endDate))
                                                            .map(g => {
                                                                const act = activities.find(a => a.id === g.activityId);
                                                                if (!act) return null;
                                                                const progress = getRangeProgress(g.activityId, g.startDate, g.endDate);
                                                                const status = getChallengeStatus(g.startDate, g.endDate);
                                                                
                                                                // Êä•Ë°®ÁøªËΩ¨ÈÄªËæë
                                                                const isNegative = g.isNegativeOverride;
                                                                const success = isNegative ? progress <= g.targetMinutes : progress >= g.targetMinutes;

                                                                let bgClass = 'bg-gray-50';
                                                                let statusText = 'FAILED';
                                                                let statusColor = 'text-red-500';

                                                                if (status === 'upcoming') {
                                                                    bgClass = 'bg-gray-50 border-dashed opacity-70';
                                                                    statusText = 'WAITING';
                                                                    statusColor = 'text-gray-400';
                                                                } else if (status === 'active') {
                                                                    bgClass = 'bg-white border-dashed';
                                                                    statusText = 'ONGOING';
                                                                    statusColor = 'text-blue-600';
                                                                } else {
                                                                    statusText = success ? 'SUCCESS' : 'FAILED';
                                                                    statusColor = success ? 'text-green-600' : 'text-red-500';
                                                                }

                                                                return (
                                                                    <div key={g.id} className={`pixel-border p-2 flex justify-between items-center ${bgClass}`}>
                                                                        <div>
                                                                            <div className="flex items-center gap-1">
                                                                                <span>{act.emoji}</span>
                                                                                <span className="text-xs font-bold uppercase">{act.name}</span>
                                                                                {isNegative && <span className="text-[8px] bg-red-100 text-red-500 px-1 rounded">LIMIT</span>}
                                                                            </div>
                                                                            <div className="text-[9px] font-bold opacity-50 flex gap-2">
                                                                                <span>{g.startDate.slice(5)}~{g.endDate.slice(5)}</span>
                                                                                {status !== 'upcoming' && <span>{progress}/{g.targetMinutes}m</span>}
                                                                            </div>
                                                                        </div>
                                                                        <div className={`text-xs font-black ${statusColor}`}>
                                                                            {statusText}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })
                                                        )
                                                    ) : (
                                                        // Daily Goals List (Calculated with Pause Logic)
                                                        activities.filter(a => a.dailyGoal > 0).map(act => {
                                                            const reportStart = new Date(archiveFilters.startDate);
                                                            const reportEnd = new Date(archiveFilters.endDate);
                                                            
                                                            // Ê†∏ÂøÉ‰øÆÂ§çÔºöÂ∫îÁî®Êó∂Èó¥ÊóÖË°åÈÄªËæë
                                                            // 1. Ëé∑ÂèñÁõÆÊ†áÁîüÊïàÊó• (ÈªòËÆ§ 1970 ÂÖºÂÆπÊóßÊï∞ÊçÆ)
                                                            const goalStart = act.goalStartDate ? new Date(act.goalStartDate) : new Date(0);
                                                            
                                                            // 2. Á°ÆÂÆöÊúâÊïàËÆ°ÁÆóËµ∑ÂßãÊó•ÔºöÂèñ (Êä•Ë°®ÂºÄÂßãÊó•, ÁõÆÊ†áÁîüÊïàÊó•) ÁöÑËæÉÊôöËÄÖ
                                                            // ÈÅøÂÖç‚ÄúÊú™Âá∫Áîü‚ÄùÁöÑÁõÆÊ†áË¢´ËøáÊó©ÁªüËÆ°
                                                            let calcStart = reportStart > goalStart ? reportStart : goalStart;
                                                            
                                                            // 3. ËæπÁïåÊ£ÄÊü•ÔºöÂ¶ÇÊûúËÆ°ÁÆóËµ∑ÂßãÊó•Êôö‰∫éÊä•Ë°®ÁªìÊùüÊó•ÔºåËØ¥ÊòéËØ•ÁõÆÊ†áÂú®Ê≠§ÊúüÈó¥‰∏çÂ≠òÂú®
                                                            if (calcStart > reportEnd) return null;

                                                            // 4. ÈáçÁΩÆÊó∂Èó¥ÈÉ®ÂàÜÔºåÁ°Æ‰øùÊó•ÊúüËø≠‰ª£ÂáÜÁ°Æ
                                                            calcStart.setHours(0,0,0,0);
                                                            reportEnd.setHours(23,59,59,999);

                                                            let effectiveDays = 0;
                                                            
                                                            // Âæ™ÁéØËÆ°ÁÆóÊØè‰∏ÄÂ§©ÊòØÂê¶ÊöÇÂÅú
                                                            for (let d = new Date(calcStart); d <= reportEnd; d.setDate(d.getDate() + 1)) {
                                                                const dateStr = d.toISOString().split('T')[0];
                                                                const isPaused = dailyPauses.some(p => p.activityId === act.id && p.date === dateStr);
                                                                if (!isPaused) effectiveDays++;
                                                            }

                                                            const targetTotal = act.dailyGoal * effectiveDays;
                                                            
                                                            // ‰øÆÂ§çÔºöËøõÂ∫¶ÁªüËÆ°ÂøÖÈ°ª‰ΩøÁî® calcStartÔºåÈò≤Ê≠¢‚ÄúÂéÜÂè≤Êï∞ÊçÆÂÅ∑Ë∑ë‚Äù
                                                            // ‰πãÂâçÈîôËØØÂÜôÊ≥ïÔºöarchiveFilters.startDateÔºåÂØºËá¥ÁªüËÆ°‰∫ÜÁõÆÊ†áÁîüÊïàÂâçÁöÑÂéÜÂè≤Êï∞ÊçÆ
                                                            const calcStartStr = calcStart.toISOString().split('T')[0];
                                                            const progress = getRangeProgress(act.id, calcStartStr, archiveFilters.endDate);
                                                            
                                                            // Daily Report ÁøªËΩ¨
                                                            let success = false;
                                                            let typeLabel = '';
                                                            let statusText = '';
                                                            
                                                            if (effectiveDays === 0) {
                                                                statusText = 'PAUSED';
                                                            } else {
                                                                if (act.nature === 'negative') {
                                                                    success = progress <= targetTotal;
                                                                    typeLabel = '(LIMIT)';
                                                                } else {
                                                                    // Positive & Neutral logic: >= target
                                                                    success = progress >= targetTotal;
                                                                }

                                                                if (act.nature === 'neutral') {
                                                                    statusText = success ? 'DONE' : 'MISS';
                                                                } else {
                                                                    statusText = success ? 'WIN' : 'LOSE';
                                                                }
                                                            }
                                                            
                                                            let statusColor = 'text-gray-400';
                                                            if (effectiveDays > 0) {
                                                                if (act.nature === 'neutral') {
                                                                    statusColor = success ? 'text-blue-600' : 'text-gray-400';
                                                                } else {
                                                                    statusColor = success ? 'text-green-600' : 'text-red-500';
                                                                }
                                                            }

                                                            return (
                                                                <div key={act.id} className="bg-gray-50 pixel-border p-2 flex justify-between items-center">
                                                                    <div>
                                                                        <div className="flex items-center gap-1">
                                                                            <span>{act.emoji}</span>
                                                                            <span className="text-xs font-bold uppercase">{act.name}</span>
                                                                            <span className="text-[8px] opacity-50">{typeLabel}</span>
                                                                        </div>
                                                                        <div className="text-[9px] font-bold opacity-50">Total: {progress}/{targetTotal}m ({effectiveDays} days)</div>
                                                                    </div>
                                                                    <div className={`text-xs font-black ${statusColor}`}>
                                                                        {statusText}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    {(showAddModal || showEditModal) && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md text-left">
                            <div className="bg-white pixel-border p-6 w-full max-w-sm shadow-[10px_10px_0px_0px_black]">
                                <h2 className="text-3xl font-black mb-6 uppercase border-b-4 border-black">{showEditModal ? 'Edit' : 'New'}</h2>
                                <div className="space-y-5 max-h-[50vh] overflow-y-auto no-scrollbar pr-1">
                                    <input 
                                        type="text" 
                                        placeholder="Name..." 
                                        className="w-full pixel-border p-4 font-bold text-xl outline-none focus:bg-yellow-50" 
                                        value={formData.name} 
                                        onChange={e => setFormData({...formData, name: e.target.value})} 
                                    />
                                    
                                    {/* Ê†∏ÂøÉÊîπÂä®ÔºöÂ¢ûÂä† Nature ÈÄâÊã©Âô® */}
                                    <div className="pixel-border p-3 bg-gray-50">
                                        <label className="text-[10px] font-bold uppercase text-gray-400 mb-2 block">Nature</label>
                                        <div className="flex gap-2">
                                            <button onClick={() => setFormData({...formData, nature: 'positive'})} className={`flex-1 py-2 text-xs font-bold border-2 ${formData.nature === 'positive' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-white border-transparent'}`}>üéØ POS</button>
                                            <button onClick={() => setFormData({...formData, nature: 'neutral'})} className={`flex-1 py-2 text-xs font-bold border-2 ${formData.nature === 'neutral' ? 'bg-gray-200 border-gray-500 text-gray-700' : 'bg-white border-transparent'}`}>‚ö™ NEU</button>
                                            <button onClick={() => setFormData({...formData, nature: 'negative'})} className={`flex-1 py-2 text-xs font-bold border-2 ${formData.nature === 'negative' ? 'bg-red-100 border-red-500 text-red-700' : 'bg-white border-transparent'}`}>üö´ NEG</button>
                                        </div>
                                    </div>

                                    {/* ÁºñËæëÂºπÁ™ó‰∏≠‰øùÁïô Goal ËæìÂÖ• */}
                                    <div className="flex items-center gap-3 bg-gray-50 p-2 pixel-border">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold uppercase text-gray-400 mb-1 block">Daily Goal (Mins)</label>
                                            <div className="flex items-center gap-2">
                                                <input 
                                                    type="number" 
                                                    placeholder="0 = No Goal" 
                                                    className="w-full pixel-border p-2 font-bold text-lg outline-none text-center bg-white focus:bg-yellow-50" 
                                                    value={formData.dailyGoal} 
                                                    onChange={e => setFormData({...formData, dailyGoal: parseInt(e.target.value) || 0})} 
                                                />
                                                <span className="text-xs font-bold">MIN</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="pixel-border p-4 bg-gray-50">
                                        <div className="grid grid-cols-5 gap-3 h-28 overflow-y-auto pr-1 no-scrollbar text-3xl text-center">
                                            {COMMON_EMOJIS.map(e => <button key={e} onClick={() => setFormData({...formData, emoji: e})} className={`p-1 border-2 transition-all ${formData.emoji === e ? 'border-black bg-yellow-100 shadow-[3px_3px_0px_0px_black]' : 'border-transparent'}`}>{e}</button>)}
                                        </div>
                                    </div>
                                    <select className="w-full pixel-border p-4 font-bold bg-white text-lg outline-none" value={formData.parentId} onChange={e => setFormData({...formData, parentId: e.target.value})}>
                                        <option value="">Top Category</option>
                                        {activities.filter(a => !a.parentId && a.id !== activeEditId).map(a => <option key={a.id} value={a.id}>Under: {a.name}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-4 mt-8">
                                    <button onClick={() => {setShowAddModal(false); setShowEditModal(false);}} className="flex-1 pixel-border p-4 font-black uppercase text-xs text-center">Abort</button>
                                    <button onClick={() => {
                                        if(!formData.name) return;
                                        const todayStr = new Date().toISOString().split('T')[0];

                                        if(showEditModal) {
                                            const oldActivity = activities.find(a => a.id === activeEditId);
                                            // ‰øùÂ≠ò 
                                            setActivities(prev => prev.map(a => {
                                                if (a.id === activeEditId) {
                                                    // ‰øÆÂ§çÔºöÂêåÊ≠• Data Stamping ÈÄªËæë
                                                    // 1. Â¶ÇÊûúÊñ∞ÁõÆÊ†á > 0
                                                    // 2. Ê£ÄÊü•ÊóßÂØπË±°ÊòØÂê¶ÊúâÊúâÊïàÁõÆÊ†áÂíåÊó•ÊúüÔºåÊúâÂàô‰øùÁïôÔºàËßÜ‰∏∫‰øÆÊîπÊï∞ÂÄºÔºâÔºåÊó†ÂàôÁî®‰ªäÂ§©ÔºàËßÜ‰∏∫Êñ∞ÂºÄÂêØÔºâ
                                                    // 3. Â¶ÇÊûúÊñ∞ÁõÆÊ†á <= 0ÔºåÊ∏ÖÁ©∫Êó•Êúü
                                                    const startDate = (a.dailyGoal > 0 && a.goalStartDate) ? a.goalStartDate : todayStr;
                                                    const finalDate = formData.dailyGoal > 0 ? startDate : null;
                                                    
                                                    return { ...a, ...formData, goalStartDate: finalDate };
                                                }
                                                return a;
                                            }));
                                            
                                            // Á∫ßËÅîÂêåÊ≠•ÂºïÊìé
                                            if (oldActivity) {
                                                setLogs(prevLogs => prevLogs.map(log => {
                                                    if (log.activityName === oldActivity.name) {
                                                        return {
                                                            ...log,
                                                            activityName: formData.name,
                                                            activityEmoji: formData.emoji
                                                        };
                                                    }
                                                    return log;
                                                }));
                                            }
                                        }
                                        else {
                                            // Êñ∞Âª∫Ê¥ªÂä®ÈÄªËæëÂêåÊ≠•
                                            const finalDate = formData.dailyGoal > 0 ? todayStr : null;
                                            setActivities([...activities, { 
                                                id: Math.random().toString(36).substr(2, 9), 
                                                ...formData,
                                                goalStartDate: finalDate
                                            }]);
                                        }
                                        setShowAddModal(false); setShowEditModal(false);
                                        triggerVibrate(30);
                                    }} className="flex-1 bg-black text-white p-4 font-black uppercase text-xs text-center">Save</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
